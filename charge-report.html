<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shift Control Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <div class="p-4">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-400">Shift Control Panel</h1>

    <!-- Tabs -->
    <div class="flex justify-center space-x-4 mb-6">
      <button onclick="showTab('questions')" class="btn-tab">Manage Questions</button>
      <button onclick="showTab('log')" class="btn-tab">Fill Shift Log</button>
      <button onclick="showTab('view')" class="btn-tab">View Logs</button>
    <button onclick="loadLogs()" class="btn-tab">🔄 Refresh</button>
    </div>

    <!-- Tabs Content -->
    <div id="questions" class="tab hidden">
      <h2 class="text-xl font-semibold mb-2">Manage Questions</h2>
      <div id="questionList"></div>
      <input id="newQuestion" class="input w-full mt-4" placeholder="Enter question text">
      <button onclick="addQuestion()" class="btn btn-blue mt-2">Add Question</button>
    </div>

    <div id="log" class="tab hidden">
      <h2 class="text-xl font-semibold mb-2">Fill Shift Log</h2>
      <input type="date" id="shiftDate" class="input w-full mt-2">
      <select id="shiftType" class="input w-full mt-2">
        <option value="Day">Day</option>
        <option value="Night">Night</option>
      </select>
      <form id="shiftForm" class="mt-4 space-y-4"></form>
      <button onclick="submitShiftLog()" class="btn btn-green mt-4">Submit</button>
    </div>

    <div id="view" class="tab hidden">
  <h2 class="text-xl font-semibold mb-2">View Logs</h2>

  <!-- 🔍 Filters -->
  <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-2">
    <input type="date" id="filterDate" class="input" />
    <select id="filterShift" class="input">
      <option value="Both">Both</option>
      <option value="Day">Day</option>
      <option value="Night">Night</option>
    </select>
    <button onclick="loadLogs()" class="btn btn-blue">Apply Filter</button>
  </div>

  <div id="logsList" class="space-y-4"></div>
</div>

  </div>

  <style>
    .tab { display: none; }
    .btn-tab { background: #1e3a8a; padding: 0.5rem 1rem; border-radius: 8px; }
    .btn-blue { background: #2563eb; padding: 0.5rem 1rem; border-radius: 8px; }
    .btn-green { background: #059669; padding: 0.5rem 1rem; border-radius: 8px; }
    .input { padding: 0.5rem; border-radius: 8px; color: black; }
  </style>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCByQute9IKG_2nvSFWcAThgEH7PKIhMDw",
    authDomain: "ctwo-eee79.firebaseapp.com",
    projectId: "ctwo-eee79",
    storageBucket: "ctwo-eee79.appspot.com",
    messagingSenderId: "788657051205",
    appId: "1:788657051205:web:5d4b6884a0ca09e4cb352c",
    measurementId: "G-4VTCQR4ZVR"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUID = null;
    let isAdmin = false;

 auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUID = user.uid;
    isAdmin = currentUID === 'VEPPHo0YHvcIGA0hsqxBmAAkDRK2';

    // 🔥 أضف هذا الجزء لحفظ الاسم في متغير
    if (!user.displayName) {
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists) {
        user.displayName = userDoc.data().name; // ← لو عندك اسم محفوظ في Collection users
      }
    }

    if (!isAdmin) document.getElementById('questions').remove();
    loadQuestions();
    loadLogs();
  } else {
    alert("Please log in.");
  }
});


  function showTab(tabId) {
  document.querySelectorAll('.tab').forEach(el => el.style.display = 'none');
  const target = document.getElementById(tabId);
  if (target) {
    target.style.display = 'block';
  } else {
    console.warn(`Tab "${tabId}" not found in DOM`);
  }
}


async function loadQuestions() {
  const qSnap = await db.collection("shiftQuestions").orderBy("order").get();
  
  if (isAdmin) {
    const list = document.getElementById("questionList");
    if (list) {
      list.innerHTML = "";
      qSnap.forEach(doc => {
        const q = doc.data();
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-4 rounded mt-2 flex justify-between items-center";
        div.innerHTML = `
          <div>
            <div class="italic">*\`${q.question}\`*</div>
          </div>
          <label class="flex items-center space-x-2">
            <span>Active</span>
            <input type="checkbox" ${q.isActive ? "checked" : ""} onchange="toggleActive('${doc.id}', this.checked)" />
          </label>
        `;
        list.appendChild(div);
      });
    }
  }

  // هذا الجزء يسمح بعرض نموذج الأسئلة في تبويب "Fill Shift Log"
  renderForm(qSnap.docs.filter(doc => doc.data().isActive));
}

    async function toggleActive(id, status) {
      await db.collection("shiftQuestions").doc(id).update({ isActive: status });
      loadQuestions();
    }

  async function addQuestion() {
  const question = document.getElementById("newQuestion").value;
  if (question.trim()) {
    await db.collection("shiftQuestions").add({
      question,
      isActive: true,
      order: Date.now(),
      createdBy: currentUID,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("newQuestion").value = "";
    loadQuestions();
  }
}


function renderForm(activeQuestions) {
  const form = document.getElementById("shiftForm");
  form.innerHTML = "";

  activeQuestions.forEach((doc) => {
    const q = doc.data();
    const docId = doc.id;

    const questionId = `q_${docId}`;
    const commentId = `c_${docId}`;
    const toggleCommentId = `btn_${docId}`;

    const div = document.createElement("div");
    div.className = "mb-4";

    div.innerHTML = `
      <label class="block italic text-blue-300">*\`${q.question}\`*</label>
      <div class="flex items-center space-x-2">
        <select id="${questionId}" class="input" onchange="toggleCommentButton('${questionId}', '${toggleCommentId}', '${commentId}')">
          <option value="No">No</option>
          <option value="Yes">Yes</option>
        </select>
        <button type="button" id="${toggleCommentId}" class="btn-tab hidden" onclick="toggleComment('${commentId}')">💬 Comment</button>
      </div>
      <textarea id="${commentId}" class="input w-full mt-2 hidden" placeholder="Enter comment here..."></textarea>
    `;

    form.appendChild(div);
  });
}


function toggleCommentButton(selectId, btnId, commentId) {
  const select = document.getElementById(selectId);
  const btn = document.getElementById(btnId);
  const comment = document.getElementById(commentId);

  if (select && btn && comment) {
    btn.classList.remove("hidden");
  }
}

function toggleComment(commentId) {
  const comment = document.getElementById(commentId);
  if (comment) {
    comment.classList.toggle("hidden");
  }
}

async function submitShiftLog() {
  const date = document.getElementById("shiftDate").value;
  const shift = document.getElementById("shiftType").value;
  const qSnap = await db.collection("shiftQuestions").where("isActive", "==", true).get();

  const answers = {};

  qSnap.docs.forEach((doc) => {
    const qText = doc.data().question;
    const docId = doc.id;
    const answer = document.getElementById(`q_${docId}`).value;
    const comment = document.getElementById(`c_${docId}`).value || "";
    answers[qText] = { answer, comment };
  });

  // جلب اسم المستخدم
  let userName = "Unknown";
  const userDoc = await db.collection("users").doc(currentUID).get();
  if (userDoc.exists) {
    userName = userDoc.data().name || "Unknown";
  }

  await db.collection("shiftLogs").add({
    date,
    shift,
    uid: currentUID,
    userName,
    answers,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Shift log submitted ✅");
}


  async function loadLogs() {
  const logsList = document.getElementById("logsList");
  logsList.innerHTML = "";

  const selectedDate = document.getElementById("filterDate").value;
  const selectedShift = document.getElementById("filterShift").value;

  let query = db.collection("shiftLogs").orderBy("timestamp", "desc");

  // في حالة وجود فلتر تاريخ
  if (selectedDate) {
    query = query.where("date", "==", selectedDate);
  }

  const logs = await query.limit(100).get();

  logs.forEach(doc => {
    const data = doc.data();

    // فلترة نوع الشيفت إذا لم يكن Both
    if (selectedShift !== "Both" && data.shift !== selectedShift) return;

    const div = document.createElement("div");
    div.className = "bg-gray-800 p-4 rounded";
    div.innerHTML = `
      <div class="font-bold">${data.date} (${data.shift})</div>
      <div class="text-sm text-gray-400 mb-2">👤 By: ${data.userName || "Unknown"}</div>
    `;

    Object.entries(data.answers).forEach(([q, val]) => {
      div.innerHTML += `<div><span class="text-blue-300">*\`${q}\`*</span> → <strong>${val.answer}</strong></div>`;
      if (val.comment) {
        div.innerHTML += `<div class="text-sm text-gray-400 ml-4">📝 ${val.comment}</div>`;
      }
    });

    logsList.appendChild(div);
  });
}

  </script>
</body>
</html>
