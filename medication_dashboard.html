<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medication Log Report</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
  <h1 class="text-2xl font-bold mb-4">üìã Medication Check Log</h1>

  <div class="flex flex-col sm:flex-row gap-4 mb-6">
    <div>
      <label>Start Date</label>
      <input type="date" id="startDate" class="input input-bordered" />
    </div>
    <div>
      <label>End Date</label>
      <input type="date" id="endDate" class="input input-bordered" />
    </div>
    <div class="self-end">
      <button onclick="loadLogs()" class="btn btn-primary mt-1">üîç Load</button>
    </div>
  </div>

  <div class="mb-4">
    <input id="searchInput" oninput="filterTable()" placeholder="Search medication..." class="input input-bordered w-full max-w-sm" />
  </div>

  <div class="overflow-x-auto">
    <table class="table w-full text-sm border border-gray-600">
      <thead class="bg-gray-700 text-gray-300 text-xs">
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>Location</th>
          <th>Quantity (Diff)</th>
          <th>Expiry</th>
          <th>Checked At</th>
        </tr>
      </thead>
      <tbody id="logTable" class="bg-gray-800"></tbody>
    </table>
  </div>

  <div id="summary" class="mt-8"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCByQute9IKG_2nvSFWcAThgEH7PKIhMDw",
      authDomain: "ctwo-eee79.firebaseapp.com",
      projectId: "ctwo-eee79"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let medicationsMap = {};
    const logTable = document.getElementById("logTable");

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await preloadMedications();
        loadLogs();
      } else {
        alert("Please login first.");
      }
    });

    async function preloadMedications() {
      const meds = await db.collection("medications").get();
      meds.forEach(doc => medicationsMap[doc.id] = doc.data());
    }

    async function loadLogs() {
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      if (isNaN(start) || isNaN(end)) {
        alert("Please choose valid dates.");
        return;
      }

      // Adjust end date to include full day
      end.setHours(23, 59, 59, 999);

      const snapshot = await db.collection("medication checklist log sheet")
        .where("checkedAt", ">=", firebase.firestore.Timestamp.fromDate(start))
        .where("checkedAt", "<=", firebase.firestore.Timestamp.fromDate(end))
        .orderBy("checkedAt", "asc")
        .get();

      const logs = snapshot.docs.map(doc => doc.data());
      renderTable(logs);
    }

    function renderTable(logs) {
      logTable.innerHTML = "";
      const summary = document.getElementById("summary");
      const grouped = {};
      const lastSeen = {};
      summary.innerHTML = `<h3 class="text-lg font-bold mb-2">üìä Summary by Medication</h3>`;

      logs.forEach(log => {
        const code = log.medicationCode;
        const name = medicationsMap[code]?.medicationName || log.medicationName;
        const expiry = medicationsMap[code]?.expiryDate || "N/A";
        const loc = log.location;
        const qty = log.quantity;
        const key = `${code}_${loc}`;

        const prevQty = lastSeen[key] ?? null;
        const diff = prevQty !== null ? qty - prevQty : "‚Äî";
        lastSeen[key] = qty;

        grouped[code] = grouped[code] || {};
        grouped[code][loc] = (grouped[code][loc] || 0) + qty;

        const expDate = new Date(expiry);
        const isNearExpiry = expiry !== "N/A" && (expDate - new Date() <= 1000 * 60 * 60 * 24 * 30);

        const diffColored = diff !== "‚Äî"
          ? `<span class="text-xs ml-1 ${diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-400'}">(${diff > 0 ? '+' : ''}${diff})</span>`
          : "";

        const tr = document.createElement("tr");
        tr.className = isNearExpiry ? "bg-red-800 text-white" : "border-b border-gray-700";
        tr.innerHTML = `
          <td>${code}</td>
          <td>${name}</td>
          <td>${loc}</td>
          <td>${qty} ${diffColored}</td>
          <td>${expiry}</td>
          <td>${log.checkedAt.toDate().toLocaleString()}</td>
        `;
        logTable.appendChild(tr);
      });

      Object.entries(grouped).forEach(([code, locs]) => {
        const name = medicationsMap[code]?.medicationName || code;
        const total = Object.values(locs).reduce((a, b) => a + b, 0);
        const dist = Object.entries(locs).map(([loc, val]) => `${loc}: ${val}`).join(" | ");
        summary.innerHTML += `
          <p class="text-sm mb-1"><strong>${name}</strong> (${code}) ‚Üí Total: 
          <span class="text-green-400">${total}</span> ‚Üí ${dist}</p>
        `;
      });
    }

    function filterTable() {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      const rows = logTable.getElementsByTagName("tr");
      for (let row of rows) {
        const code = row.cells[0]?.textContent.toLowerCase() || "";
        const name = row.cells[1]?.textContent.toLowerCase() || "";
        row.style.display = (code.includes(filter) || name.includes(filter)) ? "" : "none";
      }
    }
  </script>
</body>
</html>
