


<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²Ø© â€” ICU Analytics</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />

  <!-- Icons + Charts + CSV Parser + Day.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/minMax.js"></script>
<!-- Firebase SDKs (Compat Ø²ÙŠ Ù…Ø´Ø±ÙˆØ¹Ùƒ) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>


  <!-- Google Font (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>

    /* ØªØ«Ø¨ÙŠØª Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ (ÙŠØ¯Ø¹Ù… RTL Ùˆ LTR) */
.sticky-start {
  position: sticky;
  inset-inline-start: 0;         /* Ø¨Ø¯Ù„ left/right Ø¹Ù„Ø´Ø§Ù† ÙŠØ¯Ø¹Ù… RTL */
  z-index: 10;                   /* ÙÙˆÙ‚ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
  background: var(--glass);      /* Ù†ÙØ³ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù€ glass */
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-inline-end: 1px solid var(--glass-bd); /* ÙØ§ØµÙ„ Ù„Ø·ÙŠÙ */
}

/* Ø±Ø£Ø³ Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙŠØ­ØªØ§Ø¬ Z-index Ø£Ø¹Ù„Ù‰ Ø´ÙˆÙŠØ© */
.sticky-start.is-head {
  z-index: 15;
}

/* Ø¹Ø±Ø¶ Ù…Ø±ÙŠØ­ Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
.col-label {
  min-width: 9rem; /* â‰ˆ w-36/40 */
}


    :root {
      --glass: rgba(255,255,255,0.06);
      --glass-bd: rgba(255,255,255,0.15);
      --grad-1: #0f172a;
      --grad-2: #0b2b40;
    }
    body {
      font-family: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(14,165,233,0.15), transparent 60%),
        linear-gradient(135deg, var(--grad-1), var(--grad-2));
      min-height: 100vh;
    }
    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-bd);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
    }
    .tile {
      background: linear-gradient(135deg, rgba(14,165,233,0.15), rgba(14,165,233,0.05));
      border: 1px solid rgba(14,165,233,0.25);
    }
    .metric-number { direction: ltr; font-variant-numeric: tabular-nums; }
    .btn-gradient { background: linear-gradient(135deg, #1e3a5f, #0f172a 60%, #0ea5e9); border: none; color: #fff; }
    .badge-soft { background: rgba(14,165,233,0.15); border: 1px solid rgba(14,165,233,0.35); color: #e5f6ff; }
    .table :where(th, td) { white-space: nowrap; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; }

    /* Ø«Ø¨Ù‘Øª Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… */
    .chart-card { display:flex; flex-direction: column; }
    .chart-wrap { position: relative; width: 100%; height: 280px; }
    @media (min-width: 768px){ .chart-wrap{ height: 300px; } }
    @media (min-width: 1024px){ .chart-wrap{ height: 320px; } }
    .chart-wrap canvas{ position:absolute; inset:0; width:100% !important; height:100% !important; }
  </style>
</head>
<body class="text-slate-100">
  <!-- Header -->
  <header class="p-4 md:p-6">
    <div class="glass p-4 md:p-6 rounded-2xl flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl tile grid place-items-center">
          <i class="fa-solid fa-hospital text-xl"></i>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²Ø© â€” ICU Dashboard</h1>
          <p class="opacity-70">ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheets (Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ).</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnLast7"  class="btn btn-sm btn-gradient">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</button>
        <button id="btnLast30" class="btn btn-sm btn-gradient">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</button>
        <button id="btnQtr"    class="btn btn-sm btn-gradient">Ø¢Ø®Ø± 90 ÙŠÙˆÙ…</button>
        <button id="btnYTD"    class="btn btn-sm btn-outline">Ù…Ù†Ø° Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©</button>
        <button id="btnAll"    class="btn btn-sm btn-outline">Ø§Ù„ÙƒÙ„</button>
        <button id="btnToggleCharts" class="btn btn-sm btn-outline">Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³ÙˆÙ…</button>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="px-4 md:px-6">
    <div class="glass p-4 md:p-6 rounded-2xl grid md:grid-cols-3 gap-4 items-end">
      <div>
        <label class="label"><span class="label-text">Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„ØªØµÙÙŠØ©</span></label>
        <div class="join">
          <input class="join-item btn btn-sm" type="radio" name="dateKind" id="dateAdmission" checked>
          <label for="dateAdmission" class="join-item btn btn-sm">Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <input class="join-item btn btn-sm" type="radio" name="dateKind" id="dateDischarge">
          <label for="dateDischarge" class="join-item btn btn-sm">Ø§Ù„Ø®Ø±ÙˆØ¬</label>
        </div>
      </div>
      <div>
        <label class="label"><span class="label-text">Ù…Ù† ØªØ§Ø±ÙŠØ®</span></label>
        <input id="dateFrom" type="date" class="input input-bordered w-full" />
      </div>
      <div>
        <label class="label"><span class="label-text">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</span></label>
        <div class="flex gap-2">
          <input id="dateTo" type="date" class="input input-bordered w-full" />
          <button id="btnRefresh" class="btn btn-gradient">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="p-4 md:p-6">
    <div class="grid lg:grid-cols-5 md:grid-cols-3 grid-cols-2 gap-4">
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
        <div id="kpiTotal" class="text-3xl font-bold metric-number">â€”</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div id="kpiAdmissions" class="text-3xl font-bold metric-number">â€”</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
        <div id="kpiDischarges" class="text-3xl font-bold metric-number">â€”</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">Ù…ØªÙˆØ³Ø·/ÙˆØ³ÙŠØ· Ø§Ù„Ø¹Ù…Ø±</div>
        <div id="kpiAge" class="text-xl font-semibold metric-number">â€”</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">Ù…ØªÙˆØ³Ø·/ÙˆØ³ÙŠØ· LOS (ÙŠÙˆÙ…)</div>
        <div id="kpiLOS" class="text-xl font-semibold metric-number">â€”</div>
      </div>
    </div>
  </section>

 


  <!-- Charts -->
  <section id="chartsSection" class="px-4 md:px-6">
    <div class="grid lg:grid-cols-4 md:grid-cols-2 gap-4">
      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Ø§Ù„Ø¬Ù†Ø³</h3>
          <span class="badge badge-soft">Distribution â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙÙŠØ©</span>
        </div>
        <div class="chart-wrap"><canvas id="chartGender"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Ø£ÙƒØ«Ø± Ø§Ù„Ø¬Ù†Ø³ÙŠØ§Øª (Top 10)</h3>
          <span class="badge badge-soft">Counts â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙÙŠØ©</span>
        </div>
        <div class="chart-wrap"><canvas id="chartNationality"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">ÙØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ø±</h3>
          <span class="badge badge-soft">Histogram â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙÙŠØ©</span>
        </div>
        <div class="chart-wrap"><canvas id="chartAge"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Outcome)</h3>
          <span class="badge badge-soft">Status â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙÙŠØ©</span>
        </div>
        <div class="chart-wrap"><canvas id="chartOutcome"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</h3>
          <span class="badge badge-soft">Trend â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙÙŠØ©</span>
        </div>
        <div class="chart-wrap"><canvas id="chartMonthly"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">ØªÙˆØ²ÙŠØ¹ Ù…Ø¯Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© LOS (Ø£ÙŠØ§Ù…)</h3>
          <span class="badge badge-soft">Histogram â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙÙŠØ©</span>
        </div>
        <div class="chart-wrap"><canvas id="chartLOS"></canvas></div>
      </div>



<!-- Daily report table (Grid item spans full width) -->
<div class="glass p-4 md:p-6 rounded-2xl md:col-span-2 lg:col-span-4">
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-2">
      <i class="fa-solid fa-calendar-day"></i>
      <h3 class="font-semibold text-lg">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ â€” Admissions & Census</h3>
    </div>
  </div>
  <div class="overflow-auto">
    <table class="table table-zebra">
    <thead id="censusThead">
  <tr>
    <th>Ø§Ù„Ù…Ø¤Ø´Ø±</th>
  </tr>
</thead>

      <tbody id="censusTBody">
        <tr><td colspan="3" class="text-center py-6 opacity-70">â€”</td></tr>
      </tbody>
    </table>
  </div>
</div>



      <!-- Ø¬Ø¯ÙŠØ¯: Ø¯Ø®ÙˆÙ„ ÙŠÙˆÙ…ÙŠ -->
      <div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ (Admissions per day)</h3>
          <span class="badge badge-soft">Daily â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙÙŠØ©</span>
        </div>
        <div class="chart-wrap"><canvas id="chartDaily"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Chart filter badge -->
  <section class="px-4 md:px-6 mt-4">
    <div id="chartFilterBar" class="glass p-3 rounded-xl hidden items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="badge badge-soft">ØªØµÙÙŠØ© Ù…Ù† Ø±Ø³Ù…</span>
        <span id="chartFilterDesc" class="opacity-90"></span>
      </div>
      <button id="btnClearChartFilter" class="btn btn-xs btn-outline">Ù…Ø³Ø­ Ø§Ù„ØªØµÙÙŠØ©</button>
    </div>
  </section>

  <!-- ICU Mortality per 1,000 Patient-Days â€” Monthly -->
<div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-4" id="monthlyMortalityCard">
  <div class="flex items-center justify-between mb-2">
<h3 class="font-semibold">ICU Mortality % â€” Ø´Ù‡Ø±ÙŠÙ‹Ø§</h3>
    <span class="badge badge-soft">Per month â€¢ Since Launching</span>
  </div>
  <div class="chart-wrap"><canvas id="chartMortality"></canvas></div>

  <div class="overflow-auto mt-4">
    <table class="table table-zebra">
      <thead>
        <tr>
          <th>Month</th>
          <th>Patient-Days</th>
          <th>Deaths</th>
<th>Mortality %</th>
        </tr>
      </thead>
      <tbody id="mortalityTBody">
        <tr><td colspan="4" class="text-center py-6 opacity-70">â€”</td></tr>
      </tbody>
    </table>
  </div>
</div>


  <!-- Table -->
  <section class="p-4 md:p-6">
    <div class="glass p-4 md:p-6 rounded-2xl">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-table"></i>
          <h3 class="font-semibold text-lg">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ø¶Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯)</h3>
        </div>
        <div class="flex items-center gap-2">
          <input id="searchBox" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ØªØ´Ø®ÙŠØµ / MRNâ€¦" class="input input-bordered input-sm w-64" />
          <button id="btnExport" class="btn btn-sm btn-outline"><i class="fa-solid fa-file-arrow-down ml-2"></i>ØªØµØ¯ÙŠØ± CSV (Ø§Ù„Ù…Ø±Ø´Ù‘Ø­)</button>
        </div>
      </div>

      <div class="overflow-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
              <th>MRN</th>
              <th>Ø§Ù„Ø¹Ù…Ø±</th>
              <th>Ø§Ù„Ø¬Ù†Ø³</th>
              <th>Ø§Ù„Ø¬Ù†Ø³ÙŠÙ‘Ø©</th>
              <th class="min-w-40">ØªØ´Ø®ÙŠØµ Ù…Ø®ØªØµØ±</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬</th>
              <th>Outcome</th>
              <th>LOS (ÙŠÙˆÙ…)</th>
              <th>ØªÙØ§ØµÙŠÙ„</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="12" class="text-center py-8 opacity-70">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Summaries & Lists -->
  <section class="p-4 md:p-6 grid md:grid-cols-3 gap-4">
    <div class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© (Ù„Ù… ØªÙØºÙ„Ù‚)</h3>
        <span id="activeCount" class="badge badge-soft">â€”</span>
      </div>
      <ul id="activeList" class="space-y-2 text-sm"></ul>
    </div>

    <div class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙÙŠØ§Øª (Expired)</h3>
        <span id="expiredCount" class="badge badge-soft">â€”</span>
      </div>
      <ul id="expiredList" class="space-y-2 text-sm"></ul>
    </div>

    <div class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„ÙˆÙ† (Transferred) & Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„</h3>
        <span id="transferredCount" class="badge badge-soft">â€”</span>
      </div>
      <div id="transferReasons" class="text-sm space-y-1"></div>
    </div>
  </section>

  <!-- Modal -->
  <dialog id="detailModal" class="modal">
    <div class="modal-box max-w-4xl">
      <h3 class="font-bold text-xl mb-2"><i class="fa-solid fa-user ml-2"></i><span id="mName">â€”</span></h3>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <div class="glass p-3 rounded-xl">
          <div><span class="opacity-70">MRN:</span> <span id="mMRN" class="metric-number"></span></div>
          <div><span class="opacity-70">Ø§Ù„Ø¹Ù…Ø±:</span> <span id="mAge" class="metric-number"></span></div>
          <div><span class="opacity-70">Ø§Ù„Ø¬Ù†Ø³:</span> <span id="mGender"></span></div>
          <div><span class="opacity-70">Ø§Ù„Ø¬Ù†Ø³ÙŠÙ‘Ø©:</span> <span id="mNationality"></span></div>
          <div><span class="opacity-70">Ø§Ù„ØªÙ…ÙˆÙŠÙ„:</span> <span id="mFinance"></span></div>
          <div><span class="opacity-70">APACHE:</span> <span id="mApache" class="metric-number"></span></div>
        </div>
        <div class="glass p-3 rounded-xl">
          <div><span class="opacity-70">Ø§Ù„Ø¯Ø®ÙˆÙ„:</span> <span id="mAdm"></span></div>
          <div><span class="opacity-70">Ø§Ù„Ø®Ø±ÙˆØ¬:</span> <span id="mDis"></span></div>
          <div><span class="opacity-70">LOS:</span> <span id="mLOS"></span></div>
          <div><span class="opacity-70">Ø¬Ø§Ø¡ Ù…Ù†:</span> <span id="mFrom"></span></div>
          <div><span class="opacity-70">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰:</span> <span id="mTo"></span></div>
          <div><span class="opacity-70">Ø³Ø¨Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„:</span> <span id="mReason"></span></div>
        </div>
      </div>

      <div class="mt-4">
        <div class="glass p-3 rounded-xl">
          <div class="font-semibold mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ</div>
          <div id="mDx" class="truncate-2"></div>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm">
        <div class="glass p-3 rounded-xl">
          <div class="font-semibold mb-2">Ø·Ø§Ù‚Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
          <div>Ø£Ø®ØµØ§Ø¦ÙŠ: <span id="mSpecIn"></span></div>
          <div>Ù…Ù…Ø±Ø¶: <span id="mNurseIn"></span></div>
        </div>
        <div class="glass p-3 rounded-xl">
          <div class="font-semibold mb-2">Ø·Ø§Ù‚Ù… Ø§Ù„Ø®Ø±ÙˆØ¬</div>
          <div>Ø£Ø®ØµØ§Ø¦ÙŠ: <span id="mSpecOut"></span></div>
          <div>Ù…Ù…Ø±Ø¶: <span id="mNurseOut"></span></div>
          <div>Outcome: <span id="mOutcome"></span></div>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog">
          <button class="btn">Ø¥ØºÙ„Ø§Ù‚</button>
        </form>
      </div>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="toast toast-end z-50"></div>

  <script>

      // TODO: Ø­Ø·Ù‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ (Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ Ø¹Ù†Ø¯Ùƒ)
  // Ù…Ø«Ø§Ù„ (Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø¨ØªØ§Ø¹ØªÙƒ):
  firebase.initializeApp({
    apiKey: "AIzaSyCByQute9IKG_2nvSFWcAThgEH7PKIhMDw",
  authDomain: "ctwo-eee79.firebaseapp.com",
  projectId: "ctwo-eee79",
  storageBucket: "ctwo-eee79.appspot.com",
  messagingSenderId: "788657051205",
  appId: "1:788657051205:web:5d4b6884a0ca09e4cb352c",
  measurementId: "G-4VTCQR4ZVR"

  });

  const auth = firebase.auth();
  const db   = firebase.firestore();
  const st   = firebase.storage();

  // Ø·Ø¨Ù‚Ø© Ù‚ÙÙ„ Ø¨Ø³ÙŠØ·Ø© (Ù…Ø§ Ø¨ØªØºÙŠÙ‘Ø±Ø´ Ø£ÙŠ Ø³ØªØ§ÙŠÙ„ Ø¹Ø§Ù…)
  (function(){
    const lock = document.createElement('div');
    lock.id = 'auth-lock';
    lock.style.cssText = 'position:fixed;inset:0;display:grid;place-items:center;background:rgba(15,23,42,.94);z-index:9999';
    lock.innerHTML = `
      <div class="glass p-6 rounded-2xl text-center max-w-sm">
        <h2 class="text-xl font-bold mb-2">ğŸ”’ ÙˆØµÙˆÙ„ Ù…Ù‚ÙŠÙ‘Ø¯</h2>
        <p class="opacity-80 mb-4">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</p>
        <button id="btnLogin" class="btn btn-gradient">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </div>`;
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(lock));
    window.addEventListener('click', (e)=> {
      if(e.target && e.target.id === 'btnLogin'){
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
      }
    });
  })();

  async function startIfAllowed(user){
    // ØªØ­Ù‚Ù‘ÙÙ‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
    const me = await db.collection('allowedUsers').doc(user.uid).get();
    if(!me.exists || me.data().enabled !== true){
      const lock = document.getElementById('auth-lock');
      if(lock) lock.innerHTML = `
        <div class="glass p-6 rounded-2xl text-center max-w-sm">
          <h2 class="text-xl font-bold mb-2">â›” ØºÙŠØ± Ù…ØµØ±Ø­</h2>
          <p class="opacity-80">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø¥Ø¶Ø§ÙØªÙƒ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØµÙˆÙ„.</p>
        </div>`;
      throw new Error('Forbidden');
    }

    // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ CSV + Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„ÙƒÙˆØ¯
    const cfg = await db.collection('config').doc('icuDashboard').get();
    const csvUrl  = cfg.exists ? cfg.data().csvUrl : null;
    const codePath = (cfg.exists && cfg.data().codePath) || 'restricted/icu-dashboard.v1.js';
    if(!csvUrl) throw new Error('Missing csvUrl in config/icuDashboard');
    // Ù…Ø±Ù‘Ø± Ø§Ù„Ù€ CSV Ù„Ù„ÙˆØ­Ø©
window.__CSV_URL = csvUrl;

    // Ø­Ù…Ù‘Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ù…ÙŠ Ù…Ù† Storage
    const codeUrl = await st.ref(codePath).getDownloadURL();
    await new Promise((ok, err)=>{
      const s = document.createElement('script');
      s.src = codeUrl; s.onload = ok; s.onerror = err;
      document.body.appendChild(s);
    });

    // Ø´ØºÙ‘Ù„ Ø§Ù„Ù„ÙˆØ­Ø© (Ù„Ùˆ DOM Ø¬Ø§Ù‡Ø²)
    if (typeof window.init === 'function') {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ()=> window.init());
      } else {
        window.init();
      }
    }

    // Ø§Ø®ÙÙ Ø§Ù„Ù‚ÙÙ„
    document.getElementById('auth-lock')?.remove();
  }

  auth.onAuthStateChanged(async (u)=>{
    try{
      if(!u) return;           // Ù„Ø³Ù‡ Ù…Ø§ Ø³Ø¬Ù„Ø´ Ø¯Ø®ÙˆÙ„
      await startIfAllowed(u); // Ø§Ø¨Ø¯Ø£ Ø¥Ù† ÙƒØ§Ù† Ù…ØµØ±Ø­
    }catch(e){
      console.error(e);
    }
  });



    dayjs.extend(dayjs_plugin_customParseFormat);
dayjs.extend(dayjs_plugin_minMax);

    /* =================== Config =================== */
    const COL = {
      name: "Pt Name", mrn: "Pt MRN", age: "Pt Age", gender: "Gender",
      nationality: "Nationality", finance: "Finance", phone: "Pt Phone",
      adm: "Date & Time of admission", from: "Disposition from", dx: "Pt Diagnosis",
      apache: "APPACHE Score", specIn: "Specialist at admission", nurseIn: "Nurse at admission",
      dis: "Date & Time of Discharge", specOut: "Specialist at discharge", nurseOut: "Nurse at Discharge",
      outcome: "Outcome", to: "Disposition To", reason: "Reason For Transfer", los: "LOS"
    };

    /* =================== State =================== */
    let rawRows = [];
    let filteredRows = [];
    let charts = {};
    let dateKind = "adm"; // adm or dis
    let chartsHidden = false;

    // ØªØµÙÙŠØ© Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø³Ù…
    let chartFilter = null; // { type, label, predicate(row) }

    /* =================== Helpers =================== */

    // ÙŠØ­ÙˆÙ‘Ù„ Ù†Øµ Ø§Ù„Ù€ Outcome Ù„ÙØ¦Ø© Ù…ÙˆØ­Ù‘Ø¯Ø©

    // Ø®Ù„ÙŠØ© Ø¬Ø¯ÙˆÙ„ Ø¨Ø¨Ø§Ø¯Ø¬â€¦ ÙˆÙ„Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© ØµÙØ± ÙŠØ®Ù„Ù‘ÙŠÙ‡Ø§ ÙØ§Ø¶ÙŠØ©
function tdBadge(n, classes){
  if(!n) return `<td></td>`; // Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶ ØµÙØ±
  return `<td><span class="badge ${classes}">${n}</span></td>`;
}


function outcomeCat(s){
  const t = (s || "").toLowerCase().trim();
  if(!t) return null;
  if(t.includes("expir") || t.includes("death") || t.includes("ÙˆÙØ§Ø©") || t.includes("Ù…ÙŠØª")) return "expired";
  if(t.includes("transfer") || t.includes("Ù…Ø­ÙˆÙ„")) return "transferred";
  if(t.includes("dama") || t.includes("against") || t.includes("ama") || t.includes("left") || t.includes("Ù‡Ø±ÙˆØ¨")) return "dama";
  if(t.includes("improv") || t.includes("recover") || t.includes("home") || t.includes("ØªØ­Ø³Ù†")) return "improved";
  return "other";
}



    function normKey(k){
      return String(k||"").replace(/[\uFEFF\u00A0]/g,"").replace(/\s+/g," ").trim();
    }
    function getCell(row, key){
      const target = normKey(COL[key]);
      let v = row[target];
      if (v == null) for (const kk in row) if (normKey(kk) === target) { v = row[kk]; break; }
      return (v==null ? "" : String(v).trim());
    }

    // Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© -> Ù„Ø§ØªÙŠÙ†ÙŠØ© + Øµ/Ù… -> AM/PM
    function toEnglishDigitsAndMeridiem(s){
      if(!s) return "";
      const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Ù«':'.','Ù¬':','};
      let out = String(s).replace(/[Ù -Ù©Ù«Ù¬]/g, ch => map[ch] ?? ch);
      out = out.replace(/\s*[ØµØµ]\.?/gi, ' AM').replace(/\s*[Ù…Ù…]\.?/gi, ' PM');
      out = out.replace(/ØµØ¨Ø§Ø­Ø§Ù‹?|ØµØ¨Ø§Ø­Ø§|ØµØ¨Ø§Ø­/gi, ' AM').replace(/Ù…Ø³Ø§Ø¡Ù‹?|Ù…Ø³Ø§Ø¡|Ø§Ù„Ù…Ø³Ø§Ø¡/gi, ' PM');
      return out.trim();
    }

    function parseDateFlexible(s){
      if(!s) return null;
      const t0 = toEnglishDigitsAndMeridiem(String(s).trim());
      if(!t0) return null;

      if(/^\d+(\.\d+)?$/.test(t0)){ // Excel serial
        const n = Number(t0);
        if(n > 20000 && n < 100000){ const base = Date.UTC(1899,11,30); return new Date(base + n * 86400000); }
      }
      if(/T|\d{4}-\d{2}-\d{2}/.test(t0)){ const d = dayjs(t0); if(d.isValid()) return d.toDate(); }

      const FMT = [
        "DD-MM-YYYY HH:mm","D-M-YYYY HH:mm","DD-MM-YYYY H:mm",
        "YYYY-MM-DD HH:mm","YYYY/MM/DD HH:mm","YYYY/M/D HH:mm",
        "DD/MM/YYYY HH:mm","D/M/YYYY HH:mm","DD/MM/YYYY H:mm",
        "MM/DD/YYYY HH:mm","M/D/YYYY HH:mm","MM/DD/YYYY h:mm A","M/D/YYYY h:mm A",
        "YYYY-MM-DDTHH:mm","YYYY-MM-DD","DD-MM-YYYY","MM-DD-YYYY","DD/MM/YYYY","MM/DD/YYYY",
        "h:mm:ss A YYYY/MM/DD","h:mm A YYYY/MM/DD","h:mm:ss A YYYY-M-D","h:mm A YYYY-M-D",
        "h:mm:ss A DD/MM/YYYY","h:mm A DD/MM/YYYY"
      ];
      for(const f of FMT){ const d = dayjs(t0, f, true); if(d.isValid()) return d.toDate(); }
      const d2 = new Date(t0);
      return isNaN(d2.getTime()) ? null : d2;
    }

    function fmt(dt){ if(!dt) return "â€”"; const d = dayjs(dt); return d.isValid()? d.format("YYYY-MM-DD HH:mm") : "â€”"; }
    function daysBetween(a,b){ if(!a||!b) return null; const ms=b.getTime()-a.getTime(); return ms<0?null: ms/86400000; }
    function num(v){ const n=parseFloat(String(v).replace(/[^\d.\-]/g,"")); return isNaN(n)?null:n; }
    function toast(msg, type="info"){
      const t = document.getElementById("toast");
      const el = document.createElement("div");
      el.className = `alert ${type==="success"?"alert-success":type==="error"?"alert-error":"alert-info"}`;
      el.innerHTML = `<span>${msg}</span>`;
      t.appendChild(el);
      setTimeout(()=> el.remove(), 4000);
    }
    function quantiles(arr){
      if(!arr.length) return {p50:null,p90:null};
      const a = [...arr].sort((x,y)=>x-y);
      const q = (p)=>{ const idx=(a.length-1)*p, lo=Math.floor(idx), hi=Math.ceil(idx); return lo===hi? a[lo] : a[lo]+(a[hi]-a[lo])*(idx-lo); };
      return {p50:q(0.5), p90:q(0.9)};
    }
    function avg(arr){ return arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : null; }
    function palette(n){ return Array.from({length:n}, (_,i)=>`hsl(${(i*47)%360} 70% 55%)`); }

// Ø£Ù„ÙˆØ§Ù†/ÙƒÙ„Ø§Ø³Ø§Øª Ø­Ø³Ø¨ Ù…ØªÙˆØ³Ø· "Total Active"
function classByAvg(n, avg){
  if(n == null) return '';
  if(n > avg * 1.15) return 'badge-error';    // Ø£Ø¹Ù„Ù‰ Ø¨ÙˆØ¶ÙˆØ­ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·
  if(n >= avg * 0.85) return 'badge-warning'; // Ø­ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·
  return 'badge-success';                      // Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·
}
function badgeByAvg(n, avg){
  if(!n) return `<td></td>`;
  const cls = classByAvg(n, avg);
  return `<td><span class="badge ${cls}">${n}</span></td>`;
}
// Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¯Ø§Ø®Ù„ Chart.js
function colorByAvgValue(n, avg){
  if(n == null) return 'hsl(210 10% 35%)';
  if(n > avg * 1.15) return 'hsl(0 70% 55%)';    // Ø£Ø­Ù…Ø±
  if(n >= avg * 0.85) return 'hsl(40 85% 50%)';  // Ø£ØµÙØ±/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
  return 'hsl(160 70% 45%)';                     // Ø£Ø®Ø¶Ø±
}


    /* =================== Load CSV =================== */
  async function loadCSV(){
  const url = window.__CSV_URL || window.CSV_URL; // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙŠ Ù…ØªØ§Ø­
  if(!url) throw new Error('CSV URL is missing');
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      download: true, header: true, skipEmptyLines: true,
      complete: (res)=>{ /* Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ */ 
        resolve(res.data.map(r=>{
          const nr = {}; Object.keys(r).forEach(k=> nr[normKey(k)] = r[k]); return nr;
        }));
      },
      error: reject
    });
  });
}


    /* =================== Transform =================== */
    function transform(rows){
      return rows.map((r,i)=>{
        const adm = parseDateFlexible(getCell(r,'adm'));
        const dis = parseDateFlexible(getCell(r,'dis'));
        const losDays = (dis && adm) ? daysBetween(adm, dis) : null;
        return {
          idx: i+1,
          name: getCell(r,'name'),
          mrn: getCell(r,'mrn'),
          age: num(getCell(r,'age')),
          gender: getCell(r,'gender'),
          nationality: getCell(r,'nationality'),
          finance: getCell(r,'finance'),
          adm, dis,
          from: getCell(r,'from'),
          dx: getCell(r,'dx'),
          apache: num(getCell(r,'apache')),
          specIn: getCell(r,'specIn'),
          nurseIn: getCell(r,'nurseIn'),
          specOut: getCell(r,'specOut'),
          nurseOut: getCell(r,'nurseOut'),
          outcome: getCell(r,'outcome'),
          to: getCell(r,'to'),
          reason: getCell(r,'reason'),
          losDays
        };
      });
    }

    /* =================== Derived & Lists =================== */
    function renderLists(rows){
      // Active: Outcome ÙØ§Ø¶ÙŠ
      const active = rows.filter(r => !r.outcome || !r.outcome.trim());
      document.getElementById('activeCount').textContent = active.length;
      const now = new Date();
      const ulA = document.getElementById('activeList'); ulA.innerHTML = "";
      active.forEach((r, i)=>{
        const currentLOS = r.adm ? daysBetween(r.adm, now) : null;
        const li = document.createElement('li');
        li.className = "glass p-2 rounded-lg flex items-center justify-between";
        li.innerHTML = `
          <div class="min-w-0">
            <div class="font-semibold truncate">${r.name||"â€”"}</div>
            <div class="text-xs opacity-80">MRN: <span class="metric-number">${r.mrn||"â€”"}</span> â€¢ Ø¯Ø®ÙˆÙ„: ${fmt(r.adm)} â€¢ LOS: ${currentLOS!=null?currentLOS.toFixed(1):"â€”"} ÙŠÙˆÙ…</div>
          </div>
          <button class="btn btn-xs btn-gradient" data-view="${i}">Ø¹Ø±Ø¶</button>
        `;
        li.querySelector('button').addEventListener('click', ()=> openModal(r));
        ulA.appendChild(li);
      });

      // Expired
      const expired = rows.filter(r => (r.outcome||"").toLowerCase().includes("expired"));
      document.getElementById('expiredCount').textContent = expired.length;
      const ulE = document.getElementById('expiredList'); ulE.innerHTML = "";
      expired.forEach((r,i)=>{
        const li = document.createElement('li');
        li.className = "glass p-2 rounded-lg flex items-center justify-between";
        li.innerHTML = `
          <div class="min-w-0">
            <div class="font-semibold truncate">${r.name||"â€”"}</div>
            <div class="text-xs opacity-80">MRN: <span class="metric-number">${r.mrn||"â€”"}</span> â€¢ Ø¯Ø®ÙˆÙ„: ${fmt(r.adm)} â€¢ Ø®Ø±ÙˆØ¬: ${fmt(r.dis)}</div>
          </div>
          <button class="btn btn-xs btn-gradient" data-view="${i}">Ø¹Ø±Ø¶</button>
        `;
        li.querySelector('button').addEventListener('click', ()=> openModal(r));
        ulE.appendChild(li);
      });

      // Transferred + reasons
      const transferred = rows.filter(r => (r.outcome||"").toLowerCase().includes("transfer"));
      document.getElementById('transferredCount').textContent = transferred.length;
      const reasonsMap = new Map();
      transferred.forEach(r=>{
        const key = (r.reason||"ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±").trim() || "ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±";
        reasonsMap.set(key, (reasonsMap.get(key)||0)+1);
      });
      const reasons = [...reasonsMap.entries()].sort((a,b)=>b[1]-a[1]);
      const cont = document.getElementById('transferReasons');
      cont.innerHTML = reasons.length ? reasons.map(([k,v])=>`<div>â€¢ ${k} <span class="badge badge-soft ml-2">${v}</span></div>`).join("") : `<div class="opacity-70">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø©.</div>`;
    }

    /* =================== Filtering =================== */
    function applyFilter(){
      const from = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value+" 00:00") : null;
      const to   = document.getElementById('dateTo').value   ? new Date(document.getElementById('dateTo').value+" 23:59") : null;
      dateKind = document.getElementById('dateDischarge').checked ? "dis" : "adm";
      const q = document.getElementById('searchBox').value.trim().toLowerCase();



      filteredRows = rawRows.filter(r=>{
        const refDate = r[dateKind];
        if(from && (!refDate || refDate < from)) return false;
        if(to && (!refDate || refDate > to)) return false;
        if(q){
          const hay = [r.name, r.mrn, r.dx, r.nationality, r.gender, r.outcome].join(" ").toLowerCase();
          if(!hay.includes(q)) return false;
        }
        if(chartFilter && chartFilter.predicate && !chartFilter.predicate(r)) return false;
        return true;
      });

      
renderKPIs(filteredRows);

// NEW: Ø­Ø¯Ù‘Ø« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§
renderCensusTable( buildDailySeries(filteredRows) );

if(!chartsHidden) renderCharts(filteredRows);
renderTable(filteredRows);

renderLists(filteredRows);
      renderMonthlyMortality(); // Ù…Ù† Ø£ÙˆÙ„ Ø­Ø§Ù„Ø© Ø¹Ø¨Ø± rawRows

    }

    /* =================== KPIs =================== */
    function renderKPIs(rows){
      document.getElementById('kpiTotal').textContent = rows.length.toLocaleString('en-US');
      const admCount = rows.filter(r=> r.adm).length;
      const disCount = rows.filter(r=> r.dis).length;
      document.getElementById('kpiAdmissions').textContent = admCount.toLocaleString('en-US');
      document.getElementById('kpiDischarges').textContent = disCount.toLocaleString('en-US');

      const ages = rows.map(r=>r.age).filter(v=>v!=null && v>=0 && v<=120);
      const {p50:ageMed} = quantiles(ages); const ageAvg = avg(ages);
      document.getElementById('kpiAge').textContent = (ageAvg!=null?ageAvg.toFixed(1):"â€”") + " / " + (ageMed!=null?ageMed.toFixed(0):"â€”");

      const los = rows.map(r=>r.losDays).filter(v=>v!=null && v>=0 && isFinite(v));
      const {p50:losMed} = quantiles(los); const losAvg = avg(los);
      document.getElementById('kpiLOS').textContent = (losAvg!=null?losAvg.toFixed(1):"â€”") + " / " + (losMed!=null?losMed.toFixed(1):"â€”");
    }


    // ÙŠØ¨Ù†ÙŠ Ø³Ù„Ø§Ø³Ù„ admissions Ùˆ census@00:00 Ø¹Ù„Ù‰ Ù…Ø¯Ù‰ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
// ÙŠØ¨Ù†ÙŠ Ø³Ù„Ø§Ø³Ù„ admissions Ùˆ census@00:00 + ØªÙØµÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø§Øª Ù„ÙƒÙ„ ÙŠÙˆÙ…
function buildDailySeries(rows){
  const fromVal = document.getElementById('dateFrom').value;
  const toVal   = document.getElementById('dateTo').value;

  let start;
  if (fromVal) start = dayjs(fromVal).startOf('day');
  else {
    const adms = rows.map(r=>r.adm).filter(Boolean).map(d=>dayjs(d));
    start = adms.length ? dayjs.min(adms).startOf('day') : dayjs().startOf('day');
  }

  let end;
  if (toVal) end = dayjs(toVal).startOf('day');
  else {
    const allDates = rows.flatMap(r=>[r.adm, r.dis].filter(Boolean)).map(d=>dayjs(d));
    const maxSeen = allDates.length ? dayjs.max(allDates) : dayjs();
    const hasActive = rows.some(r=>!r.dis);
    end = (hasActive && dayjs().isAfter(maxSeen)) ? dayjs().startOf('day') : maxSeen.startOf('day');
  }

  const labels = [];
  const admissions = [];
  const census = [];
  const disAll = [];
  const disImproved = [];
  const disDAMA = [];
  const disTransferred = [];
  const disExpired = [];
  const totalActive = []; // <-- ÙƒØ§Ù† Ù†Ø§Ù‚Øµ

  for(let d = start; !d.isAfter(end); d = d.add(1,'day')){
    const dayStart = d.startOf('day').toDate();
    const dayEnd   = d.endOf('day').toDate();

    const admCnt = rows.filter(r => r.adm && dayjs(r.adm).isSame(d, 'day')).length;
    const cenCnt = rows.filter(r => r.adm && r.adm <= dayEnd && (!r.dis || r.dis > dayEnd)).length;

    const sameDayDis = rows.filter(r => r.dis && dayjs(r.dis).isSame(d,'day'));
    const allCnt = sameDayDis.length;
    let imp=0, dama=0, trans=0, exp=0;
    sameDayDis.forEach(r=>{
      switch (outcomeCat(r.outcome)) {
        case "improved":     imp++; break;
        case "dama":         dama++; break;
        case "transferred":  trans++; break;
        case "expired":      exp++; break;
      }
    });

    // Total Active (24h): Ø£ÙŠ Ù…Ø±ÙŠØ¶ ØªØ¯Ø§Ø®Ù„Øª Ø¥Ù‚Ø§Ù…ØªÙ‡ Ù…Ø¹ Ø§Ù„ÙŠÙˆÙ…
    const activeCnt = rows.filter(r => r.adm && r.adm <= dayEnd && (!r.dis || r.dis > dayStart)).length;

    labels.push(d.format('YYYY-MM-DD'));
    admissions.push(admCnt);
    census.push(cenCnt);
    disAll.push(allCnt);
    disImproved.push(imp);
    disDAMA.push(dama);
    disTransferred.push(trans);
    disExpired.push(exp);
    totalActive.push(activeCnt);
  }

  const totalActiveAvg = avg(totalActive);
  return { labels, admissions, census, disAll, disImproved, disDAMA, disTransferred, disExpired, totalActive, totalActiveAvg };
}
// ÙŠØ±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ
// ÙŠØ±Ø³Ù… "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ" Ø¨Ø´ÙƒÙ„ Ø£ÙÙ‚ÙŠ:
// Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© = Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„ØµÙÙˆÙ = Admissions Ùˆ Census @ 00:00
// ÙŠØ±Ø³Ù… "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ" Ø¨Ø´ÙƒÙ„ Ø£ÙÙ‚ÙŠ:
// Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© = Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„ØµÙÙˆÙ = Admissions / Census / Discharges (+ ØªÙØµÙŠÙ„Ù‡Ø§)
// ÙŠØ±Ø³Ù… "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ" Ø£ÙÙ‚ÙŠÙ‹Ø§: Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© = Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
// Ø§Ù„ØµÙÙˆÙ (Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨): Census @ 00:00 (Ù…Ù…ÙŠÙ‘Ø²) â†’ Admissions â†’ Discharges + Ø§Ù„ØªÙØµÙŠÙ„
function renderCensusTable(series){
  const thead = document.getElementById('censusThead');
  const tbody = document.getElementById('censusTBody');
  if(!thead || !tbody) return;

  if(!series.labels.length){
    thead.innerHTML = `<tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th></tr>`;
    tbody.innerHTML = `<tr><td colspan="2" class="text-center py-6 opacity-70">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±</td></tr>`;
    return;
  }

  // Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®)
  let headHTML = `<tr><th class="sticky-start is-head col-label">Ø§Ù„Ù…Ø¤Ø´Ø±</th>`;
  for(const d of series.labels){
    headHTML += `<th class="metric-number">${d}</th>`;
  }
  headHTML += `</tr>`;
  thead.innerHTML = headHTML;

  // 1) Census @ 00:00
  let rowCensus = `<tr><td class="sticky-start col-label"><span class="badge badge-secondary gap-2">
  <i class="fa-regular fa-clock"></i> Census @ 23:59
</span></td>`;
  for(const n of series.census){
    rowCensus += tdBadge(n, 'badge-secondary');
  }
  rowCensus += `</tr>`;

  // 1.5) NEW: Total Active (24h) = Admissions + Census @ 00:00 (Ù…ÙÙ„ÙˆÙ‘Ù† Ø­Ø³Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·)
  const avgTA = series.totalActiveAvg ?? (series.totalActive?.length ? avg(series.totalActive) : null);
  let rowTA = `<tr><td class="sticky-start col-label">
    <span class="badge badge-accent gap-2"><i class="fa-solid fa-bolt"></i> Total Active (24h)</span>
    ${avgTA!=null ? `<span class="badge badge-soft ml-2">Avg ${avgTA.toFixed(1)}</span>` : ``}
  </td>`;
  for(const n of series.totalActive || []){
    rowTA += badgeByAvg(n, avgTA ?? 0);
  }
  rowTA += `</tr>`;

  // 2) Admissions
  let rowAdmissions = `<tr><td class="sticky-start col-label">Admissions</td>`;
  for(const n of series.admissions){
    rowAdmissions += tdBadge(n, 'badge-success');
  }
  rowAdmissions += `</tr>`;

  // 3) Discharges (All)
  let rowDisAll = `<tr><td class="sticky-start col-label">Discharges (All)</td>`;
  for(const n of (series.disAll || [])){
    rowDisAll += tdBadge(n, 'badge-neutral');
  }
  rowDisAll += `</tr>`;

  // 4) Improved
  let rowImp = `<tr><td class="sticky-start col-label">Improved</td>`;
  for(const n of (series.disImproved || [])){
    rowImp += tdBadge(n, 'badge-primary');
  }
  rowImp += `</tr>`;

  // 5) DAMA
  let rowDama = `<tr><td class="sticky-start col-label">DAMA</td>`;
  for(const n of (series.disDAMA || [])){
    rowDama += tdBadge(n, 'badge-warning');
  }
  rowDama += `</tr>`;

  // 6) Transferred
  let rowTrans = `<tr><td class="sticky-start col-label">Transferred</td>`;
  for(const n of (series.disTransferred || [])){
    rowTrans += tdBadge(n, 'badge-info');
  }
  rowTrans += `</tr>`;

  // 7) Expired
  let rowExp = `<tr><td class="sticky-start col-label">Expired</td>`;
  for(const n of (series.disExpired || [])){
    rowExp += tdBadge(n, 'badge-error');
  }
  rowExp += `</tr>`;

  // Ø§Ù„ØªØ±ØªÙŠØ¨: Census â†’ Total Active â†’ Admissions â†’ ...
tbody.innerHTML = rowTA + rowCensus + rowAdmissions + rowDisAll + rowImp + rowDama + rowTrans + rowExp;
}

// ÙŠØ¨Ù†ÙŠ Ø³Ù„Ø§Ø³Ù„ Ø´Ù‡Ø±ÙŠØ©: Patient-Days Ùˆ Deaths Ùˆ Mortality/1000
// Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ­Ø³Ø¨ Ù…Ù† Ø£ÙˆÙ„ Ø­Ø§Ù„Ø© ÙÙŠ "ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" rawRows ÙˆÙ„ÙŠØ³ Ø¶Ù…Ù† Ø§Ù„ÙÙ„ØªØ±.
function buildMonthlyMortalityFromAllData(){
  const rows = rawRows;
  if(!rows?.length) return { months:[], patientDays:[], deaths:[], mortality:[] };

  const allAdms = rows.map(r=>r.adm).filter(Boolean).map(d=>dayjs(d));
  if(!allAdms.length) return { months:[], patientDays:[], deaths:[], mortality:[] };

  const start = dayjs.min(allAdms).startOf('day');
  const allDates = rows.flatMap(r=>[r.adm, r.dis].filter(Boolean)).map(d=>dayjs(d));
  const maxSeen = allDates.length ? dayjs.max(allDates) : dayjs();
  const hasActive = rows.some(r=>!r.dis);
  const end = (hasActive && dayjs().isAfter(maxSeen)) ? dayjs().endOf('day') : maxSeen.endOf('day');

  const daysMap = new Map();   // YYYY-MM -> patient-days (integer after ceiling)
  const deathMap = new Map();  // YYYY-MM -> integer

  // ÙˆØ²Ù‘Ø¹ Ø¥Ù‚Ø§Ù…Ø© ÙƒÙ„ Ù…Ø±ÙŠØ¶ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡ÙˆØ± Ù…Ø¹ Ø¬ÙØ¨Ù’Ø± Ø£ÙŠ ÙƒØ³Ø± Ù„ÙŠÙˆÙ… ÙƒØ§Ù…Ù„
  for(const r of rows){
    if(!r.adm) continue;
    const s = dayjs.max(dayjs(r.adm), start);
    const e = r.dis ? dayjs.min(dayjs(r.dis), end) : end;
    if(!e.isAfter(s)) continue;

    let cur = s;
    while(cur.isBefore(e)){
      const monthEnd = dayjs.min(e, cur.endOf('month'));
      const d = (monthEnd.valueOf() - cur.valueOf()) / 86400000;
      const dayChunk = d > 0 ? Math.ceil(d) : 0; // Ø¬Ø¨Ø± Ø§Ù„ÙƒØ³ÙˆØ±
      const key = cur.format('YYYY-MM');         // <-- ÙƒØ§Ù† Ù†Ø§Ù‚Øµ
      daysMap.set(key, (daysMap.get(key) || 0) + dayChunk);
      cur = monthEnd.add(1, 'second');
    }
  }

  // ÙˆÙÙŠØ§Øª Ø­Ø³Ø¨ Ø´Ù‡Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ùˆ Outcome = Expired
  for(const r of rows){
    if(r.dis && outcomeCat(r.outcome) === 'expired'){
      const key = dayjs(r.dis).format('YYYY-MM');
      deathMap.set(key, (deathMap.get(key) || 0) + 1);
    }
  }

  const months = Array.from(new Set([...daysMap.keys(), ...deathMap.keys()])).sort();
  const patientDays = months.map(m => daysMap.get(m) || 0);
  const deaths      = months.map(m => deathMap.get(m) || 0);
  const mortality   = months.map((_,i) => patientDays[i] > 0 ? (deaths[i] / patientDays[i]) * 1000 : null);

  return { months, patientDays, deaths, mortality };
}

// ÙŠØ±Ø³Ù… ÙƒØ§Ø±Øª Ø§Ù„ÙˆÙÙŠØ§Øª Ø´Ù‡Ø±ÙŠÙ‹Ø§ ÙƒÙ†Ø³Ø¨Ø© % Ù…Ø¹ ØªÙ…ÙŠÙŠØ² Ø£Ø¹Ù„Ù‰/Ø£Ù‚Ù„ Ù‚ÙŠÙ…Ø© + ØªÙ„ÙˆÙŠÙ† ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
// ICU Mortality % (Ù…Ù† Ø£ÙˆÙ„ Ø­Ø§Ù„Ø©) Ù…Ø¹ Ù…Ù‚ÙŠØ§Ø³ Ù…Ø¶Ø¨ÙˆØ· ÙŠØ¸Ù‡Ø± Ø§Ù„Ù‚ÙŠÙ… 2â€“5%
function renderMonthlyMortality(){
  const s = buildMonthlyMortalityFromAllData();

  // Mortality % (Ù…Ù† Ù„ÙƒÙ„ 1000 Ø¥Ù„Ù‰ Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©)
  const mortPct = s.mortality.map(v => v != null ? +(v * 0.1).toFixed(2) : null);

  // Ø£Ø¹Ù„Ù‰/Ø£Ù‚Ù„ Ù‚ÙŠÙ…Ø© (Ù„Ø§ÙØªØ§Øª Ù„Ù„Ø¬Ø¯ÙˆÙ„)
  const pairs = mortPct.map((v,i)=>({v,i})).filter(p=>p.v!=null);
  const maxIdx = pairs.length ? pairs.reduce((a,b)=> b.v>a.v?b:a).i : -1;
  const minIdx = pairs.length ? pairs.reduce((a,b)=> b.v<a.v?b:a).i : -1;

  // Ù…Ù‚Ø§ÙŠÙŠØ³
  const rateMax = Math.max(1, Math.ceil((Math.max(...mortPct.filter(v=>v!=null), 0) * 1.2)));
  const daysMax = Math.ceil((Math.max(...s.patientDays, 0) * 1.2));

  // Ù…ØªÙˆØ³Ø· Ø§Ù„Ù€ Mortality %
  const valid = mortPct.filter(v => v != null);
  const mortAvg = valid.length ? (valid.reduce((a,b)=>a+b,0) / valid.length) : null;

  // Ù„ÙˆÙ‘Ù† Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø·: ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø£Ø­Ù…Ø±ØŒ Ø£Ù‚Ù„/ÙŠØ³Ø§ÙˆÙŠ Ø£Ø®Ø¶Ø±
  const pointRadius = mortPct.map(v => v != null ? 4 : 0);
  const pointBackgroundColor = mortPct.map(v => {
    if (v == null) return undefined;
    return (mortAvg != null && v > mortAvg) ? 'hsl(0 70% 55%)' : 'hsl(160 70% 45%)';
  });

  // Ø£Ø¶Ù/Ø­Ø¯Ù‘Ø« Ø´Ø§Ø±Ø© Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  try {
    const card = document.getElementById('monthlyMortalityCard');
    const h3 = card?.querySelector('h3');
    if (h3) {
      let avgBadge = card.querySelector('#mortAvgBadge');
      if (!avgBadge) {
        avgBadge = document.createElement('span');
        avgBadge.id = 'mortAvgBadge';
        avgBadge.className = 'badge badge-soft ml-2';
        h3.appendChild(document.createTextNode(' '));
        h3.appendChild(avgBadge);
      }
      avgBadge.textContent = `Avg: ${mortAvg != null ? mortAvg.toFixed(1) + '%' : 'â€”'}`;
    }
  } catch(e) { /* no-op */ }

ensureChart("chartMortality", {
  type: "bar",
  data: {
    labels: s.months,
    datasets: [
      {
        type: "bar",
        label: "Patient-Days",
        data: s.patientDays.map(x => x != null ? +x.toFixed(2) : null),
        yAxisID: "yDays",
        backgroundColor: "hsl(210 70% 55%)",
        order: -10 // â† Ø§Ø±Ø³Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹ (Ø®Ù„Ù)
      },
      {
        type: "line",
        label: "Mortality %",
        data: mortPct,
        yAxisID: "yRate",
        tension: 0.25,
        spanGaps: true,
        pointRadius,
        pointBackgroundColor,
        borderWidth: 2,
        order: 10,   // â† Ø§Ø±Ø³Ù… Ø§Ù„Ø®Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ù‚Ø¯Ù‘Ø§Ù…)
        clip: false  // â† Ø§Ø­ØªÙŠØ§Ø·: ÙŠÙ…Ù†Ø¹ Ø£ÙŠ Ù‚ØµÙ‘ ÙŠØ¬Ø¹Ù„ Ø£Ø¬Ø²Ø§Ø¡ Ù…Ù† Ø§Ù„Ø®Ø· ØªØ®ØªÙÙŠ Ø®Ù„Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      }
    ]
  },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label(ctx){
              const lbl = ctx.dataset.label || '';
              const val = ctx.parsed.y;
              return ctx.dataset.yAxisID === 'yRate'
                ? `${lbl}: ${val != null ? val.toFixed(1) + '%' : 'â€”'}`
                : `${lbl}: ${val}`;
            }
          }
        }
      },
      scales: {
        yRate: {
          position: 'left',
          min: 0,
          max: rateMax,
          title: { display: true, text: 'Mortality %' },
          ticks: { callback: v => `${v}%` }
        },
        yDays: {
          position: 'right',
          min: 0,
          suggestedMax: daysMax,
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Patient-Days' }
        }
      }
    }
  });


  // Ø¶Ø¹ Ù‡Ø°Ø§ Ø¨Ø¹Ø¯ ensureChart(...) Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹
try {
  const card = document.getElementById('monthlyMortalityCard');
  const chartWrap = card?.querySelector('.chart-wrap');
  const tableBlock = card?.querySelector('.overflow-auto'); // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆÙÙŠØ§Øª

  let formula = card?.querySelector('#mortalityFormula');
  if (!formula) {
    formula = document.createElement('p');
    formula.id = 'mortalityFormula';
    formula.className = 'text-xs opacity-80 mt-2';
    // Ø£Ø¯Ø®Ù„Ù‡Ø§ Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
    (tableBlock?.parentNode || card).insertBefore(formula, tableBlock || null);
  }

  // Ù†Øµ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
  formula.innerHTML = `
    <span class="badge badge-soft mr-2">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©</span>
    Ù†Ø³Ø¨Ø© ÙˆÙÙŠØ§Øª Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²Ø© (Ø´Ù‡Ø±ÙŠÙ‹Ø§) = 
    <strong>(Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙÙŠØ§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± Ã· Ù…Ø¬Ù…ÙˆØ¹ <em>Patient-Days</em> Ù„Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø±) Ã— 100</strong><br>
    <span class="opacity-70">
      Ù…Ù„Ø§Ø­Ø¸Ø©: <em>Patient-Days</em> ØªÙØ­Ø³Ø¨ Ø¨Ø¬Ù…Ø¹ Ø£ÙŠØ§Ù… Ø¥Ù‚Ø§Ù…Ø© ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø±
      Ù…Ø¹ <strong>Ø¬Ø¨Ø± Ø£ÙŠ Ø¬Ø²Ø¡ ÙŠÙˆÙ… Ø¥Ù„Ù‰ ÙŠÙˆÙ… ÙƒØ§Ù…Ù„</strong>.
    </span>
  `;
} catch(e) { /* no-op */ }

  // Ø¬Ø¯ÙˆÙ„ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø±Øª
  const tb = document.getElementById('mortalityTBody');
  if(!tb) return;
  if(!s.months.length){
    tb.innerHTML = `<tr><td colspan="4" class="text-center py-6 opacity-70">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
    return;
  }
  tb.innerHTML = s.months.map((m, i)=>{
const pd = s.patientDays[i] ?? 0;
const pdDisplay = Number.isFinite(pd) ? Math.round(pd) : pd; // Ø¹Ø±Ø¶ ÙƒØ¹Ø¯Ø¯ ØµØ­ÙŠØ­
    const dd = s.deaths[i] || 0;
    const rt = mortPct[i];
    const rowCls = i===maxIdx ? 'bg-error/20' : (i===minIdx ? 'bg-success/20' : '');
    const mark = i===maxIdx ? ' <i class="fa-solid fa-arrow-trend-up text-error"></i>'
              : i===minIdx ? ' <i class="fa-solid fa-arrow-trend-down text-success"></i>' : '';
    return `
      <tr class="${rowCls}">
        <td class="metric-number">${m}</td>
<td class="metric-number">${pdDisplay}</td>
        <td class="metric-number">${dd}</td>
        <td class="metric-number">${rt!=null ? rt.toFixed(1) + '%' : 'â€”'}${mark}</td>
      </tr>
    `;
  }).join("");
}


    /* =================== Charts =================== */
function ensureChart(id, cfg){
  const el = document.getElementById(id);
  if(!el) return; // canvas Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
  if(charts[id]) charts[id].destroy();
  charts[id] = new Chart(el, cfg);
}
    function topNCounts(rows, field, n=10){
      const map = new Map();
      for(const r of rows){ const k = (r[field] || "Active Cases").trim() || "Active Cases"; map.set(k, (map.get(k) || 0) + 1); }
      return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n);
    }
    function setChartFilter(desc, predicate){
      chartFilter = { label: desc, predicate };
      document.getElementById('chartFilterDesc').textContent = desc;
      document.getElementById('chartFilterBar').classList.remove('hidden');
      applyFilter();
      toast(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªØµÙÙŠØ©: ${desc}`, "success");
    }
    function clearChartFilter(){
      chartFilter = null;
      document.getElementById('chartFilterBar').classList.add('hidden');
      applyFilter();
    }

    function renderCharts(rows){
      // Gender donut
      const g = topNCounts(rows, "gender", 10);
      ensureChart("chartGender", {
        type: "doughnut",
        data: { labels: g.map(x=>x[0]), datasets: [{ data: g.map(x=>x[1]), backgroundColor: palette(g.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`Ø§Ù„Ø¬Ù†Ø³ = ${label}`, (r)=> (r.gender||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯") === label);
          }
        }
      });

      // Nationality Horizontal Top 10
      const n = topNCounts(rows, "nationality", 50).sort((a,b)=>b[1]-a[1]).slice(0,10);
      ensureChart("chartNationality", {
        type: "bar",
        data: { labels: n.map(x=>x[0]), datasets: [{ data: n.map(x=>x[1]), backgroundColor: palette(n.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, indexAxis:'y',
          plugins:{ legend:{ display:false } },
          scales:{ x:{ beginAtZero:true }, y:{ ticks:{ autoSkip:false } } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`Ø§Ù„Ø¬Ù†Ø³ÙŠÙ‘Ø© = ${label}`, (r)=> (r.nationality||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯") === label);
          }
        }
      });

      // Age bins
      const bins = [0,18,40,60,80,200], labels = ["<18","18-39","40-59","60-79","80+"], counts = [0,0,0,0,0];
      rows.forEach(r=>{ const a = r.age; if(a!=null && a>=0 && a<=150){ for(let i=0;i<bins.length-1;i++){ if(a>=bins[i] && a<bins[i+1]) { counts[i]++; break; } } } });
      ensureChart("chartAge", {
        type: "bar",
        data: { labels, datasets: [{ data: counts, backgroundColor: palette(counts.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            const low = bins[idx], high = bins[idx+1];
            setChartFilter(`Ø§Ù„Ø¹Ù…Ø± ${label}`, (r)=> r.age!=null && r.age>=low && r.age<high);
          }
        }
      });

      // Outcome Horizontal
      const o = topNCounts(rows, "outcome", 20).sort((a,b)=>b[1]-a[1]);
      ensureChart("chartOutcome", {
        type: "bar",
        data: { labels: o.map(x=>x[0]), datasets: [{ data: o.map(x=>x[1]), backgroundColor: palette(o.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`Outcome = ${label}`, (r)=> (r.outcome||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯") === label);
          }
        }
      });

      // Monthly admissions trend
      const monthMap = new Map();
      rows.forEach(r=>{ if(!r.adm) return; const key = dayjs(r.adm).format("YYYY-MM"); monthMap.set(key, (monthMap.get(key)||0)+1); });
      const months = [...monthMap.keys()].sort();
      ensureChart("chartMonthly", {
        type: "line",
        data: { labels: months, datasets: [{ data: months.map(m=>monthMap.get(m)), fill:false, tension:0.25 }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`Ø´Ù‡Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ = ${label}`, (r)=> r.adm && dayjs(r.adm).format("YYYY-MM") === label);
          }
        }
      });

      // LOS histogram
      const losBins = [0,1,3,7,14,1e9], losLabels = ["<1","1-3","3-7","7-14","14+"], losCounts = [0,0,0,0,0];
      rows.forEach(r=>{ const d = r.losDays; if(d!=null && d>=0){ for(let i=0;i<losBins.length-1;i++){ if(d>=losBins[i] && d<losBins[i+1]) { losCounts[i]++; break; } } } });
      ensureChart("chartLOS", {
        type: "bar",
        data: { labels: losLabels, datasets: [{ data: losCounts, backgroundColor: palette(losCounts.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            const low = losBins[idx], high = losBins[idx+1];
            setChartFilter(`LOS ${label} ÙŠÙˆÙ…`, (r)=> r.losDays!=null && r.losDays>=low && r.losDays<high);
          }
        }
      });

      // NEW: Daily admissions
      // DAILY: Admissions (Ø£Ø®Ø¶Ø±) + Census @ 00:00 (Ø£Ø²Ø±Ù‚) + ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ
// NEW: Daily admissions
// NEW: Daily admissions + census + total active (Ù…Ø¹ ØªÙ„ÙˆÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·)
const daily = buildDailySeries(rows);

// Ø£Ø¶Ù/Ø­Ø¯Ù‘Ø« Ø´Ø§Ø±Ø© Ø§Ù„Ù…ØªÙˆØ³Ø· ÙÙŠ Ù‡ÙŠØ¯Ø± Ø§Ù„ÙƒØ±Øª Ù†ÙØ³Ù‡
try{
  const header = document.querySelector('#chartDaily')?.closest('.chart-card')?.querySelector('.flex.items-center.justify-between.mb-2');
  if(header){
    let avgEl = header.querySelector('#dailyAvgInfo');
    if(!avgEl){
      avgEl = document.createElement('span');
      avgEl.id = 'dailyAvgInfo';
      avgEl.className = 'badge badge-soft';
      header.appendChild(avgEl);
    }
    if(daily.totalActiveAvg != null){
      avgEl.textContent = `Avg Total Active: ${daily.totalActiveAvg.toFixed(1)}`;
    }else{
      avgEl.textContent = `Avg Total Active: â€”`;
    }
  }
}catch(e){ /* no-op */ }

ensureChart("chartDaily", {
  type: "bar",
  data: {
    labels: daily.labels,
    datasets: [
      { label: "Admissions",      data: daily.admissions, backgroundColor: "hsl(160 70% 45%)" }, // Ø£Ø®Ø¶Ø±
{ label: "Census @ 23:59",  data: daily.census, backgroundColor: "hsl(210 70% 55%)" }
,      { label: "Total Active (24h)", data: daily.totalActive, backgroundColor: daily.totalActive.map(n => colorByAvgValue(n, daily.totalActiveAvg)) } // Ù…Ù„ÙˆÙ‘Ù† Ø­Ø³Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'bottom' } },
    scales: { y: { beginAtZero: true } },
onClick(evt, elements, chart){
  const pts = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
  if(!pts.length) return;
  const p = pts[0];
  const label = chart.data.labels[p.index];

  if(p.datasetIndex === 0){
    // Admissions
    setChartFilter(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„ = ${label}`, r => r.adm && dayjs(r.adm).isSame(label, 'day'));
  } else if(p.datasetIndex === 1){
    // Census @ 23:59
    const eod = dayjs(label).endOf('day').toDate();
    setChartFilter(`Ø­Ø§Ø¶Ø± Ø¹Ù†Ø¯ 23:59 ÙÙŠ ${label}`, r => r.adm && r.adm <= eod && (!r.dis || r.dis > eod));
} else {
  // Total Active (24h)
  const dayStart = dayjs(label).startOf('day').toDate();
  const dayEnd   = dayjs(label).endOf('day').toDate();
  setChartFilter(`Total Active (24h) ÙÙŠ ${label}`, r =>
    r.adm && r.adm <= dayEnd && (!r.dis || r.dis > dayStart)
  );
}

}
  }
});

// Ù…Ù‡Ù…: ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ (ÙŠØªØ¶Ù…Ù† Total Active)
renderCensusTable(daily);


    }

    /* =================== Table =================== */
    function renderTable(rows){
      const tb = document.getElementById('tableBody');
      tb.innerHTML = "";
      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="12" class="text-center py-8 opacity-70">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±</td></tr>`;
        return;
      }
      rows.forEach((r,idx)=>{
        const tr = document.createElement('tr');
        const shortDx = (r.dx || "").slice(0,120);
        tr.innerHTML = `
          <td class="metric-number">${idx+1}</td>
          <td>${r.name||"â€”"}</td>
          <td class="metric-number">${r.mrn||"â€”"}</td>
          <td class="metric-number">${r.age!=null?r.age:"â€”"}</td>
          <td>${r.gender||"â€”"}</td>
          <td>${r.nationality||"â€”"}</td>
          <td><span class="truncate-2 block max-w-72" title="${(r.dx||"").replace(/"/g,'&quot;')}">${shortDx}${r.dx && r.dx.length>120?'â€¦':''}</span></td>
          <td>${fmt(r.adm)}</td>
          <td>${fmt(r.dis)}</td>
          <td>${r.outcome||"â€”"}</td>
          <td class="metric-number">${r.losDays!=null? r.losDays.toFixed(1): "â€”"}</td>
          <td><button class="btn btn-xs btn-gradient" data-row="${idx}">Ø¹Ø±Ø¶</button></td>
        `;
        tb.appendChild(tr);
      });

      tb.querySelectorAll('button[data-row]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const r = rows[parseInt(e.currentTarget.getAttribute('data-row'))];
          openModal(r);
        });
      });
    }

    function openModal(r){
      document.getElementById('mName').textContent = r.name||"â€”";
      document.getElementById('mMRN').textContent = r.mrn||"â€”";
      document.getElementById('mAge').textContent = r.age!=null?r.age:"â€”";
      document.getElementById('mGender').textContent = r.gender||"â€”";
      document.getElementById('mNationality').textContent = r.nationality||"â€”";
      document.getElementById('mFinance').textContent = r.finance||"â€”";
      document.getElementById('mApache').textContent = r.apache!=null?r.apache:"â€”";
      document.getElementById('mAdm').textContent = fmt(r.adm);
      document.getElementById('mDis').textContent = fmt(r.dis);
      const now = new Date();
      const losShow = (r.dis && r.adm) ? r.losDays : (r.adm? daysBetween(r.adm, now): null);
      document.getElementById('mLOS').textContent = losShow!=null? losShow.toFixed(2)+" ÙŠÙˆÙ…":"â€”";
      document.getElementById('mFrom').textContent = r.from||"â€”";
      document.getElementById('mTo').textContent = r.to||"â€”";
      document.getElementById('mReason').textContent = r.reason||"â€”";
      document.getElementById('mDx').textContent = r.dx||"â€”";
      document.getElementById('mSpecIn').textContent = r.specIn||"â€”";
      document.getElementById('mNurseIn').textContent = r.nurseIn||"â€”";
      document.getElementById('mSpecOut').textContent = r.specOut||"â€”";
      document.getElementById('mNurseOut').textContent = r.nurseOut||"â€”";
      document.getElementById('mOutcome').textContent = r.outcome||"â€”";
      document.getElementById('detailModal').showModal();
    }

    /* =================== Export =================== */
    function exportCSV(rows){
      if(!rows.length){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±","error"); return; }
      const headers = [
        "Pt Name","Pt MRN","Pt Age","Gender","Nationality","Finance",
        "Date & Time of admission","Disposition from","Pt Diagnosis","APPACHE Score",
        "Specialist at admission","Nurse at admission","Date & Time of Discharge",
        "Specialist at discharge","Nurse at Discharge","Outcome","Disposition To",
        "Reason For Transfer","LOS (calc days)"
      ];
      const data = rows.map(r=>[
        r.name, r.mrn, r.age??"", r.gender, r.nationality, r.finance,
        fmt(r.adm), r.from, r.dx, r.apache??"",
        r.specIn, r.nurseIn, fmt(r.dis),
        r.specOut, r.nurseOut, r.outcome, r.to, r.reason,
        r.losDays!=null? r.losDays.toFixed(2):""
      ]);
      const csv = [headers.join(","), ...data.map(a=> a.map(x=>{
        const s = (x==null?"":String(x));
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(","))].join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "icu_filtered.csv"; a.click();
      URL.revokeObjectURL(url);
      toast("ØªÙ… ØªÙ†Ø²ÙŠÙ„ CSV Ø¨Ù†Ø¬Ø§Ø­","success");
    }

    /* =================== Init & Events =================== */
 async function init(){
  // Ù„Ùˆ Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ø±Ø§Ø¨Ø· CSVØŒ Ø³ÙŠØ¨ startIfAllowed ÙŠÙ†Ø§Ø¯ÙŠ init Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ù‚Ù†
  if (!(window.__CSV_URL || window.CSV_URL)) return;

  // Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§ØªØ­Ù…Ù‘Ù„Øª Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ Ù…Ø§ ØªØ¹ÙŠØ¯Ø´
  if (rawRows.length) return;
  try{
    const rows = await loadCSV();
    rawRows = transform(rows);

        // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§: Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ø²Ù…Ù†ÙŠ)
        document.getElementById('dateFrom').value = "";
        document.getElementById('dateTo').value   = "";
        document.getElementById('dateAdmission').checked = true;

        applyFilter();
        toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","success");
      }catch(err){
        console.error(err);
        toast("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ø´Ø¨ÙƒØ©","error");
      }
    }

    document.getElementById('btnRefresh').addEventListener('click', applyFilter);
    document.getElementById('btnExport').addEventListener('click', ()=> exportCSV(filteredRows));
    document.getElementById('searchBox').addEventListener('input', applyFilter);
    document.getElementById('dateAdmission').addEventListener('change', applyFilter);
    document.getElementById('dateDischarge').addEventListener('change', applyFilter);
    document.getElementById('btnClearChartFilter').addEventListener('click', clearChartFilter);

    function setRange(days){
      const now = dayjs();
      document.getElementById('dateTo').value = now.format("YYYY-MM-DD");
      document.getElementById('dateFrom').value = now.subtract(days,'day').format("YYYY-MM-DD");
      clearChartFilter(); // Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ ØªØªØ±Ø§ÙƒÙ…Ø´ Ø§Ù„ØªØµÙÙŠØ©
      applyFilter();
    }
    document.getElementById('btnLast7').addEventListener('click', ()=> setRange(7));
    document.getElementById('btnLast30').addEventListener('click', ()=> setRange(30));
    document.getElementById('btnQtr').addEventListener('click', ()=> setRange(90));
    document.getElementById('btnYTD').addEventListener('click', ()=>{
      const now = dayjs();
      document.getElementById('dateFrom').value = now.startOf('year').format("YYYY-MM-DD");
      document.getElementById('dateTo').value = now.format("YYYY-MM-DD");
      clearChartFilter();
      applyFilter();
    });
    document.getElementById('btnAll').addEventListener('click', ()=>{
      const dates = rawRows.map(r=>r[dateKind]).filter(Boolean).map(d=>dayjs(d));
      if(dates.length){
        const min = dayjs.min(dates).format("YYYY-MM-DD");
        const max = dayjs.max(dates).format("YYYY-MM-DD");
        document.getElementById('dateFrom').value = min;
        document.getElementById('dateTo').value = max;
      } else {
        document.getElementById('dateFrom').value = "";
        document.getElementById('dateTo').value = "";
      }
      clearChartFilter();
      applyFilter();
    });

    document.getElementById('btnToggleCharts').addEventListener('click', ()=>{
      chartsHidden = !chartsHidden;
      const sec = document.getElementById('chartsSection');
      if(chartsHidden){ sec.style.display = "none"; }
      else { sec.style.display = ""; renderCharts(filteredRows); }
    });

    // Resize charts on layout changes
    const ro = new ResizeObserver(() => { for (const id in charts) { try { charts[id]?.resize(); } catch(e){} } });
    ro.observe(document.getElementById('chartsSection'));

window.addEventListener('DOMContentLoaded', () => {
  // Ø´ØºÙ‘Ù„ init ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù€ CSV URL Ù…ØªØ§Ø­ (Ø­Ø§Ù„Ø© public/Ø¨Ø¯ÙˆÙ† Ù‚ÙÙ„)
  if (window.__CSV_URL || window.CSV_URL) init();
  // ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: startIfAllowed Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Ù‡ÙŠÙ†Ø§Ø¯ÙŠ init Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ­Ù‚Ù† __CSV_URL
});
  </script>
</body>
</html>
