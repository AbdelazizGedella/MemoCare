
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة العناية المركزة — ICU Analytics</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />

  <!-- Icons + Charts + CSV Parser + Day.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/minMax.js"></script>


  <!-- Google Font (اختياري) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>

    /* تثبيت أول عمود (يدعم RTL و LTR) */
.sticky-start {
  position: sticky;
  inset-inline-start: 0;         /* بدل left/right علشان يدعم RTL */
  z-index: 10;                   /* فوق بقية الخلايا */
  background: var(--glass);      /* نفس خلفية الـ glass */
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-inline-end: 1px solid var(--glass-bd); /* فاصل لطيف */
}

/* رأس العمود يحتاج Z-index أعلى شوية */
.sticky-start.is-head {
  z-index: 15;
}

/* عرض مريح لخلية العنوان */
.col-label {
  min-width: 9rem; /* ≈ w-36/40 */
}


    :root {
      --glass: rgba(255,255,255,0.06);
      --glass-bd: rgba(255,255,255,0.15);
      --grad-1: #0f172a;
      --grad-2: #0b2b40;
    }
    body {
      font-family: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(14,165,233,0.15), transparent 60%),
        linear-gradient(135deg, var(--grad-1), var(--grad-2));
      min-height: 100vh;
    }
    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-bd);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
    }
    .tile {
      background: linear-gradient(135deg, rgba(14,165,233,0.15), rgba(14,165,233,0.05));
      border: 1px solid rgba(14,165,233,0.25);
    }
    .metric-number { direction: ltr; font-variant-numeric: tabular-nums; }
    .btn-gradient { background: linear-gradient(135deg, #1e3a5f, #0f172a 60%, #0ea5e9); border: none; color: #fff; }
    .badge-soft { background: rgba(14,165,233,0.15); border: 1px solid rgba(14,165,233,0.35); color: #e5f6ff; }
    .table :where(th, td) { white-space: nowrap; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; }

    /* ثبّت ارتفاع بطاقات الرسوم */
    .chart-card { display:flex; flex-direction: column; }
    .chart-wrap { position: relative; width: 100%; height: 280px; }
    @media (min-width: 768px){ .chart-wrap{ height: 300px; } }
    @media (min-width: 1024px){ .chart-wrap{ height: 320px; } }
    .chart-wrap canvas{ position:absolute; inset:0; width:100% !important; height:100% !important; }
  </style>
</head>
<body class="text-slate-100">
  <!-- Header -->
  <header class="p-4 md:p-6">
    <div class="glass p-4 md:p-6 rounded-2xl flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl tile grid place-items-center">
          <i class="fa-solid fa-hospital text-xl"></i>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">لوحة العناية المركزة — ICU Dashboard</h1>
          <p class="opacity-70">تحليلات مباشرة من Google Sheets (بدون عرض أرقام الهواتف).</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnLast7"  class="btn btn-sm btn-gradient">آخر 7 أيام</button>
        <button id="btnLast30" class="btn btn-sm btn-gradient">آخر 30 يوم</button>
        <button id="btnQtr"    class="btn btn-sm btn-gradient">آخر 90 يوم</button>
        <button id="btnYTD"    class="btn btn-sm btn-outline">منذ بداية السنة</button>
        <button id="btnAll"    class="btn btn-sm btn-outline">الكل</button>
        <button id="btnToggleCharts" class="btn btn-sm btn-outline">إخفاء/إظهار الرسوم</button>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="px-4 md:px-6">
    <div class="glass p-4 md:p-6 rounded-2xl grid md:grid-cols-3 gap-4 items-end">
      <div>
        <label class="label"><span class="label-text">اختيار نوع التاريخ للتصفية</span></label>
        <div class="join">
          <input class="join-item btn btn-sm" type="radio" name="dateKind" id="dateAdmission" checked>
          <label for="dateAdmission" class="join-item btn btn-sm">الدخول</label>
          <input class="join-item btn btn-sm" type="radio" name="dateKind" id="dateDischarge">
          <label for="dateDischarge" class="join-item btn btn-sm">الخروج</label>
        </div>
      </div>
      <div>
        <label class="label"><span class="label-text">من تاريخ</span></label>
        <input id="dateFrom" type="date" class="input input-bordered w-full" />
      </div>
      <div>
        <label class="label"><span class="label-text">إلى تاريخ</span></label>
        <div class="flex gap-2">
          <input id="dateTo" type="date" class="input input-bordered w-full" />
          <button id="btnRefresh" class="btn btn-gradient">تحديث</button>
        </div>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="p-4 md:p-6">
    <div class="grid lg:grid-cols-5 md:grid-cols-3 grid-cols-2 gap-4">
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">إجمالي الحالات</div>
        <div id="kpiTotal" class="text-3xl font-bold metric-number">—</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">عدد الدخول</div>
        <div id="kpiAdmissions" class="text-3xl font-bold metric-number">—</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">عدد الخروج</div>
        <div id="kpiDischarges" class="text-3xl font-bold metric-number">—</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">متوسط/وسيط العمر</div>
        <div id="kpiAge" class="text-xl font-semibold metric-number">—</div>
      </div>
      <div class="glass p-4 rounded-2xl">
        <div class="text-sm opacity-80">متوسط/وسيط LOS (يوم)</div>
        <div id="kpiLOS" class="text-xl font-semibold metric-number">—</div>
      </div>
    </div>
  </section>

 


  <!-- Charts -->
  <section id="chartsSection" class="px-4 md:px-6">
    <div class="grid lg:grid-cols-4 md:grid-cols-2 gap-4">
      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">الجنس</h3>
          <span class="badge badge-soft">Distribution • اضغط للتصفية</span>
        </div>
        <div class="chart-wrap"><canvas id="chartGender"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">أكثر الجنسيات (Top 10)</h3>
          <span class="badge badge-soft">Counts • اضغط للتصفية</span>
        </div>
        <div class="chart-wrap"><canvas id="chartNationality"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">فئات العمر</h3>
          <span class="badge badge-soft">Histogram • اضغط للتصفية</span>
        </div>
        <div class="chart-wrap"><canvas id="chartAge"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">النتيجة النهائية (Outcome)</h3>
          <span class="badge badge-soft">Status • اضغط للتصفية</span>
        </div>
        <div class="chart-wrap"><canvas id="chartOutcome"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">الدخول حسب الشهر</h3>
          <span class="badge badge-soft">Trend • اضغط للتصفية</span>
        </div>
        <div class="chart-wrap"><canvas id="chartMonthly"></canvas></div>
      </div>

      <div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">توزيع مدة الإقامة LOS (أيام)</h3>
          <span class="badge badge-soft">Histogram • اضغط للتصفية</span>
        </div>
        <div class="chart-wrap"><canvas id="chartLOS"></canvas></div>
      </div>



<!-- Daily report table (Grid item spans full width) -->
<div class="glass p-4 md:p-6 rounded-2xl md:col-span-2 lg:col-span-4">
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-2">
      <i class="fa-solid fa-calendar-day"></i>
      <h3 class="font-semibold text-lg">التقرير اليومي — Admissions & Census</h3>
    </div>
  </div>
  <div class="overflow-auto">
    <table class="table table-zebra">
    <thead id="censusThead">
  <tr>
    <th>المؤشر</th>
  </tr>
</thead>

      <tbody id="censusTBody">
        <tr><td colspan="3" class="text-center py-6 opacity-70">—</td></tr>
      </tbody>
    </table>
  </div>
</div>



      <!-- جديد: دخول يومي -->
      <div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">الدخول اليومي (Admissions per day)</h3>
          <span class="badge badge-soft">Daily • اضغط للتصفية</span>
        </div>
        <div class="chart-wrap"><canvas id="chartDaily"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Chart filter badge -->
  <section class="px-4 md:px-6 mt-4">
    <div id="chartFilterBar" class="glass p-3 rounded-xl hidden items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="badge badge-soft">تصفية من رسم</span>
        <span id="chartFilterDesc" class="opacity-90"></span>
      </div>
      <button id="btnClearChartFilter" class="btn btn-xs btn-outline">مسح التصفية</button>
    </div>
  </section>

  <!-- ICU Mortality per 1,000 Patient-Days — Monthly -->
<div class="glass p-4 rounded-2xl chart-card md:col-span-2 lg:col-span-4" id="monthlyMortalityCard">
  <div class="flex items-center justify-between mb-2">
<h3 class="font-semibold">ICU Mortality % — شهريًا</h3>
    <span class="badge badge-soft">Per month • من أول حالة دخلت</span>
  </div>
  <div class="chart-wrap"><canvas id="chartMortality"></canvas></div>

  <div class="overflow-auto mt-4">
    <table class="table table-zebra">
      <thead>
        <tr>
          <th>Month</th>
          <th>Patient-Days</th>
          <th>Deaths</th>
<th>Mortality %</th>
        </tr>
      </thead>
      <tbody id="mortalityTBody">
        <tr><td colspan="4" class="text-center py-6 opacity-70">—</td></tr>
      </tbody>
    </table>
  </div>
</div>


  <!-- Table -->
  <section class="p-4 md:p-6">
    <div class="glass p-4 md:p-6 rounded-2xl">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-table"></i>
          <h3 class="font-semibold text-lg">كل الحالات (ضمن الإطار الزمني المحدد)</h3>
        </div>
        <div class="flex items-center gap-2">
          <input id="searchBox" type="text" placeholder="بحث بالاسم / التشخيص / MRN…" class="input input-bordered input-sm w-64" />
          <button id="btnExport" class="btn btn-sm btn-outline"><i class="fa-solid fa-file-arrow-down ml-2"></i>تصدير CSV (المرشّح)</button>
        </div>
      </div>

      <div class="overflow-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>#</th>
              <th>اسم المريض</th>
              <th>MRN</th>
              <th>العمر</th>
              <th>الجنس</th>
              <th>الجنسيّة</th>
              <th class="min-w-40">تشخيص مختصر</th>
              <th>تاريخ الدخول</th>
              <th>تاريخ الخروج</th>
              <th>Outcome</th>
              <th>LOS (يوم)</th>
              <th>تفاصيل</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="12" class="text-center py-8 opacity-70">جاري التحميل…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Summaries & Lists -->
  <section class="p-4 md:p-6 grid md:grid-cols-3 gap-4">
    <div class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">الحالات النشطة (لم تُغلق)</h3>
        <span id="activeCount" class="badge badge-soft">—</span>
      </div>
      <ul id="activeList" class="space-y-2 text-sm"></ul>
    </div>

    <div class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">قائمة الوفيات (Expired)</h3>
        <span id="expiredCount" class="badge badge-soft">—</span>
      </div>
      <ul id="expiredList" class="space-y-2 text-sm"></ul>
    </div>

    <div class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">المحوّلون (Transferred) & أسباب التحويل</h3>
        <span id="transferredCount" class="badge badge-soft">—</span>
      </div>
      <div id="transferReasons" class="text-sm space-y-1"></div>
    </div>
  </section>

  <!-- Modal -->
  <dialog id="detailModal" class="modal">
    <div class="modal-box max-w-4xl">
      <h3 class="font-bold text-xl mb-2"><i class="fa-solid fa-user ml-2"></i><span id="mName">—</span></h3>
      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <div class="glass p-3 rounded-xl">
          <div><span class="opacity-70">MRN:</span> <span id="mMRN" class="metric-number"></span></div>
          <div><span class="opacity-70">العمر:</span> <span id="mAge" class="metric-number"></span></div>
          <div><span class="opacity-70">الجنس:</span> <span id="mGender"></span></div>
          <div><span class="opacity-70">الجنسيّة:</span> <span id="mNationality"></span></div>
          <div><span class="opacity-70">التمويل:</span> <span id="mFinance"></span></div>
          <div><span class="opacity-70">APACHE:</span> <span id="mApache" class="metric-number"></span></div>
        </div>
        <div class="glass p-3 rounded-xl">
          <div><span class="opacity-70">الدخول:</span> <span id="mAdm"></span></div>
          <div><span class="opacity-70">الخروج:</span> <span id="mDis"></span></div>
          <div><span class="opacity-70">LOS:</span> <span id="mLOS"></span></div>
          <div><span class="opacity-70">جاء من:</span> <span id="mFrom"></span></div>
          <div><span class="opacity-70">تحويل إلى:</span> <span id="mTo"></span></div>
          <div><span class="opacity-70">سبب التحويل:</span> <span id="mReason"></span></div>
        </div>
      </div>

      <div class="mt-4">
        <div class="glass p-3 rounded-xl">
          <div class="font-semibold mb-2">التشخيص</div>
          <div id="mDx" class="truncate-2"></div>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm">
        <div class="glass p-3 rounded-xl">
          <div class="font-semibold mb-2">طاقم الدخول</div>
          <div>أخصائي: <span id="mSpecIn"></span></div>
          <div>ممرض: <span id="mNurseIn"></span></div>
        </div>
        <div class="glass p-3 rounded-xl">
          <div class="font-semibold mb-2">طاقم الخروج</div>
          <div>أخصائي: <span id="mSpecOut"></span></div>
          <div>ممرض: <span id="mNurseOut"></span></div>
          <div>Outcome: <span id="mOutcome"></span></div>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog">
          <button class="btn">إغلاق</button>
        </form>
      </div>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="toast toast-end z-50"></div>

  <script>
    dayjs.extend(dayjs_plugin_customParseFormat);
dayjs.extend(dayjs_plugin_minMax);

    /* =================== Config =================== */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRoux4qBcO7AVFBr2CyBnCsCChI-ZIdKP3pSUdZE9--GXbyCu7YvPeWDR2lmFJiLAxDrL_6EpOXp1nC/pub?gid=1847737330&single=true&output=csv";
    const COL = {
      name: "Pt Name", mrn: "Pt MRN", age: "Pt Age", gender: "Gender",
      nationality: "Nationality", finance: "Finance", phone: "Pt Phone",
      adm: "Date & Time of admission", from: "Disposition from", dx: "Pt Diagnosis",
      apache: "APPACHE Score", specIn: "Specialist at admission", nurseIn: "Nurse at admission",
      dis: "Date & Time of Discharge", specOut: "Specialist at discharge", nurseOut: "Nurse at Discharge",
      outcome: "Outcome", to: "Disposition To", reason: "Reason For Transfer", los: "LOS"
    };

    /* =================== State =================== */
    let rawRows = [];
    let filteredRows = [];
    let charts = {};
    let dateKind = "adm"; // adm or dis
    let chartsHidden = false;

    // تصفية قادمة من ضغط على رسم
    let chartFilter = null; // { type, label, predicate(row) }

    /* =================== Helpers =================== */

    // يحوّل نص الـ Outcome لفئة موحّدة

    // خلية جدول ببادج… ولو القيمة صفر يخلّيها فاضية
function tdBadge(n, classes){
  if(!n) return `<td></td>`; // بدون عرض صفر
  return `<td><span class="badge ${classes}">${n}</span></td>`;
}


function outcomeCat(s){
  const t = (s || "").toLowerCase().trim();
  if(!t) return null;
  if(t.includes("expir") || t.includes("death") || t.includes("وفاة") || t.includes("ميت")) return "expired";
  if(t.includes("transfer") || t.includes("محول")) return "transferred";
  if(t.includes("dama") || t.includes("against") || t.includes("ama") || t.includes("left") || t.includes("هروب")) return "dama";
  if(t.includes("improv") || t.includes("recover") || t.includes("home") || t.includes("تحسن")) return "improved";
  return "other";
}



    function normKey(k){
      return String(k||"").replace(/[\uFEFF\u00A0]/g,"").replace(/\s+/g," ").trim();
    }
    function getCell(row, key){
      const target = normKey(COL[key]);
      let v = row[target];
      if (v == null) for (const kk in row) if (normKey(kk) === target) { v = row[kk]; break; }
      return (v==null ? "" : String(v).trim());
    }

    // أرقام عربية -> لاتينية + ص/م -> AM/PM
    function toEnglishDigitsAndMeridiem(s){
      if(!s) return "";
      const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','٫':'.','٬':','};
      let out = String(s).replace(/[٠-٩٫٬]/g, ch => map[ch] ?? ch);
      out = out.replace(/\s*[صص]\.?/gi, ' AM').replace(/\s*[مم]\.?/gi, ' PM');
      out = out.replace(/صباحاً?|صباحا|صباح/gi, ' AM').replace(/مساءً?|مساء|المساء/gi, ' PM');
      return out.trim();
    }

    function parseDateFlexible(s){
      if(!s) return null;
      const t0 = toEnglishDigitsAndMeridiem(String(s).trim());
      if(!t0) return null;

      if(/^\d+(\.\d+)?$/.test(t0)){ // Excel serial
        const n = Number(t0);
        if(n > 20000 && n < 100000){ const base = Date.UTC(1899,11,30); return new Date(base + n * 86400000); }
      }
      if(/T|\d{4}-\d{2}-\d{2}/.test(t0)){ const d = dayjs(t0); if(d.isValid()) return d.toDate(); }

      const FMT = [
        "DD-MM-YYYY HH:mm","D-M-YYYY HH:mm","DD-MM-YYYY H:mm",
        "YYYY-MM-DD HH:mm","YYYY/MM/DD HH:mm","YYYY/M/D HH:mm",
        "DD/MM/YYYY HH:mm","D/M/YYYY HH:mm","DD/MM/YYYY H:mm",
        "MM/DD/YYYY HH:mm","M/D/YYYY HH:mm","MM/DD/YYYY h:mm A","M/D/YYYY h:mm A",
        "YYYY-MM-DDTHH:mm","YYYY-MM-DD","DD-MM-YYYY","MM-DD-YYYY","DD/MM/YYYY","MM/DD/YYYY",
        "h:mm:ss A YYYY/MM/DD","h:mm A YYYY/MM/DD","h:mm:ss A YYYY-M-D","h:mm A YYYY-M-D",
        "h:mm:ss A DD/MM/YYYY","h:mm A DD/MM/YYYY"
      ];
      for(const f of FMT){ const d = dayjs(t0, f, true); if(d.isValid()) return d.toDate(); }
      const d2 = new Date(t0);
      return isNaN(d2.getTime()) ? null : d2;
    }

    function fmt(dt){ if(!dt) return "—"; const d = dayjs(dt); return d.isValid()? d.format("YYYY-MM-DD HH:mm") : "—"; }
    function daysBetween(a,b){ if(!a||!b) return null; const ms=b.getTime()-a.getTime(); return ms<0?null: ms/86400000; }
    function num(v){ const n=parseFloat(String(v).replace(/[^\d.\-]/g,"")); return isNaN(n)?null:n; }
    function toast(msg, type="info"){
      const t = document.getElementById("toast");
      const el = document.createElement("div");
      el.className = `alert ${type==="success"?"alert-success":type==="error"?"alert-error":"alert-info"}`;
      el.innerHTML = `<span>${msg}</span>`;
      t.appendChild(el);
      setTimeout(()=> el.remove(), 4000);
    }
    function quantiles(arr){
      if(!arr.length) return {p50:null,p90:null};
      const a = [...arr].sort((x,y)=>x-y);
      const q = (p)=>{ const idx=(a.length-1)*p, lo=Math.floor(idx), hi=Math.ceil(idx); return lo===hi? a[lo] : a[lo]+(a[hi]-a[lo])*(idx-lo); };
      return {p50:q(0.5), p90:q(0.9)};
    }
    function avg(arr){ return arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : null; }
    function palette(n){ return Array.from({length:n}, (_,i)=>`hsl(${(i*47)%360} 70% 55%)`); }

// ألوان/كلاسات حسب متوسط "Total Active"
function classByAvg(n, avg){
  if(n == null) return '';
  if(n > avg * 1.15) return 'badge-error';    // أعلى بوضوح من المتوسط
  if(n >= avg * 0.85) return 'badge-warning'; // حول المتوسط
  return 'badge-success';                      // أقل من المتوسط
}
function badgeByAvg(n, avg){
  if(!n) return `<td></td>`;
  const cls = classByAvg(n, avg);
  return `<td><span class="badge ${cls}">${n}</span></td>`;
}
// ألوان للأعمدة داخل Chart.js
function colorByAvgValue(n, avg){
  if(n == null) return 'hsl(210 10% 35%)';
  if(n > avg * 1.15) return 'hsl(0 70% 55%)';    // أحمر
  if(n >= avg * 0.85) return 'hsl(40 85% 50%)';  // أصفر/برتقالي
  return 'hsl(160 70% 45%)';                     // أخضر
}


    /* =================== Load CSV =================== */
    async function loadCSV(){
      return new Promise((resolve,reject)=>{
        Papa.parse(CSV_URL, {
          download: true, header: true, skipEmptyLines: true,
          complete: (res)=>{
            resolve(res.data.map(r=>{
              const nr = {}; Object.keys(r).forEach(k=> nr[normKey(k)] = r[k]); return nr;
            }));
          },
          error: reject
        });
      });
    }

    /* =================== Transform =================== */
    function transform(rows){
      return rows.map((r,i)=>{
        const adm = parseDateFlexible(getCell(r,'adm'));
        const dis = parseDateFlexible(getCell(r,'dis'));
        const losDays = (dis && adm) ? daysBetween(adm, dis) : null;
        return {
          idx: i+1,
          name: getCell(r,'name'),
          mrn: getCell(r,'mrn'),
          age: num(getCell(r,'age')),
          gender: getCell(r,'gender'),
          nationality: getCell(r,'nationality'),
          finance: getCell(r,'finance'),
          adm, dis,
          from: getCell(r,'from'),
          dx: getCell(r,'dx'),
          apache: num(getCell(r,'apache')),
          specIn: getCell(r,'specIn'),
          nurseIn: getCell(r,'nurseIn'),
          specOut: getCell(r,'specOut'),
          nurseOut: getCell(r,'nurseOut'),
          outcome: getCell(r,'outcome'),
          to: getCell(r,'to'),
          reason: getCell(r,'reason'),
          losDays
        };
      });
    }

    /* =================== Derived & Lists =================== */
    function renderLists(rows){
      // Active: Outcome فاضي
      const active = rows.filter(r => !r.outcome || !r.outcome.trim());
      document.getElementById('activeCount').textContent = active.length;
      const now = new Date();
      const ulA = document.getElementById('activeList'); ulA.innerHTML = "";
      active.forEach((r, i)=>{
        const currentLOS = r.adm ? daysBetween(r.adm, now) : null;
        const li = document.createElement('li');
        li.className = "glass p-2 rounded-lg flex items-center justify-between";
        li.innerHTML = `
          <div class="min-w-0">
            <div class="font-semibold truncate">${r.name||"—"}</div>
            <div class="text-xs opacity-80">MRN: <span class="metric-number">${r.mrn||"—"}</span> • دخول: ${fmt(r.adm)} • LOS: ${currentLOS!=null?currentLOS.toFixed(1):"—"} يوم</div>
          </div>
          <button class="btn btn-xs btn-gradient" data-view="${i}">عرض</button>
        `;
        li.querySelector('button').addEventListener('click', ()=> openModal(r));
        ulA.appendChild(li);
      });

      // Expired
      const expired = rows.filter(r => (r.outcome||"").toLowerCase().includes("expired"));
      document.getElementById('expiredCount').textContent = expired.length;
      const ulE = document.getElementById('expiredList'); ulE.innerHTML = "";
      expired.forEach((r,i)=>{
        const li = document.createElement('li');
        li.className = "glass p-2 rounded-lg flex items-center justify-between";
        li.innerHTML = `
          <div class="min-w-0">
            <div class="font-semibold truncate">${r.name||"—"}</div>
            <div class="text-xs opacity-80">MRN: <span class="metric-number">${r.mrn||"—"}</span> • دخول: ${fmt(r.adm)} • خروج: ${fmt(r.dis)}</div>
          </div>
          <button class="btn btn-xs btn-gradient" data-view="${i}">عرض</button>
        `;
        li.querySelector('button').addEventListener('click', ()=> openModal(r));
        ulE.appendChild(li);
      });

      // Transferred + reasons
      const transferred = rows.filter(r => (r.outcome||"").toLowerCase().includes("transfer"));
      document.getElementById('transferredCount').textContent = transferred.length;
      const reasonsMap = new Map();
      transferred.forEach(r=>{
        const key = (r.reason||"غير مذكور").trim() || "غير مذكور";
        reasonsMap.set(key, (reasonsMap.get(key)||0)+1);
      });
      const reasons = [...reasonsMap.entries()].sort((a,b)=>b[1]-a[1]);
      const cont = document.getElementById('transferReasons');
      cont.innerHTML = reasons.length ? reasons.map(([k,v])=>`<div>• ${k} <span class="badge badge-soft ml-2">${v}</span></div>`).join("") : `<div class="opacity-70">لا توجد أسباب مسجلة.</div>`;
    }

    /* =================== Filtering =================== */
    function applyFilter(){
      const from = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value+" 00:00") : null;
      const to   = document.getElementById('dateTo').value   ? new Date(document.getElementById('dateTo').value+" 23:59") : null;
      dateKind = document.getElementById('dateDischarge').checked ? "dis" : "adm";
      const q = document.getElementById('searchBox').value.trim().toLowerCase();



      filteredRows = rawRows.filter(r=>{
        const refDate = r[dateKind];
        if(from && (!refDate || refDate < from)) return false;
        if(to && (!refDate || refDate > to)) return false;
        if(q){
          const hay = [r.name, r.mrn, r.dx, r.nationality, r.gender, r.outcome].join(" ").toLowerCase();
          if(!hay.includes(q)) return false;
        }
        if(chartFilter && chartFilter.predicate && !chartFilter.predicate(r)) return false;
        return true;
      });

      
renderKPIs(filteredRows);

// NEW: حدّث جدول التقرير اليومي دائمًا
renderCensusTable( buildDailySeries(filteredRows) );

if(!chartsHidden) renderCharts(filteredRows);
renderTable(filteredRows);

renderLists(filteredRows);
      renderMonthlyMortality(); // من أول حالة عبر rawRows

    }

    /* =================== KPIs =================== */
    function renderKPIs(rows){
      document.getElementById('kpiTotal').textContent = rows.length.toLocaleString('en-US');
      const admCount = rows.filter(r=> r.adm).length;
      const disCount = rows.filter(r=> r.dis).length;
      document.getElementById('kpiAdmissions').textContent = admCount.toLocaleString('en-US');
      document.getElementById('kpiDischarges').textContent = disCount.toLocaleString('en-US');

      const ages = rows.map(r=>r.age).filter(v=>v!=null && v>=0 && v<=120);
      const {p50:ageMed} = quantiles(ages); const ageAvg = avg(ages);
      document.getElementById('kpiAge').textContent = (ageAvg!=null?ageAvg.toFixed(1):"—") + " / " + (ageMed!=null?ageMed.toFixed(0):"—");

      const los = rows.map(r=>r.losDays).filter(v=>v!=null && v>=0 && isFinite(v));
      const {p50:losMed} = quantiles(los); const losAvg = avg(los);
      document.getElementById('kpiLOS').textContent = (losAvg!=null?losAvg.toFixed(1):"—") + " / " + (losMed!=null?losMed.toFixed(1):"—");
    }


    // يبني سلاسل admissions و census@00:00 على مدى الإطار المختار
// يبني سلاسل admissions و census@00:00 + تفصيل الخروج حسب الفئات لكل يوم
function buildDailySeries(rows){
  const fromVal = document.getElementById('dateFrom').value;
  const toVal   = document.getElementById('dateTo').value;

  let start;
  if (fromVal) start = dayjs(fromVal).startOf('day');
  else {
    const adms = rows.map(r=>r.adm).filter(Boolean).map(d=>dayjs(d));
    start = adms.length ? dayjs.min(adms).startOf('day') : dayjs().startOf('day');
  }

  let end;
  if (toVal) end = dayjs(toVal).startOf('day');
  else {
    const allDates = rows.flatMap(r=>[r.adm, r.dis].filter(Boolean)).map(d=>dayjs(d));
    const maxSeen = allDates.length ? dayjs.max(allDates) : dayjs();
    const hasActive = rows.some(r=>!r.dis);
    end = (hasActive && dayjs().isAfter(maxSeen)) ? dayjs().startOf('day') : maxSeen.startOf('day');
  }

  const labels = [];
  const admissions = [];
  const census = [];
  const disAll = [];
  const disImproved = [];
  const disDAMA = [];
  const disTransferred = [];
  const disExpired = [];

  for(let d = start; !d.isAfter(end); d = d.add(1,'day')){
    const mid = d.startOf('day').toDate(); // 00:00

    const admCnt = rows.filter(r => r.adm && dayjs(r.adm).isSame(d, 'day')).length;
    const cenCnt = rows.filter(r => r.adm && r.adm <= mid && (!r.dis || r.dis > mid)).length;

    const sameDayDis = rows.filter(r => r.dis && dayjs(r.dis).isSame(d,'day'));
    const allCnt = sameDayDis.length;

    let imp=0, dama=0, trans=0, exp=0;
    sameDayDis.forEach(r=>{
      switch (outcomeCat(r.outcome)) {
        case "improved":     imp++; break;
        case "dama":         dama++; break;
        case "transferred":  trans++; break;
        case "expired":      exp++; break;
      }
    });

    labels.push(d.format('YYYY-MM-DD'));
    admissions.push(admCnt);
    census.push(cenCnt);
    disAll.push(allCnt);
    disImproved.push(imp);
    disDAMA.push(dama);
    disTransferred.push(trans);
    disExpired.push(exp);
  }

  const totalActive = admissions.map((v,i) => v + census[i]);
  const totalActiveAvg = avg(totalActive);

  return {
    labels, admissions, census,
    disAll, disImproved, disDAMA, disTransferred, disExpired,
    totalActive, totalActiveAvg
  };
}
// يرسم جدول التقرير اليومي
// يرسم "التقرير اليومي" بشكل أفقي:
// الأعمدة = التواريخ، والصفوف = Admissions و Census @ 00:00
// يرسم "التقرير اليومي" بشكل أفقي:
// الأعمدة = التواريخ، والصفوف = Admissions / Census / Discharges (+ تفصيلها)
// يرسم "التقرير اليومي" أفقيًا: الأعمدة = التواريخ
// الصفوف (بالترتيب): Census @ 00:00 (مميّز) → Admissions → Discharges + التفصيل
function renderCensusTable(series){
  const thead = document.getElementById('censusThead');
  const tbody = document.getElementById('censusTBody');
  if(!thead || !tbody) return;

  if(!series.labels.length){
    thead.innerHTML = `<tr><th>المؤشر</th></tr>`;
    tbody.innerHTML = `<tr><td colspan="2" class="text-center py-6 opacity-70">لا توجد بيانات ضمن الإطار المختار</td></tr>`;
    return;
  }

  // العناوين (التواريخ)
  let headHTML = `<tr><th class="sticky-start is-head col-label">المؤشر</th>`;
  for(const d of series.labels){
    headHTML += `<th class="metric-number">${d}</th>`;
  }
  headHTML += `</tr>`;
  thead.innerHTML = headHTML;

  // 1) Census @ 00:00
  let rowCensus = `<tr><td class="sticky-start col-label"><span class="badge badge-secondary gap-2">
    <i class="fa-regular fa-clock"></i> Census @ 00:00
  </span></td>`;
  for(const n of series.census){
    rowCensus += tdBadge(n, 'badge-secondary');
  }
  rowCensus += `</tr>`;

  // 1.5) NEW: Total Active (24h) = Admissions + Census @ 00:00 (مُلوّن حسب المتوسط)
  const avgTA = series.totalActiveAvg ?? (series.totalActive?.length ? avg(series.totalActive) : null);
  let rowTA = `<tr><td class="sticky-start col-label">
    <span class="badge badge-accent gap-2"><i class="fa-solid fa-bolt"></i> Total Active (24h)</span>
    ${avgTA!=null ? `<span class="badge badge-soft ml-2">Avg ${avgTA.toFixed(1)}</span>` : ``}
  </td>`;
  for(const n of series.totalActive || []){
    rowTA += badgeByAvg(n, avgTA ?? 0);
  }
  rowTA += `</tr>`;

  // 2) Admissions
  let rowAdmissions = `<tr><td class="sticky-start col-label">Admissions</td>`;
  for(const n of series.admissions){
    rowAdmissions += tdBadge(n, 'badge-success');
  }
  rowAdmissions += `</tr>`;

  // 3) Discharges (All)
  let rowDisAll = `<tr><td class="sticky-start col-label">Discharges (All)</td>`;
  for(const n of (series.disAll || [])){
    rowDisAll += tdBadge(n, 'badge-neutral');
  }
  rowDisAll += `</tr>`;

  // 4) Improved
  let rowImp = `<tr><td class="sticky-start col-label">Improved</td>`;
  for(const n of (series.disImproved || [])){
    rowImp += tdBadge(n, 'badge-primary');
  }
  rowImp += `</tr>`;

  // 5) DAMA
  let rowDama = `<tr><td class="sticky-start col-label">DAMA</td>`;
  for(const n of (series.disDAMA || [])){
    rowDama += tdBadge(n, 'badge-warning');
  }
  rowDama += `</tr>`;

  // 6) Transferred
  let rowTrans = `<tr><td class="sticky-start col-label">Transferred</td>`;
  for(const n of (series.disTransferred || [])){
    rowTrans += tdBadge(n, 'badge-info');
  }
  rowTrans += `</tr>`;

  // 7) Expired
  let rowExp = `<tr><td class="sticky-start col-label">Expired</td>`;
  for(const n of (series.disExpired || [])){
    rowExp += tdBadge(n, 'badge-error');
  }
  rowExp += `</tr>`;

  // الترتيب: Census → Total Active → Admissions → ...
tbody.innerHTML = rowTA + rowCensus + rowAdmissions + rowDisAll + rowImp + rowDama + rowTrans + rowExp;
}

// يبني سلاسل شهرية: Patient-Days و Deaths و Mortality/1000
// ملاحظة: يحسب من أول حالة في "كل البيانات" rawRows وليس ضمن الفلتر.
function buildMonthlyMortalityFromAllData(){
  const rows = rawRows; // من أول حالة
  if(!rows?.length) return { months:[], patientDays:[], deaths:[], mortality:[] };

  // نافذة التحليل: من أول Admission مرصود لأي مريض، إلى آخر تاريخ خروج أو اليوم لو في حالات نشطة
  const allAdms = rows.map(r=>r.adm).filter(Boolean).map(d=>dayjs(d));
  if(!allAdms.length) return { months:[], patientDays:[], deaths:[], mortality:[] };

  const start = dayjs.min(allAdms).startOf('day');
  const allDates = rows.flatMap(r=>[r.adm, r.dis].filter(Boolean)).map(d=>dayjs(d));
  const maxSeen = allDates.length ? dayjs.max(allDates) : dayjs();
  const hasActive = rows.some(r=>!r.dis);
  const end = (hasActive && dayjs().isAfter(maxSeen)) ? dayjs().endOf('day') : maxSeen.endOf('day');

  const daysMap = new Map();   // YYYY-MM -> patient-days (float)
  const deathMap = new Map();  // YYYY-MM -> integer

  // توزيع زمن كل مريض على الشهور (مع احتساب الأجزاء)
  for(const r of rows){
    if(!r.adm) continue;
    const s = dayjs.max(dayjs(r.adm), start);
    const e = r.dis ? dayjs.min(dayjs(r.dis), end) : end;
    if(!e.isAfter(s)) continue;

    let cur = s;
    while(cur.isBefore(e)){
      const monthEnd = dayjs.min(e, cur.endOf('month'));
      const d = (monthEnd.valueOf() - cur.valueOf()) / 86400000; // أيام (كسور)
      const key = cur.format('YYYY-MM');
      daysMap.set(key, (daysMap.get(key) || 0) + d);
      cur = monthEnd.add(1, 'second');
    }
  }

  // الوفيات حسب شهر الخروج لو Outcome = Expired
  for(const r of rows){
    if(r.dis && outcomeCat(r.outcome) === 'expired'){
      const key = dayjs(r.dis).format('YYYY-MM');
      deathMap.set(key, (deathMap.get(key) || 0) + 1);
    }
  }

  const months = Array.from(new Set([...daysMap.keys(), ...deathMap.keys()])).sort();
  const patientDays = months.map(m => daysMap.get(m) || 0);
  const deaths      = months.map(m => deathMap.get(m) || 0);
  const mortality   = months.map((_,i) => patientDays[i] > 0 ? (deaths[i] / patientDays[i]) * 1000 : null);

  return { months, patientDays, deaths, mortality };
}

// يرسم كارت الوفيات شهريًا كنسبة % مع تمييز أعلى/أقل قيمة + تلوين صفوف الجدول
// ICU Mortality % (من أول حالة) مع مقياس مضبوط يظهر القيم 2–5%
function renderMonthlyMortality(){
  const s = buildMonthlyMortalityFromAllData();

  // إلى نسبة مئوية: لكل 1000 → ×0.1
  const mortPct = s.mortality.map(v => v != null ? +(v * 0.1).toFixed(2) : null);

  // أعلى/أقل قيمة صالحة
  const pairs = mortPct.map((v,i)=>({v,i})).filter(p=>p.v!=null);
  const maxIdx = pairs.length ? pairs.reduce((a,b)=> b.v>a.v?b:a).i : -1;
  const minIdx = pairs.length ? pairs.reduce((a,b)=> b.v<a.v?b:a).i : -1;

  // مقاييس ذكية: وسّع 20% فوق الأعلى
  const rateMax = Math.max(1, Math.ceil((Math.max(...mortPct.filter(v=>v!=null), 0) * 1.2)));
  const daysMax = Math.ceil((Math.max(...s.patientDays, 0) * 1.2));

  const pointRadius = mortPct.map((_,i)=> (i===maxIdx||i===minIdx) ? 6 : 3);
  const pointBackgroundColor = mortPct.map((_,i)=>{
    if(i===maxIdx) return 'hsl(0 70% 55%)';    // أعلى: أحمر
    if(i===minIdx) return 'hsl(160 70% 45%)';  // أقل: أخضر
    return undefined;
  });

  ensureChart("chartMortality", {
    type: "bar",
    data: {
      labels: s.months,
      datasets: [
        {
          type: "bar",
          label: "Patient-Days",
          data: s.patientDays.map(x => x != null ? +x.toFixed(2) : null),
          yAxisID: "yDays",
          backgroundColor: "hsl(210 70% 55%)"
        },
        {
          type: "line",
          label: "Mortality %",
          data: mortPct,
          yAxisID: "yRate",
          tension: 0.25,
          spanGaps: true,
          pointRadius,
          pointBackgroundColor,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      // مهم: خليه يفسّر الأرقام كما هي
      parsing: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label(ctx){
              const lbl = ctx.dataset.label || '';
              const val = ctx.parsed.y;
              return ctx.dataset.yAxisID === 'yRate'
                ? `${lbl}: ${val != null ? val.toFixed(1) + '%' : '—'}`
                : `${lbl}: ${val}`;
            }
          }
        }
      },
      scales: {
        yRate: {
          position: 'left',
          min: 0,
          max: rateMax,                // <-- هنا المشكلة كانت
          title: { display: true, text: 'Mortality %' },
          ticks: { callback: v => `${v}%` }
        },
        yDays: {
          position: 'right',
          min: 0,
          suggestedMax: daysMax,
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Patient-Days' }
        }
      }
    }
  });

  // جدول أسفل الشارت
  const tb = document.getElementById('mortalityTBody');
  if(!tb) return;
  if(!s.months.length){
    tb.innerHTML = `<tr><td colspan="4" class="text-center py-6 opacity-70">لا توجد بيانات</td></tr>`;
    return;
  }
  tb.innerHTML = s.months.map((m, i)=>{
    const pd = s.patientDays[i] || 0;
    const dd = s.deaths[i] || 0;
    const rt = mortPct[i];
    const rowCls = i===maxIdx ? 'bg-error/20' : (i===minIdx ? 'bg-success/20' : '');
    const mark = i===maxIdx ? ' <i class="fa-solid fa-arrow-trend-up text-error"></i>'
              : i===minIdx ? ' <i class="fa-solid fa-arrow-trend-down text-success"></i>' : '';
    return `
      <tr class="${rowCls}">
        <td class="metric-number">${m}</td>
        <td class="metric-number">${pd.toFixed(2)}</td>
        <td class="metric-number">${dd}</td>
        <td class="metric-number">${rt!=null ? rt.toFixed(1) + '%' : '—'}${mark}</td>
      </tr>
    `;
  }).join("");
}


    /* =================== Charts =================== */
function ensureChart(id, cfg){
  const el = document.getElementById(id);
  if(!el) return; // canvas مش موجود
  if(charts[id]) charts[id].destroy();
  charts[id] = new Chart(el, cfg);
}
    function topNCounts(rows, field, n=10){
      const map = new Map();
      for(const r of rows){ const k = (r[field] || "غير محدد").trim() || "غير محدد"; map.set(k, (map.get(k) || 0) + 1); }
      return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n);
    }
    function setChartFilter(desc, predicate){
      chartFilter = { label: desc, predicate };
      document.getElementById('chartFilterDesc').textContent = desc;
      document.getElementById('chartFilterBar').classList.remove('hidden');
      applyFilter();
      toast(`تم تطبيق تصفية: ${desc}`, "success");
    }
    function clearChartFilter(){
      chartFilter = null;
      document.getElementById('chartFilterBar').classList.add('hidden');
      applyFilter();
    }

    function renderCharts(rows){
      // Gender donut
      const g = topNCounts(rows, "gender", 10);
      ensureChart("chartGender", {
        type: "doughnut",
        data: { labels: g.map(x=>x[0]), datasets: [{ data: g.map(x=>x[1]), backgroundColor: palette(g.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`الجنس = ${label}`, (r)=> (r.gender||"غير محدد") === label);
          }
        }
      });

      // Nationality Horizontal Top 10
      const n = topNCounts(rows, "nationality", 50).sort((a,b)=>b[1]-a[1]).slice(0,10);
      ensureChart("chartNationality", {
        type: "bar",
        data: { labels: n.map(x=>x[0]), datasets: [{ data: n.map(x=>x[1]), backgroundColor: palette(n.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, indexAxis:'y',
          plugins:{ legend:{ display:false } },
          scales:{ x:{ beginAtZero:true }, y:{ ticks:{ autoSkip:false } } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`الجنسيّة = ${label}`, (r)=> (r.nationality||"غير محدد") === label);
          }
        }
      });

      // Age bins
      const bins = [0,18,40,60,80,200], labels = ["<18","18-39","40-59","60-79","80+"], counts = [0,0,0,0,0];
      rows.forEach(r=>{ const a = r.age; if(a!=null && a>=0 && a<=150){ for(let i=0;i<bins.length-1;i++){ if(a>=bins[i] && a<bins[i+1]) { counts[i]++; break; } } } });
      ensureChart("chartAge", {
        type: "bar",
        data: { labels, datasets: [{ data: counts, backgroundColor: palette(counts.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            const low = bins[idx], high = bins[idx+1];
            setChartFilter(`العمر ${label}`, (r)=> r.age!=null && r.age>=low && r.age<high);
          }
        }
      });

      // Outcome Horizontal
      const o = topNCounts(rows, "outcome", 20).sort((a,b)=>b[1]-a[1]);
      ensureChart("chartOutcome", {
        type: "bar",
        data: { labels: o.map(x=>x[0]), datasets: [{ data: o.map(x=>x[1]), backgroundColor: palette(o.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`Outcome = ${label}`, (r)=> (r.outcome||"غير محدد") === label);
          }
        }
      });

      // Monthly admissions trend
      const monthMap = new Map();
      rows.forEach(r=>{ if(!r.adm) return; const key = dayjs(r.adm).format("YYYY-MM"); monthMap.set(key, (monthMap.get(key)||0)+1); });
      const months = [...monthMap.keys()].sort();
      ensureChart("chartMonthly", {
        type: "line",
        data: { labels: months, datasets: [{ data: months.map(m=>monthMap.get(m)), fill:false, tension:0.25 }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            setChartFilter(`شهر الدخول = ${label}`, (r)=> r.adm && dayjs(r.adm).format("YYYY-MM") === label);
          }
        }
      });

      // LOS histogram
      const losBins = [0,1,3,7,14,1e9], losLabels = ["<1","1-3","3-7","7-14","14+"], losCounts = [0,0,0,0,0];
      rows.forEach(r=>{ const d = r.losDays; if(d!=null && d>=0){ for(let i=0;i<losBins.length-1;i++){ if(d>=losBins[i] && d<losBins[i+1]) { losCounts[i]++; break; } } } });
      ensureChart("chartLOS", {
        type: "bar",
        data: { labels: losLabels, datasets: [{ data: losCounts, backgroundColor: palette(losCounts.length) }] },
        options: {
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } },
          onClick(evt, elements, chart){
            const p = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
            if(!p.length) return; const idx = p[0].index; const label = chart.data.labels[idx];
            const low = losBins[idx], high = losBins[idx+1];
            setChartFilter(`LOS ${label} يوم`, (r)=> r.losDays!=null && r.losDays>=low && r.losDays<high);
          }
        }
      });

      // NEW: Daily admissions
      // DAILY: Admissions (أخضر) + Census @ 00:00 (أزرق) + تحديث جدول التقرير اليومي
// NEW: Daily admissions
// NEW: Daily admissions + census + total active (مع تلوين حسب المتوسط)
const daily = buildDailySeries(rows);

// أضف/حدّث شارة المتوسط في هيدر الكرت نفسه
try{
  const header = document.querySelector('#chartDaily')?.closest('.chart-card')?.querySelector('.flex.items-center.justify-between.mb-2');
  if(header){
    let avgEl = header.querySelector('#dailyAvgInfo');
    if(!avgEl){
      avgEl = document.createElement('span');
      avgEl.id = 'dailyAvgInfo';
      avgEl.className = 'badge badge-soft';
      header.appendChild(avgEl);
    }
    if(daily.totalActiveAvg != null){
      avgEl.textContent = `Avg Total Active: ${daily.totalActiveAvg.toFixed(1)}`;
    }else{
      avgEl.textContent = `Avg Total Active: —`;
    }
  }
}catch(e){ /* no-op */ }

ensureChart("chartDaily", {
  type: "bar",
  data: {
    labels: daily.labels,
    datasets: [
      { label: "Admissions",      data: daily.admissions, backgroundColor: "hsl(160 70% 45%)" }, // أخضر
      { label: "Census @ 00:00",  data: daily.census,     backgroundColor: "hsl(210 70% 55%)" }, // أزرق
      { label: "Total Active (24h)", data: daily.totalActive, backgroundColor: daily.totalActive.map(n => colorByAvgValue(n, daily.totalActiveAvg)) } // ملوّن حسب المتوسط
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'bottom' } },
    scales: { y: { beginAtZero: true } },
    onClick(evt, elements, chart){
      const pts = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
      if(!pts.length) return;
      const p = pts[0];
      const label = chart.data.labels[p.index];
      const mid = dayjs(label).startOf('day').toDate();

      if(p.datasetIndex === 0){
        // Admissions
        setChartFilter(`تاريخ الدخول = ${label}`, r => r.adm && dayjs(r.adm).isSame(label, 'day'));
      } else if(p.datasetIndex === 1){
        // Census @ 00:00
        setChartFilter(`حاضر عند 00:00 في ${label}`, r => r.adm && r.adm <= mid && (!r.dis || r.dis > mid));
      } else {
        // Total Active (24h) = Admissions + Census@00:00
        setChartFilter(`Total Active (24h) في ${label}`, r =>
          (r.adm && dayjs(r.adm).isSame(label, 'day')) ||
          (r.adm && r.adm <= mid && (!r.dis || r.dis > mid))
        );
      }
    }
  }
});

// مهم: تحديث جدول التقرير اليومي (يتضمن Total Active)
renderCensusTable(daily);


    }

    /* =================== Table =================== */
    function renderTable(rows){
      const tb = document.getElementById('tableBody');
      tb.innerHTML = "";
      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="12" class="text-center py-8 opacity-70">لا توجد بيانات ضمن الإطار المختار</td></tr>`;
        return;
      }
      rows.forEach((r,idx)=>{
        const tr = document.createElement('tr');
        const shortDx = (r.dx || "").slice(0,120);
        tr.innerHTML = `
          <td class="metric-number">${idx+1}</td>
          <td>${r.name||"—"}</td>
          <td class="metric-number">${r.mrn||"—"}</td>
          <td class="metric-number">${r.age!=null?r.age:"—"}</td>
          <td>${r.gender||"—"}</td>
          <td>${r.nationality||"—"}</td>
          <td><span class="truncate-2 block max-w-72" title="${(r.dx||"").replace(/"/g,'&quot;')}">${shortDx}${r.dx && r.dx.length>120?'…':''}</span></td>
          <td>${fmt(r.adm)}</td>
          <td>${fmt(r.dis)}</td>
          <td>${r.outcome||"—"}</td>
          <td class="metric-number">${r.losDays!=null? r.losDays.toFixed(1): "—"}</td>
          <td><button class="btn btn-xs btn-gradient" data-row="${idx}">عرض</button></td>
        `;
        tb.appendChild(tr);
      });

      tb.querySelectorAll('button[data-row]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const r = rows[parseInt(e.currentTarget.getAttribute('data-row'))];
          openModal(r);
        });
      });
    }

    function openModal(r){
      document.getElementById('mName').textContent = r.name||"—";
      document.getElementById('mMRN').textContent = r.mrn||"—";
      document.getElementById('mAge').textContent = r.age!=null?r.age:"—";
      document.getElementById('mGender').textContent = r.gender||"—";
      document.getElementById('mNationality').textContent = r.nationality||"—";
      document.getElementById('mFinance').textContent = r.finance||"—";
      document.getElementById('mApache').textContent = r.apache!=null?r.apache:"—";
      document.getElementById('mAdm').textContent = fmt(r.adm);
      document.getElementById('mDis').textContent = fmt(r.dis);
      const now = new Date();
      const losShow = (r.dis && r.adm) ? r.losDays : (r.adm? daysBetween(r.adm, now): null);
      document.getElementById('mLOS').textContent = losShow!=null? losShow.toFixed(2)+" يوم":"—";
      document.getElementById('mFrom').textContent = r.from||"—";
      document.getElementById('mTo').textContent = r.to||"—";
      document.getElementById('mReason').textContent = r.reason||"—";
      document.getElementById('mDx').textContent = r.dx||"—";
      document.getElementById('mSpecIn').textContent = r.specIn||"—";
      document.getElementById('mNurseIn').textContent = r.nurseIn||"—";
      document.getElementById('mSpecOut').textContent = r.specOut||"—";
      document.getElementById('mNurseOut').textContent = r.nurseOut||"—";
      document.getElementById('mOutcome').textContent = r.outcome||"—";
      document.getElementById('detailModal').showModal();
    }

    /* =================== Export =================== */
    function exportCSV(rows){
      if(!rows.length){ toast("لا يوجد بيانات للتصدير","error"); return; }
      const headers = [
        "Pt Name","Pt MRN","Pt Age","Gender","Nationality","Finance",
        "Date & Time of admission","Disposition from","Pt Diagnosis","APPACHE Score",
        "Specialist at admission","Nurse at admission","Date & Time of Discharge",
        "Specialist at discharge","Nurse at Discharge","Outcome","Disposition To",
        "Reason For Transfer","LOS (calc days)"
      ];
      const data = rows.map(r=>[
        r.name, r.mrn, r.age??"", r.gender, r.nationality, r.finance,
        fmt(r.adm), r.from, r.dx, r.apache??"",
        r.specIn, r.nurseIn, fmt(r.dis),
        r.specOut, r.nurseOut, r.outcome, r.to, r.reason,
        r.losDays!=null? r.losDays.toFixed(2):""
      ]);
      const csv = [headers.join(","), ...data.map(a=> a.map(x=>{
        const s = (x==null?"":String(x));
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(","))].join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "icu_filtered.csv"; a.click();
      URL.revokeObjectURL(url);
      toast("تم تنزيل CSV بنجاح","success");
    }

    /* =================== Init & Events =================== */
    async function init(){
      try{
        const rows = await loadCSV();
        rawRows = transform(rows);

        // افتراضيًا: عرض كل البيانات (بدون فلتر زمني)
        document.getElementById('dateFrom').value = "";
        document.getElementById('dateTo').value   = "";
        document.getElementById('dateAdmission').checked = true;

        applyFilter();
        toast("تم تحميل البيانات","success");
      }catch(err){
        console.error(err);
        toast("تعذّر تحميل الملف — تأكد من الرابط أو الشبكة","error");
      }
    }

    document.getElementById('btnRefresh').addEventListener('click', applyFilter);
    document.getElementById('btnExport').addEventListener('click', ()=> exportCSV(filteredRows));
    document.getElementById('searchBox').addEventListener('input', applyFilter);
    document.getElementById('dateAdmission').addEventListener('change', applyFilter);
    document.getElementById('dateDischarge').addEventListener('change', applyFilter);
    document.getElementById('btnClearChartFilter').addEventListener('click', clearChartFilter);

    function setRange(days){
      const now = dayjs();
      document.getElementById('dateTo').value = now.format("YYYY-MM-DD");
      document.getElementById('dateFrom').value = now.subtract(days,'day').format("YYYY-MM-DD");
      clearChartFilter(); // علشان ما تتراكمش التصفية
      applyFilter();
    }
    document.getElementById('btnLast7').addEventListener('click', ()=> setRange(7));
    document.getElementById('btnLast30').addEventListener('click', ()=> setRange(30));
    document.getElementById('btnQtr').addEventListener('click', ()=> setRange(90));
    document.getElementById('btnYTD').addEventListener('click', ()=>{
      const now = dayjs();
      document.getElementById('dateFrom').value = now.startOf('year').format("YYYY-MM-DD");
      document.getElementById('dateTo').value = now.format("YYYY-MM-DD");
      clearChartFilter();
      applyFilter();
    });
    document.getElementById('btnAll').addEventListener('click', ()=>{
      const dates = rawRows.map(r=>r[dateKind]).filter(Boolean).map(d=>dayjs(d));
      if(dates.length){
        const min = dayjs.min(dates).format("YYYY-MM-DD");
        const max = dayjs.max(dates).format("YYYY-MM-DD");
        document.getElementById('dateFrom').value = min;
        document.getElementById('dateTo').value = max;
      } else {
        document.getElementById('dateFrom').value = "";
        document.getElementById('dateTo').value = "";
      }
      clearChartFilter();
      applyFilter();
    });

    document.getElementById('btnToggleCharts').addEventListener('click', ()=>{
      chartsHidden = !chartsHidden;
      const sec = document.getElementById('chartsSection');
      if(chartsHidden){ sec.style.display = "none"; }
      else { sec.style.display = ""; renderCharts(filteredRows); }
    });

    // Resize charts on layout changes
    const ro = new ResizeObserver(() => { for (const id in charts) { try { charts[id]?.resize(); } catch(e){} } });
    ro.observe(document.getElementById('chartsSection'));

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
