<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Records</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { background:#0b1e3b; color:#fff; font-family:Arial,sans-serif; padding:20px; }
    h1 { text-align:center; color:#22d3ee; }
    .upload-box { text-align:center; margin-bottom:20px; }
    input[type=file],button {
      background:#1e3a8a; padding:10px 15px; border-radius:8px; color:#fff;
      cursor:pointer; border:none; margin:5px;
    }
    .date-block { background:#1e293b; margin:15px 0; padding:10px; border-radius:12px; }
    .date-title { font-size:18px; font-weight:bold; margin-bottom:5px; color:#0ea5e9; cursor:pointer; }
    .patient-list { display:none; margin-top:10px; }
    .patient-card { background:#334155; padding:10px; margin:5px 0; border-radius:8px; cursor:pointer; }
    .patient-card:hover { background:#475569; }
    .details { display:none; margin-top:10px; }
    h3 { margin:10px 0; color:#22d3ee; }
    table { width:100%; border-collapse:collapse; background:#1e293b; margin-bottom:10px; }
    th,td { border:1px solid #334155; padding:6px; font-size:13px; }
    th { background:#0ea5e9; color:#fff; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; margin-left:5px; font-size:12px; font-weight:bold; }
    .badge-yellow { background:#facc15; color:#000; }
    .badge-green { background:#22c55e; color:#000; }
    .badge-pink { background:#ec4899; color:#fff; }
    .badge-blue { background:#38bdf8; color:#000; }
  </style>
</head>
<body>
  <h1>Patient Records</h1>
  <div class="upload-box">
    <input type="file" id="fileInput" accept=".xls,.xlsx" />
  </div>

  <div id="records"></div>

  <script>
    document.getElementById("fileInput").addEventListener("change", handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        displayByDate(rows);
      };
      reader.readAsArrayBuffer(file);
    }

    // Excel date → DD/MM/YYYY
    function excelDateToJSDate(serial) {
      if (!serial) return "";
      if (typeof serial === "string") return serial;
      const utc_days = Math.floor(serial - 25569);
      const utc_value = utc_days * 86400;
      const date_info = new Date(utc_value * 1000);
      const day = String(date_info.getUTCDate()).padStart(2,"0");
      const month = String(date_info.getUTCMonth()+1).padStart(2,"0");
      const year = date_info.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }

    function normalizeKey(key){ return key.toLowerCase().replace(/\s+/g,""); }

    function displayByDate(data) {
      const container = document.getElementById("records");
      container.innerHTML = "";

      const grouped = {};
      data.forEach(row => {
        const keys = Object.keys(row);
        const map = {};
        keys.forEach(k => map[normalizeKey(k)] = row[k]);

        const rawDate = map["service"];
        const date = (typeof rawDate === "number" && rawDate>40000) ? excelDateToJSDate(rawDate) : rawDate;

        const medno = map["medno"] || "Unknown";
        if (!grouped[date]) grouped[date] = {};
        if (!grouped[date][medno]) grouped[date][medno] = { info: map, records: [] };
        grouped[date][medno].records.push(map);
      });

      Object.keys(grouped).sort().forEach(date => {
        const patients = Object.values(grouped[date]);
        const dateBlock = document.createElement("div");
        dateBlock.className = "date-block";

        const title = document.createElement("div");
        title.className = "date-title";
        title.innerText = `📅 ${date} — ${patients.length} Cases`;
        const patientList = document.createElement("div");
        patientList.className = "patient-list";

        title.onclick = () => {
          patientList.style.display = patientList.style.display === "none" ? "block" : "none";
        };

        patients.forEach(patient => {
          const card = document.createElement("div");
          card.className = "patient-card";

          // حساب الإجماليات
          let totalPat=0, totalComp=0, medsPat=0, medsComp=0, supPat=0, supComp=0, servPat=0, servComp=0;
          patient.records.forEach(rec=>{
            const pat = parseFloat(rec["patpart"]||0);
            const comp = parseFloat(rec["comppart"]||0);
            const code = (rec["proc"]||"").toString();

            totalPat+=pat; totalComp+=comp;
            if(code.startsWith("12")){ medsPat+=pat; medsComp+=comp; }
            else if(code.startsWith("02")||code.startsWith("2")){ supPat+=pat; supComp+=comp; }
            else { servPat+=pat; servComp+=comp; }
          });

          card.innerHTML = `
            <div>
              <span class="badge badge-yellow">👤 ${totalPat.toFixed(2)}</span>
              <span class="badge badge-green">🏥 ${totalComp.toFixed(2)}</span>
              <strong>${patient.info["patname"]||"Unknown"}</strong> (MRN: ${patient.info["medno"]||""})
              ${medsPat+medsComp>0 ? `<span class="badge badge-pink">💊 ${(medsPat+medsComp).toFixed(2)}</span>`:""}
              ${supPat+supComp>0 ? `<span class="badge badge-blue">📦 ${(supPat+supComp).toFixed(2)}</span>`:""}
              ${servPat+servComp>0 ? `<span class="badge badge-green">🛠 ${(servPat+servComp).toFixed(2)}</span>`:""}
              <button onclick="exportPatient(${JSON.stringify(patient.records).replace(/"/g,'&quot;')})">⬇ Export</button>
            </div>
          `;

          const details = document.createElement("div");
          details.className = "details";

          const meds = patient.records.filter(r=> (r["proc"]||"").toString().startsWith("12"));
          const sups = patient.records.filter(r=> (r["proc"]||"").toString().startsWith("02") || (r["proc"]||"").toString().startsWith("2"));
          const servs = patient.records.filter(r=> !((r["proc"]||"").toString().startsWith("12")||(r["proc"]||"").toString().startsWith("02")||(r["proc"]||"").toString().startsWith("2")));

          if(meds.length) details.innerHTML += renderTable("💊 Medications", meds);
          if(sups.length) details.innerHTML += renderTable("📦 Supplies", sups);
          if(servs.length) details.innerHTML += renderTable("🛠 Services", servs);

          card.onclick = (ev) => {
            if(ev.target.tagName==="BUTTON") return; // avoid toggle when clicking export
            details.style.display = details.style.display === "none" ? "block" : "none";
          };

          card.appendChild(details);
          patientList.appendChild(card);
        });

        dateBlock.appendChild(title);
        dateBlock.appendChild(patientList);
        container.appendChild(dateBlock);
      });
    }

    function renderTable(title,records){
      let html = `<h3>${title}</h3><table><tr>`;
      Object.keys(records[0]).forEach(k=> html+=`<th>${k}</th>`);
      html+="</tr>";
      records.forEach(rec=>{
        html+="<tr>";
        Object.values(rec).forEach(v=> html+=`<td>${v}</td>`);
        html+="</tr>";
      });
      html+="</table>";
      return html;
    }

function exportPatient(records){
  if (!records.length) return;
  const wb = XLSX.utils.book_new();

  const meds = records.filter(r=> (r["proc"]||"").toString().startsWith("12"));
  const sups = records.filter(r=> (r["proc"]||"").toString().startsWith("02")||(r["proc"]||"").toString().startsWith("2"));
  const servs = records.filter(r=> !((r["proc"]||"").toString().startsWith("12")||(r["proc"]||"").toString().startsWith("02")||(r["proc"]||"").toString().startsWith("2")));

  if(meds.length){ XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(meds),"Medications"); }
  if(sups.length){ XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(sups),"Supplies"); }
  if(servs.length){ XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(servs),"Services"); }

  // 🟡 استخراج اسم المريض و MRN
  const patName = records[0]["patname"] || "Patient";
  const mrn = records[0]["medno"] || "Unknown";
  const safeName = patName.replace(/[^a-zA-Z0-9\u0600-\u06FF]+/g,"_"); // يمنع رموز غريبة في الاسم

  XLSX.writeFile(wb, `${safeName}_MRN_${mrn}.xlsx`);
}

  </script>
</body>
</html>
