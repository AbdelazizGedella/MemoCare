<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø±ØµØ¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</title>
  <meta name="color-scheme" content="dark light" />
  <!-- SheetJS (XLS/XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1e3b; --card:#102a56; --muted:#9cb4e8; --text:#fff; --acc:#19c8a7; --chip:#13376b;
      --shadow:0 12px 35px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:"Cairo",system-ui,sans-serif; background:linear-gradient(135deg,#0a1a3f,#0b1e3b); color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(11,30,59,.9),rgba(11,30,59,.65));border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0;font-size:clamp(18px,3.2vw,26px)} .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field{background:var(--card);border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow)}
    .btn{cursor:pointer;border:none;padding:10px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(135deg,#19c8a7,#2f7cf0);color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:#fff}
    .btn.small{padding:6px 10px;border-radius:10px;font-weight:600}
    .filters input,.filters select{appearance:none;background:var(--card);border:1px solid rgba(255,255,255,.08);color:#fff;padding:9px 12px;border-radius:12px}
    .stats{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .stat-chip{background:var(--chip);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08)}
    main{max-width:1200px;margin:26px auto 100px;padding:0 18px}
    .date-group{margin-bottom:24px}
    .date-hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:14px;cursor:pointer}
    .date-hd h2{margin:0;font-size:18px}
    .patients{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;margin-top:12px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .card .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .name{font-weight:800;font-size:16px}.medno{color:var(--muted);font-size:12px}.icons{display:flex;gap:6px;font-size:20px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}.chip{background:var(--chip);border:1px solid rgba(255,255,255,.08);padding:4px 8px;border-radius:999px;font-size:12px;color:#dbe7ff}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:rgba(0,0,0,.12);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:rgba(255,255,255,.06);font-size:12px;text-align:right;padding:8px;color:#cfe0ff}
    tbody td{padding:8px;border-top:1px dashed rgba(255,255,255,.08);font-size:13px}
    .muted{color:var(--muted)} .pill{padding:3px 7px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12)}
    .loader{display:none;gap:10px;align-items:center;color:var(--muted)} .loader.spin .dot{width:8px;height:8px;border-radius:50%;background:var(--acc);animation:b 1s infinite alternate} .loader.spin .dot:nth-child(2){animation-delay:.15s} .loader.spin .dot:nth-child(3){animation-delay:.3s} @keyframes b{to{transform:translateY(-4px);opacity:.6}}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50}
    .modal.show{display:flex}
    .modal .box{width:min(1000px,95vw);max-height:80vh;overflow:auto;background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .modal .hd{display:flex;justify-content:space-between;align-items:center;gap:10px;position:sticky;top:0;background:linear-gradient(180deg,rgba(16,42,86,.98),rgba(16,42,86,.9));border-bottom:1px solid rgba(255,255,255,.08);padding:10px 6px;z-index:2}
    .section{margin:12px 0} .section h3{margin:.2rem 0 .4rem;font-size:15px}
    .modal .ft{display:flex;gap:8px;justify-content:flex-start;padding:8px 0}
    .date-hd .chev{transition:transform .2s ease} .date-group.open .chev{transform:rotate(90deg)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:flex-start;gap:14px">
        <div>
          <h1>Ù…Ø±ØµØ¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h1>
          <div class="sub">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª (XLS) + Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© (XLSX) â† Ø§Ù„Ø¹Ø±Ø¶ Ù…ÙØ±ØªÙ‘Ø¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª. ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§: <b>DD-MM-YYYY</b>.</div>
        </div>
        <div class="loader" id="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span> <span>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦</span></div>
      </div>
      <div class="row" style="margin-top:12px">
        <label class="field">Ø§Ù„Ù…Ù„Ù (1): Patient Services by Doctor (Inc-Pkg) Excel.xls<br><input id="fileMain" type="file" accept=".xls,.xlsx"/></label>
        <label class="field">Ø§Ù„Ù…Ù„Ù (2): Disposables Consumables Quantity Deduction (XLSX)<br><input id="fileFree" type="file" accept=".xlsx,.xls"/></label>
        <button class="btn primary" id="btnParse">ØªØ­Ù„ÙŠÙ„ ÙˆØ¹Ø±Ø¶</button>
        <button class="btn ghost" id="btnReset" title="Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„">Ù…Ø³Ø­</button>
        <button class="btn ghost" id="btnExportView" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ø¥Ù„Ù‰ Excel">ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© (Excel)</button>
      </div>
      <div class="filters" style="margin-top:10px">
        <input id="q" type="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù"/>
        <label>Ù…Ù† <input id="from" type="date"></label>
        <label>Ø¥Ù„Ù‰ <input id="to" type="date"></label>
        <select id="sort"><option value="desc">ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ§Ø±ÙŠØ®: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option><option value="asc">ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ§Ø±ÙŠØ®: Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option></select>
        <button class="btn small ghost" id="applyFilters">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>
      <div class="stats" style="margin-top:10px">
        <span class="stat-chip" id="statDates">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: â€”</span>
        <span class="stat-chip" id="statPatients">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª: â€”</span>
        <span class="stat-chip" id="statFree">ØµÙÙˆÙ FREE Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: â€”</span>
      </div>
    </div>
  </header>
  <main id="app"></main>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="hd">
        <div style="display:flex;flex-direction:column;gap:2px">
          <div id="modalTitle" class="name">â€”</div>
          <div id="modalSub" class="medno muted">â€”</div>
        </div>
        <div class="ft">
          <button class="btn small ghost" id="btnModalExport">ØªØ­Ù…ÙŠÙ„ (Excel)</button>
          <button class="btn small" style="background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff" id="btnModalClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
        </div>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <div class="wrap muted" style="opacity:.8;margin-bottom:24px">â—ï¸Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ <b>Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª</b> ÙƒØ£Ø³Ø§Ø³ Ù„Ù„ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø±ÙŠØ¶. Ù„Ø§ Ù†Ù†Ø´Ø¦ Ø¨Ø·Ø§Ù‚Ø§Øª "Free ÙÙ‚Ø·" Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨Ø¯ÙˆÙ† Ø®Ø¯Ù…Ø§ØªØŒ Ù„ÙƒÙ† Ù†Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© (Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… + ØªÙˆØ§Ø±ÙŠØ® Ø£Ø®Ø±Ù‰) Ø¯Ø§Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©.</div>

<script>
const $$ = sel => document.querySelector(sel);
const pad2 = n => (n<10? '0'+n: ''+n);
const toDDMMYYYY = (d) => `${pad2(d.getDate())}-${pad2(d.getMonth()+1)}-${d.getFullYear()}`;
const fromInputDate = (str) => { if(!str) return null; const [y,m,d]=str.split('-').map(Number); return new Date(y,(m||1)-1,d||1); };
const norm = (s) => (s==null? '': String(s).replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim().toLowerCase());
const cleanStr = (s) => (s==null? '': String(s).trim());

function parseExcelDate(v){
  if(v==null || v==='') return null;
  if(typeof v==="number"){ const o = XLSX.SSF.parse_date_code(v); if(!o) return null; return new Date(o.y,o.m-1,o.d); }
  if(v instanceof Date) return v;
  const s = String(v).trim();
  const dm = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/); if(dm){ let [_,d,m,y]=dm; d=+d; m=+m; y=+y; if(y<100) y+=2000; return new Date(y,m-1,d); }
  const ym = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/); if(ym){ let [_,y,m,d]=ym; return new Date(+y,+m-1,+d); }
  const t = Date.parse(s); return isNaN(t)? null : new Date(t);
}

function guessHeaders(rows){ const headers = rows[0]||[]; const all = headers.map((h,i)=>({i,raw:h,k:norm(h)}));
  return {headers,all, findAll:(key)=> all.filter(x=>x.k===key).map(x=>x.i), findOne:(key)=>{ const m=all.find(x=>x.k===key); return m? m.i : -1; } };
}

function parseMain(workbook){
  const ws = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:"",blankrows:false});
  if(!rows.length) return [];
  const H = guessHeaders(rows);
  const idxMedno=H.findOne('medno'), idxName=H.findOne('patname');
  const idxIns  = (H.findAll('ins')[0] ?? -1);
  const idxServiceDate=H.findOne('service');
  const idxQty=H.findOne('qty');
  const idxSectionDesc=H.findOne('sectiondesc');
  const pidx=H.findAll('proc'); const idxProcCode=pidx[0]??-1, idxProcName=pidx[1]??-1;
  const out=[];
  for(let r=1;r<rows.length;r++){
    const row=rows[r]||[]; const medno=cleanStr(row[idxMedno]); if(!medno) continue;
    const patname=cleanStr(row[idxName]); const ins=cleanStr(row[idxIns]);
    const d=parseExcelDate(row[idxServiceDate]); if(!d) continue; const dateStr=toDDMMYYYY(d);
    const code=cleanStr(row[idxProcCode]); const sname=idxProcName>-1? cleanStr(row[idxProcName]):'';
    const qty=Number(row[idxQty]||0)||0; const sectionDesc=cleanStr(row[idxSectionDesc]);
    let bucket='service'; if(/^12/.test(code)) bucket='med'; else if(/^2/.test(code)) bucket='supply';
    out.push({dateStr,date:d,medno,patname,ins,code,sname,qty,sectionDesc,bucket});
  }
  return out;
}

// Read ALL rows from Free (keep rows even if date is missing)
function parseFreeAll(workbook){
  const ws = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:"",blankrows:false});
  if(!rows.length) return [];
  const H = guessHeaders(rows);
  const idxPatientCode=H.findOne('patient code');
  const idxPatientEname=H.findOne('patientename');
  const idxServiceCode=H.findOne('servicecode');
  const idxServiceEname=H.findOne('serviceename');
  const idxServiceDate=H.findOne('service date');
  const idxSectionName=H.findOne('sectionname');
  const idxItemCode=H.findOne('itemcode');
  const idxItemName=H.findOne('itemname');
  const idxIssuedQty=H.findOne('issuedqty');
  const idxUnchargedQty=H.findOne('unchargedqty');
  const idxStoreCode=H.findOne('storecode');
  const idxStoreName=H.findOne('storename');
  const idxStaffCode=H.findOne('staffcode');
  const idxEmpName=H.findOne('empname');
  const out=[];
  for(let r=1;r<rows.length;r++){
    const row=rows[r]||[]; const medno=cleanStr(row[idxPatientCode]); if(!medno) continue;
    const patname=cleanStr(row[idxPatientEname]);
    const d=parseExcelDate(row[idxServiceDate]); const dateStr=d? toDDMMYYYY(d):'';
    out.push({dateStr,date:d||null,medno,patname,
      serviceCode:cleanStr(row[idxServiceCode]), serviceName:cleanStr(row[idxServiceEname]),
      sectionName:cleanStr(row[idxSectionName]), itemCode:cleanStr(row[idxItemCode]), itemName:cleanStr(row[idxItemName]),
      issuedQty:Number(row[idxIssuedQty]||0)||0, unchargedQty:Number(row[idxUnchargedQty]||0)||0,
      storeCode:cleanStr(row[idxStoreCode]), storeName:cleanStr(row[idxStoreName]), staffCode:cleanStr(row[idxStaffCode]), empName:cleanStr(row[idxEmpName])});
  }
  return out;
}

function buildGroups(mainRows, freeRows){
  const map=new Map();
  for(const r of mainRows){ let dm=map.get(r.dateStr); if(!dm){dm=new Map();map.set(r.dateStr,dm);} let p=dm.get(r.medno);
    if(!p){ p={medno:r.medno,patname:r.patname||'',ins:r.ins||'',hasMed:false,hasSupply:false,hasService:false,hasFree:false,sections:new Set(),services:[],free:[]}; dm.set(r.medno,p); }
    if(r.bucket==='med') p.hasMed=true; else if(r.bucket==='supply') p.hasSupply=true; else p.hasService=true;
    if(r.sectionDesc) p.sections.add(r.sectionDesc);
    p.services.push({dateStr:r.dateStr,code:r.code,name:r.sname,qty:r.qty,section:r.sectionDesc,type:r.bucket});
  }
  for(const fr of freeRows){ const dm=map.get(fr.dateStr); if(!dm) continue; const p=dm.get(fr.medno); if(!p) continue; p.hasFree=true; p.free.push(fr);} // attach same-date only
  return map; // Map<dateStr, Map<medno, patientSummary>>
}

function groupFreeByMed(freeRows){ const m=new Map(); for(const fr of freeRows){ if(!m.has(fr.medno)) m.set(fr.medno,[]); m.get(fr.medno).push(fr);} return m; }

function render(map, opts={}){
  const q=norm(opts.q||''); const dFrom=opts.from? toDDMMYYYY(opts.from):null; const dTo=opts.to? toDDMMYYYY(opts.to):null; const sort=opts.sort||'desc';
  const app=$$('#app'); app.innerHTML='';
  let dates=Array.from(map.keys()); dates.sort((a,b)=>{const pa=a.split('-').reverse().join('-'); const pb=b.split('-').reverse().join('-'); return (sort==='asc'?1:-1)* (pa>pb?1:pa<pb?-1:0);});
  if(dFrom||dTo){ dates=dates.filter(d=>{const as=d.split('-').reverse().join('-'); if(dFrom){const fs=dFrom.split('-').reverse().join('-'); if(as<fs) return false;} if(dTo){const ts=dTo.split('-').reverse().join('-'); if(as>ts) return false;} return true;}); }
  let totalCards=0;
  for(const dateStr of dates){ const pm=map.get(dateStr); let patients=Array.from(pm.values()); if(q){patients=patients.filter(p=> norm(p.patname).includes(q)||norm(p.medno).includes(q));}
    if(!patients.length) continue; totalCards+=patients.length; const grp=document.createElement('section'); grp.className='date-group';
    grp.innerHTML=`<div class="date-hd"><h2 style="display:flex;align-items:center;gap:8px"><span class="chev">â–¶</span> Ø§Ù„ØªØ§Ø±ÙŠØ®: <span class="pill">${dateStr}</span></h2><div class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${patients.length}</div></div><div class="patients" style="display:none"></div>`;
    const container=grp.querySelector('.patients'); const hd=grp.querySelector('.date-hd'); hd.addEventListener('click',()=>{const open=container.style.display==='none'; container.style.display=open?'grid':'none'; grp.classList.toggle('open',open);});
    patients.sort((a,b)=> a.patname.localeCompare(b.patname,'ar'));
    for(const p of patients){ const hasFreeElse=(STATE.freeByMed.get(p.medno)?.length||0)>0; const icons=[ p.hasMed?'ğŸ’Š':'', p.hasSupply?'ğŸ“¦':'', p.hasService?'ğŸ› ï¸':'', (p.hasFree||hasFreeElse)?'ğŸ†“':'' ].filter(Boolean).join(' ');
      const sectionList=Array.from(p.sections); const sectionsHtml=sectionList.length? sectionList.map(s=>`<span class="chip">${s}</span>`).join(' '):'<span class="muted">(Ù„Ø§ Ø£Ù‚Ø³Ø§Ù… Ù…Ø³Ø¬Ù„Ø©)</span>';
      const card=document.createElement('article'); card.className='card';
      card.innerHTML=`<div class="top"><div><div class="name">${p.patname||'â€”'}</div><div class="medno">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${p.medno}</div></div><div class="icons" title="Ø¯Ù„Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰">${icons||'â€”'}</div></div><div class="chips" style="margin-top:6px"><span class="chip">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${p.ins||'â€”'}</span>${sectionsHtml}</div><div style="margin-top:10px"><button class="btn small primary" data-action="open-modal">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button></div>`;
      card.querySelector('[data-action="open-modal"]').addEventListener('click',()=> openModal(dateStr,p)); container.appendChild(card);
    }
    app.appendChild(grp);
  }
  $$('#statDates').textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: ${dates.length}`; $$('#statPatients').textContent=`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª: ${totalCards}`; $$('#statFree').textContent=`ØµÙÙˆÙ FREE Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: ${STATE.rawFree.length}`;
}

let STATE={map:null,rawMain:[],rawFree:[],freeByMed:new Map()}; let CURRENT_MODAL={dateStr:null,patient:null};
async function readFileAsArrayBuffer(file){ return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(file);}); }
async function handleParse(){ const fMain=$$('#fileMain').files[0]; const fFree=$$('#fileFree').files[0]; if(!fMain){alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª (XLS)');return;} $$('#loader').classList.add('spin'); $$('#loader').style.display='flex';
  try{ const wbMain=XLSX.read(await readFileAsArrayBuffer(fMain),{type:'array'}); const mainRows=parseMain(wbMain);
    let freeRows=[]; if(fFree){ const wbFree=XLSX.read(await readFileAsArrayBuffer(fFree),{type:'array'}); freeRows=parseFreeAll(wbFree); }
    STATE.rawMain=mainRows; STATE.rawFree=freeRows; STATE.freeByMed=groupFreeByMed(freeRows); STATE.map=buildGroups(mainRows,freeRows); applyFilters();
  }catch(err){ console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰.'); }
  finally{ $$('#loader').classList.remove('spin'); $$('#loader').style.display='none'; }
}
function applyFilters(){ if(!STATE.map){ $$('#app').innerHTML='<div class="muted">â€” Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ â€”</div>'; return;} const opts={ q: $$('#q').value, from: fromInputDate($$('#from').value), to: fromInputDate($$('#to').value), sort: $$('#sort').value }; render(STATE.map,opts); }
function resetAll(){ $$('#fileMain').value=''; $$('#fileFree').value=''; $$('#q').value=''; $$('#from').value=''; $$('#to').value=''; $$('#sort').value='desc'; STATE={map:null,rawMain:[],rawFree:[],freeByMed:new Map()}; $$('#app').innerHTML=''; $$('#statDates').textContent='Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: â€”'; $$('#statPatients').textContent='Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª: â€”'; $$('#statFree').textContent='ØµÙÙˆÙ FREE Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: â€”'; }

function groupByType(p){ const meds=[],supplies=[],services=[]; for(const s of p.services){ if(s.type==='med') meds.push(s); else if(s.type==='supply') supplies.push(s); else services.push(s);} return {meds,supplies,services,free:p.free||[]}; }
function buildTableHtml(rows, headers){ if(!rows.length) return '<div class=\'muted\'>(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª)</div>'; const thead='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>'; const body='<tbody>'+rows.map(r=>`<tr>${Object.values(r).map(v=>`<td>${v??'â€”'}</td>`).join('')}</tr>`).join('')+'</tbody>'; return `<table>${thead}${body}</table>`; }
function openModal(dateStr,p){ CURRENT_MODAL={dateStr,patient:p}; $$('#modalTitle').textContent=p.patname||'â€”'; $$('#modalSub').textContent=`Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${p.medno} â€” Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`; const {meds,supplies,services,free}=groupByType(p);
  const freeAll=STATE.freeByMed.get(p.medno)||[]; const freeSame=(free&&free.length)? free : freeAll.filter(f=> f.dateStr===dateStr); const freeOther=freeAll.filter(f=> f.dateStr!==dateStr);
  const medsRows=meds.map(x=>({'Ø§Ù„ØªØ§Ø±ÙŠØ®':x.dateStr,'Ø§Ù„ÙƒÙˆØ¯':x.code,'Ø§Ù„Ø®Ø¯Ù…Ø©':x.name,'Ø§Ù„ÙƒÙ…ÙŠØ©':x.qty,'Ø§Ù„Ù‚Ø³Ù…':x.section}));
  const supRows =supplies.map(x=>({'Ø§Ù„ØªØ§Ø±ÙŠØ®':x.dateStr,'Ø§Ù„ÙƒÙˆØ¯':x.code,'Ø§Ù„Ø®Ø¯Ù…Ø©':x.name,'Ø§Ù„ÙƒÙ…ÙŠØ©':x.qty,'Ø§Ù„Ù‚Ø³Ù…':x.section}));
  const srvRows =services.map(x=>({'Ø§Ù„ØªØ§Ø±ÙŠØ®':x.dateStr,'Ø§Ù„ÙƒÙˆØ¯':x.code,'Ø§Ù„Ø®Ø¯Ù…Ø©':x.name,'Ø§Ù„ÙƒÙ…ÙŠØ©':x.qty,'Ø§Ù„Ù‚Ø³Ù…':x.section}));
  const freeRowsSame = freeSame.map(f=>({'Ø§Ù„ØªØ§Ø±ÙŠØ®':(f.dateStr||'â€”'),'ServiceCode':f.serviceCode,'ServiceName':f.serviceName,'ItemCode':f.itemCode,'ItemName':f.itemName,'IssuedQty':f.issuedQty,'UnchargedQty':f.unchargedQty,'Store':(f.storeName||'')+(f.storeCode?` (#${f.storeCode})`:''),'Ø§Ù„Ù‚Ø³Ù…':f.sectionName,'Ø§Ù„Ù…ÙˆØ¸Ù':(f.empName||'')+(f.staffCode?` (#${f.staffCode})`:'')}));
  const freeRowsOther = freeOther.map(f=>({'Ø§Ù„ØªØ§Ø±ÙŠØ®':(f.dateStr||'â€”'),'ServiceCode':f.serviceCode,'ServiceName':f.serviceName,'ItemCode':f.itemCode,'ItemName':f.itemName,'IssuedQty':f.issuedQty,'UnchargedQty':f.unchargedQty,'Store':(f.storeName||'')+(f.storeCode?` (#${f.storeCode})`:''),'Ø§Ù„Ù‚Ø³Ù…':f.sectionName,'Ø§Ù„Ù…ÙˆØ¸Ù':(f.empName||'')+(f.staffCode?` (#${f.staffCode})`:'')}));
  const parts=[
    {title:`ğŸ’Š Ø£Ø¯ÙˆÙŠØ© (${medsRows.length})`, html:buildTableHtml(medsRows,['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ÙƒÙˆØ¯','Ø§Ù„Ø®Ø¯Ù…Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ù‚Ø³Ù…'])},
    {title:`ğŸ“¦ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª (${supRows.length})`, html:buildTableHtml(supRows,['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ÙƒÙˆØ¯','Ø§Ù„Ø®Ø¯Ù…Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ù‚Ø³Ù…'])},
    {title:`ğŸ› ï¸ Ø®Ø¯Ù…Ø§Øª (${srvRows.length})`, html:buildTableHtml(srvRows,['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ÙƒÙˆØ¯','Ø§Ù„Ø®Ø¯Ù…Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ù‚Ø³Ù…'])},
    {title:`ğŸ†“ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© â€” Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… (${freeRowsSame.length})`, html:buildTableHtml(freeRowsSame,['Ø§Ù„ØªØ§Ø±ÙŠØ®','ServiceCode','ServiceName','ItemCode','ItemName','IssuedQty','UnchargedQty','Store','Ø§Ù„Ù‚Ø³Ù…','Ø§Ù„Ù…ÙˆØ¸Ù'])},
    {title:`ğŸ†“ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© â€” ØªÙˆØ§Ø±ÙŠØ® Ø£Ø®Ø±Ù‰ (${freeRowsOther.length})`, html:buildTableHtml(freeRowsOther,['Ø§Ù„ØªØ§Ø±ÙŠØ®','ServiceCode','ServiceName','ItemCode','ItemName','IssuedQty','UnchargedQty','Store','Ø§Ù„Ù‚Ø³Ù…','Ø§Ù„Ù…ÙˆØ¸Ù'])}
  ];
  $$('#modalBody').innerHTML=parts.map(p=>`<div class="section"><h3>${p.title}</h3>${p.html}</div>`).join(''); $$('#modal').classList.add('show'); }
function closeModal(){ $$('#modal').classList.remove('show'); }
function exportPatientToExcel(){ const {dateStr,patient}=CURRENT_MODAL; if(!patient) return; const {meds,supplies,services}=groupByType(patient); const freeAll=STATE.freeByMed.get(patient.medno)||[]; const freeSame=(patient.free&&patient.free.length)? patient.free : freeAll.filter(f=> f.dateStr===dateStr); const freeOther=freeAll.filter(f=> f.dateStr!==dateStr);
  const wb=XLSX.utils.book_new(); const mk=a=>XLSX.utils.json_to_sheet(a);
  const medsRows=meds.map(x=>({Date:x.dateStr,Code:x.code,Name:x.name,Qty:x.qty,Section:x.section}));
  const supRows =supplies.map(x=>({Date:x.dateStr,Code:x.code,Name:x.name,Qty:x.qty,Section:x.section}));
  const srvRows =services.map(x=>({Date:x.dateStr,Code:x.code,Name:x.name,Qty:x.qty,Section:x.section}));
  const freeRowsSame=freeSame.map(f=>({Date:(f.dateStr||''),ServiceCode:f.serviceCode,ServiceName:f.serviceName,ItemCode:f.itemCode,ItemName:f.itemName,IssuedQty:f.issuedQty,UnchargedQty:f.unchargedQty,Store:(f.storeName||'')+(f.storeCode?` (#${f.storeCode})`:''),Section:f.sectionName,Staff:(f.empName||'')+(f.staffCode?` (#${f.staffCode})`:'')}));
  const freeRowsOther=freeOther.map(f=>({Date:(f.dateStr||''),ServiceCode:f.serviceCode,ServiceName:f.serviceName,ItemCode:f.itemCode,ItemName:f.itemName,IssuedQty:f.issuedQty,UnchargedQty:f.unchargedQty,Store:(f.storeName||'')+(f.storeCode?` (#${f.storeCode})`:''),Section:f.sectionName,Staff:(f.empName||'')+(f.staffCode?` (#${f.staffCode})`:'')}));
  if(medsRows.length) XLSX.utils.book_append_sheet(wb, mk(medsRows), 'Meds'); if(supRows.length) XLSX.utils.book_append_sheet(wb, mk(supRows),'Supplies'); if(srvRows.length) XLSX.utils.book_append_sheet(wb, mk(srvRows),'Services'); if(freeRowsSame.length) XLSX.utils.book_append_sheet(wb, mk(freeRowsSame),'Free_SameDate'); if(freeRowsOther.length) XLSX.utils.book_append_sheet(wb, mk(freeRowsOther),'Free_OtherDates');
  const safeName=(patient.patname||'').replace(/[\\/:*?"<>|]+/g,'-').replace(/\s+/g,'_'); const fname=`Patient_${patient.medno}_${safeName}_${dateStr}.xlsx`; XLSX.writeFile(wb,fname); }
function exportCurrentView(){ if(!STATE.map){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');return;} const opts={ q: $$('#q').value, from: fromInputDate($$('#from').value), to: fromInputDate($$('#to').value), sort: $$('#sort').value };
  let dates=Array.from(STATE.map.keys()); dates.sort((a,b)=>{const pa=a.split('-').reverse().join('-'); const pb=b.split('-').reverse().join('-'); return (opts.sort==='asc'?1:-1)*(pa>pb?1:pa<pb?-1:0)});
  if(opts.from||opts.to){ const dFrom=opts.from? toDDMMYYYY(opts.from):null; const dTo=opts.to? toDDMMYYYY(opts.to):null; dates=dates.filter(d=>{const as=d.split('-').reverse().join('-'); if(dFrom){const fs=dFrom.split('-').reverse().join('-'); if(as<fs) return false;} if(dTo){const ts=dTo.split('-').reverse().join('-'); if(as>ts) return false;} return true;}); }
  const meds=[],sups=[],srvs=[],free=[]; const seenFree=new Set();
  for(const dateStr of dates){ const pm=STATE.map.get(dateStr); let patients=Array.from(pm.values()); if(opts.q){ patients=patients.filter(p=> norm(p.patname).includes(norm(opts.q))||norm(p.medno).includes(norm(opts.q))); }
    for(const p of patients){ for(const s of p.services){ const row={Date:s.dateStr, Medno:p.medno, Name:p.patname, Code:s.code, Service:s.name, Qty:s.qty, Section:s.section, Type:s.type}; if(s.type==='med') meds.push(row); else if(s.type==='supply') sups.push(row); else srvs.push(row);} const allFree=STATE.freeByMed.get(p.medno)||[]; for(const f of allFree){ const key=[p.medno,f.serviceCode,f.itemCode,f.issuedQty,f.storeCode,f.dateStr].join('|'); if(seenFree.has(key)) continue; seenFree.add(key); free.push({Date:(f.dateStr||''), Medno:p.medno, Name:p.patname, ServiceCode:f.serviceCode, ServiceName:f.serviceName, ItemCode:f.itemCode, ItemName:f.itemName, IssuedQty:f.issuedQty, UnchargedQty:f.unchargedQty, Store:(f.storeName||'')+(f.storeCode?` (#${f.storeCode})`:''), Section:f.sectionName, Staff:(f.empName||'')+(f.staffCode?` (#${f.staffCode})`:'')}); }
    }
  }
  const wb=XLSX.utils.book_new(); const mk=a=>XLSX.utils.json_to_sheet(a); if(meds.length) XLSX.utils.book_append_sheet(wb,mk(meds),'Meds'); if(sups.length) XLSX.utils.book_append_sheet(wb,mk(sups),'Supplies'); if(srvs.length) XLSX.utils.book_append_sheet(wb,mk(srvs),'Services'); if(free.length) XLSX.utils.book_append_sheet(wb,mk(free),'Free_AllForVisiblePatients'); if(!wb.SheetNames.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§ ÙˆÙÙ‚Ù‹Ø§ Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©'); return; } XLSX.writeFile(wb,'Current_View.xlsx'); }

// Events
$$('#btnParse').addEventListener('click',handleParse); $$('#applyFilters').addEventListener('click',applyFilters); $$('#btnReset').addEventListener('click',resetAll); $$('#q').addEventListener('input',()=>{ if(STATE.map) applyFilters(); }); $$('#from').addEventListener('change',applyFilters); $$('#to').addEventListener('change',applyFilters); $$('#sort').addEventListener('change',applyFilters); $$('#btnExportView').addEventListener('click',exportCurrentView); $$('#btnModalClose').addEventListener('click',()=> $$('#modal').classList.remove('show')); $$('#btnModalExport').addEventListener('click',exportPatientToExcel); $$('#modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') closeModal(); }); window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

// ===== Tests =====
(function runTests(){ const assert=(c,m)=>{ if(!c) throw new Error('Test failed: '+m); };
  const d=new Date(2025,8,15); assert(toDDMMYYYY(d)==='15-09-2025','toDDMMYYYY');
  const mainRows=[ {dateStr:'01-09-2025',date:new Date(2025,8,1),medno:'100',patname:'A',ins:'Cash',code:'12001',sname:'Med X',qty:1,sectionDesc:'ER',bucket:'med'}, {dateStr:'01-09-2025',date:new Date(2025,8,1),medno:'200',patname:'B',ins:'Cash',code:'20001',sname:'Sup Y',qty:1,sectionDesc:'ER',bucket:'supply'} ];
  const freeRows=[ {dateStr:'01-09-2025',date:new Date(2025,8,1),medno:'100',patname:'A',serviceCode:'S1',serviceName:'Kit',sectionName:'ER',itemCode:'I1',itemName:'Gauze',issuedQty:1,unchargedQty:1,storeCode:'SC',storeName:'Main',staffCode:'ST',empName:'N1'}, {dateStr:'',date:null,medno:'100',patname:'A',serviceCode:'S2',serviceName:'Tape',sectionName:'ER',itemCode:'I2',itemName:'Tape',issuedQty:1,unchargedQty:1,storeCode:'SC',storeName:'Main',staffCode:'ST',empName:'N1'} ];
  const mp=buildGroups(mainRows,freeRows); assert(mp.has('01-09-2025'),'has day'); const g=mp.get('01-09-2025'); assert(g.get('100').hasFree===true,'free attached for same date'); const ix=groupFreeByMed(freeRows); assert(ix.get('100').length===2,'freeByMed keeps missing-date rows'); console.log('%cAll tests passed','color:#10b981;font-weight:bold'); })();
</script>
</body>
</html>
