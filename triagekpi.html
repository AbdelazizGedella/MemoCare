<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة متابعة تغييرات الترياج (CTAS) — v2</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Icons + Charts + CSV Parser -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{ --glass-bg: rgba(255,255,255,0.06); --glass-bd: rgba(255,255,255,0.12); }
    html, body { background:#07102F; color:#fff; font-family:'Cairo', system-ui, sans-serif; }
    .glass { background: var(--glass-bg); border: 1px solid var(--glass-bd); backdrop-filter: blur(8px); border-radius: 18px; }
    .kpi { display:flex; align-items:center; gap:12px; padding:16px; }
    .kpi .num { font-size: 28px; font-weight: 700; }
    .kpi .lbl { font-size: 12px; opacity: .85; }
    .card-title { font-weight:700; }
    .table :where(th,td){ white-space:nowrap; }
    .badge-ctas { border:1px solid var(--glass-bd); background: rgba(255,255,255,.08); }
    .btn-glass { background: linear-gradient(135deg,#0b3af5 0%,#0f1c3c 100%); border:0; color:#fff; }
    .btn-glass:hover{ filter: brightness(1.1); }
    .chart-wrap { height: 180px; }
    @media (min-width: 640px){ .chart-wrap{ height: 220px; } }
    @media (min-width: 1024px){ .chart-wrap{ height: 240px; } }
  </style>
</head>
<body class="pb-28">
  <!-- Header -->
  <header class="sticky top-0 z-50 w-full glass">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-triangle-exclamation text-cyan-300 text-xl"></i>
        <h1 class="text-base sm:text-xl md:text-2xl font-bold">لوحة متابعة تغييرات الترياج (CTAS)</h1>
      </div>
      <div class="flex items-center gap-2 text-xs opacity-80">
        <span id="lastUpdated">—</span>
        <button id="btnRefresh" class="btn btn-xs sm:btn-sm btn-glass"><i class="fa-solid fa-rotate"></i> تحديث</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-2 sm:px-4 mt-4 space-y-4">
    <!-- Controls -->
    <section class="glass p-3 sm:p-4">
      <div class="flex flex-wrap items-end gap-3">
        <label class="form-control w-40">
          <div class="label"><span class="label-text">من تاريخ</span></div>
          <input id="dateFrom" type="date" class="input input-sm input-bordered" />
        </label>
        <label class="form-control w-40">
          <div class="label"><span class="label-text">إلى تاريخ</span></div>
          <input id="dateTo" type="date" class="input input-sm input-bordered" />
        </label>
        <label class="form-control flex-1 sm:flex-none w-full sm:w-56">
          <div class="label"><span class="label-text">بحث (ملف/اسم/ممرضة/طبيب/سبب)</span></div>
          <input id="qText" type="text" placeholder="ابحث.." class="input input-sm input-bordered" />
        </label>
        <button id="btnClear" class="btn btn-sm">مسح الفلاتر</button>
        <div class="ms-auto text-xs opacity-80">تُحدّث تلقائياً كل 5 دقائق</div>
      </div>
      <div id="activeFilters" class="flex flex-wrap gap-2 mt-2"></div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="glass kpi"><i class="fa-solid fa-list text-cyan-300"></i><div><div class="num" id="kpiTotal">0</div><div class="lbl">إجمالي التغييرات</div></div></div>
      <div class="glass kpi"><i class="fa-solid fa-arrow-trend-up text-amber-300"></i><div><div class="num" id="kpiUnder">0</div><div class="lbl">Under‑triage (زادت الخطورة)</div></div></div>
      <div class="glass kpi"><i class="fa-solid fa-arrow-trend-down text-emerald-300"></i><div><div class="num" id="kpiOver">0</div><div class="lbl">Over‑triage (قلت الخطورة)</div></div></div>
      <div class="glass kpi"><i class="fa-solid fa-minus text-slate-300"></i><div><div class="num" id="kpiNoChange">0</div><div class="lbl">بدون تغيير/بيانات ناقصة</div></div></div>
    </section>

    <!-- Benchmarks + Under/Over (smaller pie) -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Benchmarks Card -->
      <div class="glass p-4">
        <div class="card-title mb-1">Benchmark (سبتمبر الحالي)</div>
        <div class="text-xs opacity-80 mb-2">
          الإجمالي المرجعي (B2): <span id="bmTotal">—</span>
          <span id="bmSource" class="ms-1"></span>
        </div>
        <div>
          <div class="flex items-center justify-between text-xs"><span>Over‑triage ≤ 35%</span><span id="bmOverPct">—%</span></div>
          <progress id="bmOverProg" class="progress progress-success w-full" value="0" max="100"></progress>
          <div id="bmOverStatus" class="text-xs mt-1"></div>
        </div>
        <div class="mt-3">
          <div class="flex items-center justify-between text-xs"><span>Under‑triage ≤ 5%</span><span id="bmUnderPct">—%</span></div>
          <progress id="bmUnderProg" class="progress progress-warning w-full" value="0" max="100"></progress>
          <div id="bmUnderStatus" class="text-xs mt-1"></div>
        </div>
        <div class="mt-3 text-[11px] opacity-70">ملاحظة: لو لم يتم ضبط رابط B2، يتم تقدير الإجمالي من بيانات التغييرات (قد يكون أقل من الإجمالي الحقيقي).</div>
      </div>

      <!-- Under/Over Pie (smaller) -->
      <div class="glass p-4">
        <div class="card-title mb-2">نِسَب Under/Over</div>
        <div class="chart-wrap"><canvas id="chUnderOver"></canvas></div>
      </div>
    </section>

    <!-- Charts Row 1 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="glass p-4">
        <div class="card-title mb-2">أسباب التغيير (Top 10) — اضغط للفلترة</div>
        <div class="chart-wrap"><canvas id="chReasons"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="card-title mb-2">أكثر الممرضين/ات ارتباطًا بالتغيير (Top 10) — اضغط للفلترة</div>
        <div class="chart-wrap"><canvas id="chNurses"></canvas></div>
      </div>
    </section>

    <!-- Charts Row 2 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="glass p-4">
        <div class="card-title mb-2">أكثر الأطباء ارتباطًا بالتغيير (Top 10) — اضغط للفلترة</div>
        <div class="chart-wrap"><canvas id="chDocs"></canvas></div>
      </div>
      <div class="glass p-4">
        <div class="card-title mb-2">اتجاه شهري للتغييرات — اضغط على الشهر لعرض الحالات</div>
        <div class="chart-wrap"><canvas id="chMonthly"></canvas></div>
      </div>
    </section>

    <!-- Table -->
    <section class="glass p-3 sm:p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="card-title">آخر الحالات</div>
        <div class="text-xs opacity-70">اضغط على صف لعرض التفاصيل</div>
      </div>
      <div class="overflow-x-auto">
        <table class="table table-zebra table-sm" id="tbl">
          <thead>
            <tr>
              <th>التاريخ</th>
              <th>MRN</th>
              <th>المريض</th>
              <th>ممرضة الترياج</th>
              <th>الطبيب</th>
              <th>التغيير</th>
              <th>السبب</th>
              <th>نموذج Pre‑Reg</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Details Modal -->
  <dialog id="dlgDetails" class="modal">
    <div class="modal-box max-w-3xl glass">
      <form method="dialog"><button class="btn btn-sm btn-circle absolute left-2 top-2">✕</button></form>
      <h3 class="font-bold text-lg mb-2">تفاصيل الحالة</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
        <div><span class="opacity-80">التاريخ:</span> <span id="dDate"></span></div>
        <div><span class="opacity-80">MRN:</span> <span id="dMRN"></span></div>
        <div><span class="opacity-80">المريض:</span> <span id="dName"></span></div>
        <div><span class="opacity-80">ممرضة الترياج:</span> <span id="dNurse"></span></div>
        <div><span class="opacity-80">الطبيب:</span> <span id="dDoc"></span></div>
        <div><span class="opacity-80">التغيير:</span> <span id="dChange"></span></div>
        <div class="sm:col-span-2"><span class="opacity-80">السبب:</span> <span id="dReason"></span></div>
      </div>
      <div class="divider"></div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnOpenPre" class="btn btn-sm btn-glass" target="_blank"><i class="fa-regular fa-file-lines"></i> فتح النموذج في تبويب</button>
        <button id="btnEmbedPre" class="btn btn-sm"><i class="fa-solid fa-eye"></i> عرض داخل الصفحة</button>
      </div>
      <div id="embedWrap" class="mt-3 hidden">
        <iframe id="embedFrame" class="w-full h-[60vh] rounded-xl" loading="lazy"></iframe>
      </div>
    </div>
  </dialog>

  <!-- Loading -->
  <div id="loading" class="toast toast-top toast-center">
    <div class="alert alert-info glass"><span>جاري تحميل البيانات...</span></div>
  </div>

  <script>
  // ===================== CONFIG =====================
  // بيانات الحالات (CSV مُعلن من Google Sheets)
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7M-mFoBFVT4e6gyhvCXCww9QwE520QWbDgc-rmIJ7dVnxejkVNyNmz8wwBe_ioW9d8TrfcOMXnhJc/pub?output=csv';

  // (اختياري) رابط مباشر لقراءة B2 كـ CSV لخانة إجمالي حالات سبتمبر.
  // أنشئ شيت فرعي باسم Settings مثلاً، انشره، ثم استخدم:
  // https://docs.google.com/spreadsheets/d/<SHEET_ID>/gviz/tq?tqx=out:csv&sheet=Settings&range=B2
const BENCHMARK_B2_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7M-mFoBFVT4e6gyhvCXCww9QwE520QWbDgc-rmIJ7dVnxejkVNyNmz8wwBe_ioW9d8TrfcOMXnhJc/pub?gid=1298939590&single=true&output=csv';

  const AUTO_REFRESH_MS = 5 * 60 * 1000; // 5 minutes
  const OVER_OK_MAX = 0.35; // 35%
  const UNDER_OK_MAX = 0.05; // 5%

  // ===================== UTILITIES =====================
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const fmtDate = (d)=>{
    if(!d) return '';
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    return `${dd}-${mm}-${yy}`;
  };
  function parseDateFlexible(val){
  if(!val) return null;
  const s = String(val).trim();

  // 1) ISO: YYYY-MM-DD أو YYYY/MM/DD (واضحة ومباشرة)
  let m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
  if(m){
    const [, Y, M, D] = m.map(Number);
    return new Date(Y, M-1, D);
  }

  // 2) الصيغة المطلوبة أساسًا: DD-MM-YYYY أو DD/MM/YYYY (Day-First)
  m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
  if(m){
    let D = parseInt(m[1],10);
    let M = parseInt(m[2],10);
    let Y = m[3].length === 2 ? parseInt('20'+m[3],10) : parseInt(m[3],10);
    return new Date(Y, M-1, D);
  }

  // 3) دعم أرقام إكسل التسلسلية لو ظهرت (اختياري وآمن)
  if(/^\d+(\.\d+)?$/.test(s)){
    const n = Number(s);
    // 25569 = 1970-01-01 كنقطة مرجعية لإكسل (أيام)
    if(n > 25569){
      const ms = Math.round((n - 25569) * 86400000);
      const d = new Date(ms);
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
  }

  // 4) آخر حل: جرّب بارسر المتصفح (للنصوص القياسية فقط)
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

  function cleanStr(x){ return String(x||'').trim(); }
  function parseCTAS(s){ const m = String(s||'').match(/([1-5])/); return m? parseInt(m[1],10) : NaN; }
  function changeLabel(from,to){
    const f = parseCTAS(from), t = parseCTAS(to);
    if(!isFinite(f) || !isFinite(t)) return {label:'—', kind:'na'};
    if(t < f) return {label:`Under (من ${f} ➜ ${t})`, kind:'under'};
    if(t > f) return {label:`Over (من ${f} ➜ ${t})`, kind:'over'};
    return {label:`No change (${f})`, kind:'same'};
  }
  function embedFromDriveUrl(url){
    if(!url) return null;
    try{
      const u = new URL(url);
      const host = u.hostname;
      if(host.includes('drive.google.com')){
        const m = url.match(/\/d\/([A-Za-z0-9_-]{10,})/);
        const id = m? m[1] : (u.searchParams.get('id') || null);
        if(id){ return `https://drive.google.com/file/d/${id}/preview`; }
      }
      if(host.includes('docs.google.com')){ return url; }
    }catch(e){ /* ignore */ }
    return null;
  }
  function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

  // ===================== STATE =====================
  let RAW_ROWS = []; // original rows
  let ENTRIES = [];  // normalized entries
  let charts = { underOver:null, reasons:null, nurses:null, docs:null, monthly:null };
  let ACTIVE_FILTER = null; // function(e) => boolean
  let ACTIVE_FILTER_CHIPS = []; // [{label, clear:fn}]
  let BM_TOTAL = null; // إجمالي الشهر المرجعي (B2)
  let BM_SOURCE = '';

  // ===================== LOAD =====================
  async function loadCSV(url){
    return new Promise((resolve, reject)=>{
      Papa.parse(url, { download:true, header:true, skipEmptyLines:true, complete: r=>resolve(r.data), error: reject });
    });
  }
async function loadB2(){
  if(!BENCHMARK_B2_URL) { BM_TOTAL = null; BM_SOURCE = 'تقديري'; return; }
  try{
    const data = await new Promise((resolve, reject)=>{
      Papa.parse(BENCHMARK_B2_URL, {
        download: true,
        header: false,
        skipEmptyLines: false,
        complete: (res)=> resolve(res.data),
        error: reject
      });
    });
    // B2 = الصف الثاني، العمود الثاني (index 1,1)
    const b2raw = (data?.[1]?.[1] ?? '').toString().trim();
    const val = parseFloat(b2raw.replace(/[^\d.\-]/g,''));
    if (isFinite(val) && val > 0) { BM_TOTAL = val; BM_SOURCE = 'B2'; return; }
    BM_TOTAL = null; BM_SOURCE = 'تقديري';
  } catch(e) {
    BM_TOTAL = null; BM_SOURCE = 'تقديري';
  }
}

  function normalizeRows(rows){
    return rows.map(r=>{
      const date = parseDateFlexible(r['Date'] || r['التاريخ']);
      const mrn = cleanStr(r['MRNo.'] || r['MRN'] || r['رقم الملف']);
      const name = cleanStr(r['Patient Name'] || r['اسم المريض']);
      const nurse = cleanStr(r['Responsible Triage Nurse'] || r['Responsible Nurse'] || r['ممرضة الترياج']);
      const doc = cleanStr(r['Responsible Phyiscian'] || r['Responsible Physician'] || r['الطبيب']);
      const from = cleanStr(r['Changed From'] || r['من']);
      const to   = cleanStr(r['Changed To'] || r['إلى']);
      const init = cleanStr(r['Initial Triage was'] || r['Initial Triage'] || r['الترياج المبدئي']);
      const reason = cleanStr(r['Reason'] || r['السبب']);
      const pre = cleanStr(r['Pre-Registration Form'] || r['Pre-Registeration Form'] || r['النموذج'] || r['Form']);
      const c = changeLabel(from,to);
      return { date, mrn, name, nurse, doc, from, to, init, reason, pre, changeKind:c.kind, changeText:c.label };
    }).filter(x=> x.date || x.mrn || x.name);
  }

  function applyFilters(){
    const q = cleanStr($('#qText').value).toLowerCase();
    const df = $('#dateFrom').value? new Date($('#dateFrom').value) : null;
    const dt = $('#dateTo').value? new Date($('#dateTo').value) : null;
    return ENTRIES.filter(e=>{
      if(df && e.date && e.date < df) return false;
      if(dt && e.date && e.date > dt) return false;
      if(q){ const blob = `${e.mrn} ${e.name} ${e.nurse} ${e.doc} ${e.reason}`.toLowerCase(); if(!blob.includes(q)) return false; }
      if(ACTIVE_FILTER && !ACTIVE_FILTER(e)) return false;
      return true;
    });
  }

  function tallyBy(arr, key, whereFn){
    const m = new Map();
    for(const a of arr){
      if(whereFn && !whereFn(a)) continue;
      const k = (typeof key==='function')? key(a) : (a[key]||'');
      const kk = (k||'').trim();
      if(!kk) continue;
      m.set(kk, (m.get(kk)||0)+1);
    }
    return [...m.entries()].sort((a,b)=> b[1]-a[1]);
  }

  function tallyUnderOverBy(arr, byKey){
    const map = new Map();
    for(const a of arr){
      const k = cleanStr(a[byKey]); if(!k) continue;
      const curr = map.get(k) || { under:0, over:0 };
      if(a.changeKind==='under') curr.under++;
      else if(a.changeKind==='over') curr.over++;
      map.set(k, curr);
    }
    const out = [...map.entries()].map(([label, v])=>({ label, under:v.under, over:v.over }));
    out.sort((A,B)=> (B.under+B.over) - (A.under+A.over));
    return out;
  }

  function groupMonthly(arr){
    const m = new Map();
    for(const a of arr){ if(!a.date) continue; const k = monthKey(a.date); m.set(k, (m.get(k)||0)+1); }
    const out = [...m.entries()].sort((a,b)=> a[0].localeCompare(b[0]));
    return { labels: out.map(x=>x[0]), values: out.map(x=>x[1]) };
  }

  // ===================== RENDER =====================
  function renderKPIs(view){
    const total = view.length;
    const under = view.filter(x=>x.changeKind==='under').length;
    const over  = view.filter(x=>x.changeKind==='over').length;
    const same  = total - under - over;
    $('#kpiTotal').textContent = total;
    $('#kpiUnder').textContent = under;
    $('#kpiOver').textContent  = over;
    $('#kpiNoChange').textContent = same;
  }

  function ensureChart(ctxRef){ const el = document.getElementById(ctxRef); return el? el.getContext('2d') : null; }

  function makeGradient(ctx){
    const g = ctx.createLinearGradient(0,0,0,200);
    g.addColorStop(0,'rgba(99,102,241,0.4)');
    g.addColorStop(1,'rgba(99,102,241,0.03)');
    return g;
  }

  function drawCharts(view){
    for(const k of Object.keys(charts)){ if(charts[k]){ charts[k].destroy(); charts[k]=null; } }

    // Under/Over (smaller doughnut)
    {
      const under = view.filter(x=>x.changeKind==='under').length;
      const over  = view.filter(x=>x.changeKind==='over').length;
      const same  = view.length - under - over;
      const ctx = ensureChart('chUnderOver');
      charts.underOver = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['Under','Over','No change'], datasets:[{ data:[under,over,same], backgroundColor:['#f59e0b','#10b981','#94a3b8'] }] },
        options:{
          cutout:'72%',
          maintainAspectRatio:false,
          plugins:{ legend:{ labels:{ color:'#fff' } }, tooltip:{ callbacks:{ label: (ctx)=> `${ctx.label}: ${ctx.raw}` } } }
        }
      });
    }

    // Reasons Top10 (clickable)
    {
      const top = tallyBy(view,'reason').slice(0,10);
      const ctx = ensureChart('chReasons');
      charts.reasons = new Chart(ctx, {
        type:'bar',
        data:{ labels: top.map(x=>x[0]), datasets:[{ label:'عدد الحالات', data: top.map(x=>x[1]) }] },
        options:{
          indexAxis:'y', maintainAspectRatio:false,
          scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } } }, plugins:{ legend:{ display:false } },
          onClick: (e)=>{
            const p = charts.reasons.getElementsAtEventForMode(e,'nearest',{intersect:true},true)[0];
            if(!p) return; const label = charts.reasons.data.labels[p.index];
            setActiveFilter(`السبب: ${label}`, (row)=> cleanStr(row.reason)===cleanStr(label));
          }
        }
      });
    }

    // Nurses Top10 (stacked, clickable)
    {
      const agg = tallyUnderOverBy(view,'nurse').slice(0,10);
      const ctx = ensureChart('chNurses');
      charts.nurses = new Chart(ctx, {
        type:'bar',
        data:{ labels: agg.map(x=>x.label), datasets:[
          { label:'Under', data: agg.map(x=>x.under), backgroundColor:'#f59e0b', stack:'s' },
          { label:'Over',  data: agg.map(x=>x.over),  backgroundColor:'#10b981', stack:'s' }
        ] },
        options:{ maintainAspectRatio:false,
          scales:{ x:{ stacked:true, ticks:{ color:'#fff' } }, y:{ stacked:true, ticks:{ color:'#fff' } } },
          plugins:{ legend:{ labels:{ color:'#fff' } } },
          onClick: (e)=>{
            const p = charts.nurses.getElementsAtEventForMode(e,'nearest',{intersect:true},true)[0];
            if(!p) return; const label = charts.nurses.data.labels[p.index];
            setActiveFilter(`الممرضة/الممرض: ${label}`,(row)=> cleanStr(row.nurse)===cleanStr(label));
          }
        }
      });
    }

    // Doctors Top10 (stacked, clickable)
    {
      const agg = tallyUnderOverBy(view,'doc').slice(0,10);
      const ctx = ensureChart('chDocs');
      charts.docs = new Chart(ctx, {
        type:'bar',
        data:{ labels: agg.map(x=>x.label), datasets:[
          { label:'Under', data: agg.map(x=>x.under), backgroundColor:'#f59e0b', stack:'s' },
          { label:'Over',  data: agg.map(x=>x.over),  backgroundColor:'#10b981', stack:'s' }
        ] },
        options:{ maintainAspectRatio:false,
          scales:{ x:{ stacked:true, ticks:{ color:'#fff' } }, y:{ stacked:true, ticks:{ color:'#fff' } } },
          plugins:{ legend:{ labels:{ color:'#fff' } } },
          onClick: (e)=>{
            const p = charts.docs.getElementsAtEventForMode(e,'nearest',{intersect:true},true)[0];
            if(!p) return; const label = charts.docs.data.labels[p.index];
            setActiveFilter(`الطبيب: ${label}`,(row)=> cleanStr(row.doc)===cleanStr(label));
          }
        }
      });
    }

    // Monthly (area, clickable)
    {
      const g = groupMonthly(view);
      const ctx = ensureChart('chMonthly');
      const gradient = makeGradient(ctx);
      charts.monthly = new Chart(ctx, {
        type:'line',
        data:{ labels: g.labels, datasets:[{ label:'إجمالي التغييرات', data: g.values, tension:.35, fill:true, backgroundColor: gradient, borderColor:'#6366f1', pointRadius:3 }] },
        options:{ maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } } }, plugins:{ legend:{ display:false } },
          onClick: (e)=>{
            const p = charts.monthly.getElementsAtEventForMode(e,'nearest',{intersect:true},true)[0];
            if(!p) return; const label = charts.monthly.data.labels[p.index];
            // label = YYYY-MM
            const [yy,mm] = label.split('-').map(Number);
            const start = new Date(yy, mm-1, 1); const end = new Date(yy, mm, 0, 23,59,59);
            $('#dateFrom').value = start.toISOString().slice(0,10);
            $('#dateTo').value   = end.toISOString().slice(0,10);
            updateAll();
            document.getElementById('tbl').scrollIntoView({behavior:'smooth', block:'start'});
          }
        }
      });
    }
  }

  function renderTable(view){
    const TB = $('#tbl tbody');
    TB.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(const e of view){
      const tr = document.createElement('tr');
      const changeBadge = e.changeKind==='under'? 'badge-warning' : (e.changeKind==='over'? 'badge-success' : '');
      tr.innerHTML = `
        <td>${fmtDate(e.date)}</td>
        <td>${e.mrn||''}</td>
        <td>${e.name||''}</td>
        <td>${e.nurse||''}</td>
        <td>${e.doc||''}</td>
        <td><span class="badge badge-ctas ${changeBadge}">${e.changeText}</span></td>
        <td title="${e.reason||''}">${(e.reason||'').slice(0,40)}${(e.reason||'').length>40?'…':''}</td>
        <td>${e.pre? '<i class="fa-regular fa-file-lines"></i>':'—'}</td>`;
      tr.className = 'hover:cursor-pointer';
      tr.addEventListener('click', ()=> openDetails(e));
      frag.appendChild(tr);
    }
    TB.appendChild(frag);
  }

  function openDetails(e){
    $('#dDate').textContent = fmtDate(e.date);
    $('#dMRN').textContent = e.mrn||'';
    $('#dName').textContent = e.name||'';
    $('#dNurse').textContent = e.nurse||'';
    $('#dDoc').textContent = e.doc||'';
    $('#dChange').textContent = e.changeText||'';
    $('#dReason').textContent = e.reason||'';

    const openBtn = $('#btnOpenPre');
    const embedBtn = $('#btnEmbedPre');
    const wrap = $('#embedWrap');
    const frame = $('#embedFrame');

    if(e.pre){
      openBtn.disabled = false; embedBtn.disabled = false;
      openBtn.onclick = ()=> window.open(e.pre, '_blank');
      embedBtn.onclick = ()=>{
        const preview = embedFromDriveUrl(e.pre);
        if(preview){ frame.src = preview; wrap.classList.remove('hidden'); }
        else { wrap.classList.add('hidden'); window.open(e.pre, '_blank'); }
      };
    } else {
      openBtn.disabled = true; embedBtn.disabled = true; $('#embedWrap').classList.add('hidden');
    }

    $('#dlgDetails').showModal();
  }

  // ============ Benchmarks ============
  function computeMonthCounts(entries, yy, mm){
    const list = entries.filter(x=> x.date && x.date.getFullYear()===yy && (x.date.getMonth()+1)===mm);
    const over = list.filter(x=>x.changeKind==='over').length;
    const under = list.filter(x=>x.changeKind==='under').length;
    return { over, under, list };
  }
  function setStatus(el, pct, max){
    const txt = isFinite(pct)? (pct*100).toFixed(1)+'%' : '—%';
    el.textContent = txt;
  }
  function statusMsg(pct, max){
    if(!isFinite(pct)) return '—';
    if(pct <= max) return '✅ ضمن الحد';
    if(pct <= max + 0.02) return '⚠️ قريب من الحد';
    return '❌ أعلى من الحد';
  }
  function renderBenchmarks(){
    const today = new Date();
    const yy = today.getFullYear();
    const mm = today.getMonth()+1; // سبتمبر حالياً
    const { over, under } = computeMonthCounts(ENTRIES, yy, mm);

    let total = BM_TOTAL;
    let source = BM_SOURCE || '';
    if(!isFinite(total) || total<=0){
      // تقدير: نستخدم عدد الحالات (distinct MRN في الشهر) إن وجد، وإلا عدد الصفوف
      const monthRows = ENTRIES.filter(x=> x.date && x.date.getFullYear()===yy && (x.date.getMonth()+1)===mm);
      const uniq = new Set(monthRows.map(x=> x.mrn || `${+x.date}`));
      total = Math.max(uniq.size, monthRows.length);
      source = 'تقديري';
    }

    $('#bmTotal').textContent = total;
    $('#bmSource').textContent = source==='B2'? '(من الخلية B2)' : '(تقدير من البيانات)';

    const overPct = total? over/total : NaN;
    const underPct = total? under/total : NaN;

    setStatus($('#bmOverPct'), overPct, OVER_OK_MAX);
    setStatus($('#bmUnderPct'), underPct, UNDER_OK_MAX);

    $('#bmOverProg').value = isFinite(overPct)? (overPct*100) : 0;
    $('#bmUnderProg').value = isFinite(underPct)? (underPct*100) : 0;

    $('#bmOverStatus').textContent = statusMsg(overPct, OVER_OK_MAX);
    $('#bmUnderStatus').textContent = statusMsg(underPct, UNDER_OK_MAX);
  }

  // ============ Active Filters (chips) ============
  function setActiveFilter(label, fn){
    ACTIVE_FILTER = fn;
    ACTIVE_FILTER_CHIPS = [{ label, clear: ()=>{ ACTIVE_FILTER=null; ACTIVE_FILTER_CHIPS=[]; updateAll(); } }];
    renderChips();
    updateAll();
    document.getElementById('tbl').scrollIntoView({behavior:'smooth', block:'start'});
  }
  function renderChips(){
    const wrap = $('#activeFilters');
    wrap.innerHTML = '';
    for(const chip of ACTIVE_FILTER_CHIPS){
      const el = document.createElement('div');
      el.className = 'badge badge-outline gap-2';
      el.innerHTML = `${chip.label} <button class="btn btn-ghost btn-xs" title="إزالة" aria-label="إزالة">✕</button>`;
      el.querySelector('button').onclick = chip.clear;
      wrap.appendChild(el);
    }
  }

  function updateAll(){
    const view = applyFilters();
    renderKPIs(view);
    drawCharts(view);
    renderTable(view.slice().sort((a,b)=> (b.date||0)-(a.date||0)));
    renderBenchmarks();
  }

  async function refresh(){
    $('#loading').style.display='';
    try{
      await loadB2();
      RAW_ROWS = await loadCSV(CSV_URL);
      ENTRIES = normalizeRows(RAW_ROWS);
      updateAll();
      $('#lastUpdated').textContent = 'آخر تحديث: ' + new Date().toLocaleString('ar-EG');
    } catch(e){
      console.error(e);
      alert('تعذر تحميل البيانات. تأكد من روابط Google Sheets (Share to web)');
    } finally {
      $('#loading').style.display='none';
    }
  }

  // ===================== INIT =====================
  document.addEventListener('DOMContentLoaded', ()=>{
    refresh();
    $('#btnRefresh').addEventListener('click', refresh);
    $('#btnClear').addEventListener('click', ()=>{ $('#qText').value=''; $('#dateFrom').value=''; $('#dateTo').value=''; ACTIVE_FILTER=null; ACTIVE_FILTER_CHIPS=[]; renderChips(); updateAll(); });
    $('#qText').addEventListener('input', ()=> updateAll());
    $('#dateFrom').addEventListener('change', ()=> updateAll());
    $('#dateTo').addEventListener('change', ()=> updateAll());
    setInterval(refresh, AUTO_REFRESH_MS);
  });
  </script>
</body>
</html>
