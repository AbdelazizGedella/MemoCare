<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>دفتر ملاحظات دراسية — Q&A من Google Sheets</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet"/>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --ink:#e2e8f0; --ink-soft:#94a3b8; --glass:rgba(15,23,42,.5); --glass-2:rgba(30,41,59,.55); }
    body{font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(14,165,233,.2), transparent 40%),
                  linear-gradient(180deg,#0b1e3b 0%,#0f172a 60%,#0b1324 100%);
      color:var(--ink);}
    .glass{background:var(--glass);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.06);border-radius:1rem;}
    .chip{border:1px solid rgba(148,163,184,.25);padding:2px 8px;border-radius:999px;font-size:12px;color:#cbd5e1;}
    .card-hover:hover{transform:translateY(-2px);transition:.2s ease;border-color:rgba(14,165,233,.35);}
    .truncate-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
    .en{ color:#f59e0b !important; font-weight:600; }
    .sticky-bar{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06);}
    .media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.75rem}
    .aspect-video{position:relative;padding-top:56.25%}
    .aspect-video > *{position:absolute;inset:0;width:100%;height:100%;border-radius:.75rem}
    .btn-fab{position:fixed;right:16px;bottom:16px;z-index:50}

    /* مربعات التصنيف */
    .level-squares{display:flex;gap:6px;margin-top:.35rem}
    .level-squares span{width:14px;height:14px;border-radius:3px;background:#1f2937;border:1px solid #334155;opacity:.6}
    .level-squares span.active{opacity:1;border-color:transparent}

    /* المرفقات عرض كامل داخل المودال */
    #mMedia{grid-template-columns:1fr;}
    #mMedia img{width:100%;height:auto;border-radius:.75rem}

    /* تمييزات مخصصة */
    .badge-burgundy{background:#7b1e3c;border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:999px;padding:.15rem .5rem;font-size:.75rem}
    .example-line{color:#f9a8d4}
    .example-badge{background:rgba(236,72,153,.15);border:1px solid rgba(236,72,153,.35);color:#f9a8d4;border-radius:999px;padding:.15rem .5rem;font-size:.75rem}
    .badge-important{background:#b45309;border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:999px;padding:.15rem .5rem;font-size:.75rem}
    .important-line{color:#fbbf24}

    /* Stage Flow (سطر المراحل) */
    .stage-flow{display:flex;gap:.5rem;align-items:center;white-space:nowrap;overflow-x:auto;padding:.25rem .5rem;border-radius:.5rem;border:1px solid rgba(148,163,184,.18);background:rgba(148,163,184,.06)}
    .stage-node{display:inline-flex;align-items:center;padding:.15rem .55rem;border-radius:999px;border:1px solid rgba(148,163,184,.35);background:rgba(148,163,184,.12);font-size:.85rem}
    .stage-arrow{opacity:.75}

    /* جداول Markdown داخل الإجابات */
    .qa-table{width:100%}
    .qa-table th,.qa-table td{ text-align:center; }
    .qa-table thead th{
      background: rgba(148,163,184,.12);
      border-bottom: 1px solid rgba(148,163,184,.28);
      font-weight:700;
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-3">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">دفتر ملاحظات دراسية — Q&A من Google Sheets</h1>
        <p class="text-sm text-[var(--ink-soft)]">قراءة من Google Sheets كـ CSV، بحث + فلاتر + أسئلة مشابهة — كله محلي.</p>
      </div>
    </div>
  </header>

  <!-- Sections Sticky Bar -->
  <nav id="sectionBar" class="sticky-bar">
    <div class="max-w-6xl mx-auto px-4 py-2 overflow-x-auto">
      <div id="sectionChips" class="flex gap-2 items-center"></div>
    </div>
  </nav>

  <!-- CSV URL -->
  <section class="max-w-6xl mx-auto px-4 mt-3">
    <div class="glass p-4 mb-4">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
        <div class="w-full sm:flex-1">
          <label class="text-sm text-[var(--ink-soft)]">رابط CSV من Google Sheets (نشر ↔ الويب)</label>
          <input id="csvUrl" type="url" placeholder="ضع رابط CSV هنا، أو اتركه فارغاً لتجربة بيانات افتراضية" class="input input-bordered w-full"/>
        </div>
        <div class="flex gap-2">
          <button id="saveUrl" class="btn btn-success"><i class="fa-solid fa-floppy-disk mr-2"></i>حفظ</button>
          <button id="loadBtn" class="btn btn-info"><i class="fa-solid fa-rotate mr-2"></i>تحديث</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Controls + Quick stats -->
  <section class="max-w-6xl mx-auto px-4">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
      <div class="md:col-span-6 glass p-4">
        <div class="flex flex-col lg:flex-row gap-3 items-stretch">
          <div class="flex-1 relative">
            <input id="searchInput" type="text" placeholder="ابحث باسم السؤال أو الكلمات المفتاحية…" class="input input-bordered w-full pr-10"/>
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>
          <select id="sectionFilter" class="select select-bordered w-full lg:w-48">
            <option value="">كل الأقسام</option>
          </select>
          <select id="difficultyFilter" class="select select-bordered w-full lg:w-40">
            <option value="">كل المستويات</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option><option value="5">5</option>
          </select>
          <label class="label cursor-pointer gap-2">
            <span class="label-text">المفضلة</span>
            <input id="favOnly" type="checkbox" class="toggle toggle-info"/>
          </label>
        </div>
        <div id="tagsBar" class="mt-3 flex flex-wrap gap-2"></div>
      </div>

      <div class="md:col-span-6 glass p-4">
        <h3 class="font-bold mb-2">إحصائيات سريعة</h3>
        <ul class="text-sm space-y-1 text-[var(--ink-soft)]" id="stats"></ul>
      </div>
    </div>
  </section>

  <!-- Analytics Spoiler -->
  <section class="max-w-6xl mx-auto px-4 mt-4">
    <details id="analyticsPanel" class="glass p-4">
      <summary class="cursor-pointer font-bold">تحليلات (اضغط للإظهار)</summary>
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-2 rounded-lg border border-slate-700/40"><canvas id="prodChart"></canvas></div>
        <div class="p-2 rounded-lg border border-slate-700/40"><canvas id="secCountChart"></canvas></div>
        <div class="p-2 rounded-lg border border-slate-700/40"><canvas id="secPointsChart"></canvas></div>
      </div>
    </details>
  </section>

  <!-- Results -->
  <main class="max-w-6xl mx-auto px-4 mt-4">
    <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    <div id="noData" class="hidden alert mt-4">لا توجد نتائج مطابقة.</div>
  </main>

  <!-- Modal -->
  <dialog id="qaModal" class="modal">
    <div class="modal-box w-11/12 max-w-4xl glass">
      <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
      <div class="space-y-3">
        <h3 class="font-bold text-xl" id="mQuestion" dir="ltr" class="text-left"></h3>
        <div class="flex flex-wrap gap-2 items-center text-sm">
          <span class="chip" id="mSection"></span>
          <span class="chip" id="mDifficulty"></span>
          <span class="chip" id="mDate"></span>
          <div class="ml-auto flex gap-2 items-center">
            <!-- اختيار الصوت العربي -->
            <select id="arVoiceSelect" class="select select-bordered select-xs w-44">
              <option value="">صوت عربي (افتراضي)</option>
            </select>
            <button id="mSpeak" class="btn btn-xs btn-primary"><i class="fa-solid fa-volume-high mr-1"></i>اقرأ</button>
            <button id="mStop" class="btn btn-xs btn-ghost"><i class="fa-solid fa-stop mr-1"></i>إيقاف</button>
          </div>
        </div>
        <!-- scale داخل المودال -->
        <div id="mLevel" class="level-squares"></div>

        <div id="mAnswer" class="prose prose-invert max-w-none" dir="rtl"></div>
        <div id="mTags" class="mt-2 flex flex-wrap gap-2"></div>

        <div id="mMediaWrap" class="mt-3">
          <h4 class="font-bold mb-2">مرفقات</h4>
          <div id="mMedia" class="media-grid"></div>
        </div>

        <!-- اسئلة مشابهة -->
        <div id="mRelated" class="mt-3"></div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Global Stop TTS -->
  <button id="stopAll" class="btn btn-error btn-fab"><i class="fa-solid fa-stop"></i></button>

  <!-- Card Template -->
  <template id="cardTpl">
    <div class="glass card-hover border border-slate-800 p-4">
      <div class="flex items-start gap-3">
        <button class="btn btn-xs btn-ghost mt-1" data-open title="عرض"><i class="fa-solid fa-up-right-from-square"></i></button>
        <div class="flex-1">
          <h3 class="font-bold text-base text-left" data-q style="direction:ltr"></h3>
          <div class="text-xs text-left mt-1" data-sectionline></div>
          <div class="level-squares" data-level></div>
          <div class="mt-2 flex flex-wrap gap-2" data-tags></div>
        </div>
      </div>
    </div>
  </template>

  <script>
    /* ===== Helpers ===== */
    const els = {
      csvUrl: document.getElementById('csvUrl'),
      saveUrl: document.getElementById('saveUrl'),
      loadBtn: document.getElementById('loadBtn'),
      search: document.getElementById('searchInput'),
      sectionFilter: document.getElementById('sectionFilter'),
      difficultyFilter: document.getElementById('difficultyFilter'),
      favOnly: document.getElementById('favOnly'),
      tagsBar: document.getElementById('tagsBar'),
      stats: document.getElementById('stats'),
      results: document.getElementById('results'),
      noData: document.getElementById('noData'),
      tpl: document.getElementById('cardTpl'),
      prodChart: document.getElementById('prodChart'),
      secCountChart: document.getElementById('secCountChart'),
      secPointsChart: document.getElementById('secPointsChart'),
      modal: document.getElementById('qaModal'),
      mQuestion: document.getElementById('mQuestion'),
      mAnswer: document.getElementById('mAnswer'),
      mSection: document.getElementById('mSection'),
      mDifficulty: document.getElementById('mDifficulty'),
      mDate: document.getElementById('mDate'),
      mTags: document.getElementById('mTags'),
      mMediaWrap: document.getElementById('mMediaWrap'),
      mMedia: document.getElementById('mMedia'),
      mSpeak: document.getElementById('mSpeak'),
      mStop: document.getElementById('mStop'),
      stopAll: document.getElementById('stopAll'),
      sectionChips: document.getElementById('sectionChips'),
      mLevel: document.getElementById('mLevel'),
      mRelated: document.getElementById('mRelated'),
      analyticsPanel: document.getElementById('analyticsPanel'),
      arVoiceSelect: document.getElementById('arVoiceSelect')
    };

    /* LocalStorage keys */
    const LS_URL_KEY='study_csv_url';
    const LS_AR_VOICE='study_ar_voice';

    function decodeEntitiesDeep(s){
      if(s==null) return '';
      let cur = String(s), prev = null, i=0;
      while(i<3 && cur!==prev){
        prev = cur;
        const txt = document.createElement('textarea');
        txt.innerHTML = cur;
        cur = txt.value;
        i++;
      }
      return cur;
    }
    function htmlEscapeBasic(s){
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function colorEnglish(escaped){
      return escaped.replace(/[A-Za-z0-9#@._/%+\-]+(?:\s+[A-Za-z0-9#@._/%+\-]+)*/g,
        m => '<span class="en">'+m+'</span>');
    }
    function addArrows(html){
      html = html.replace(/<span class="en">\s*Increase\s*<\/span>/gi,
              '<span class="text-green-400">⬆️ <span class="en">Increase</span></span>');
      html = html.replace(/<span class="en">\s*Decrease\s*<\/span>/gi,
              '<span class="text-red-400">⬇️ <span class="en">Decrease</span></span>');
      html = html.replace(/\bIncrease\b/gi,
              '<span class="text-green-400">⬆️ <span class="en">Increase</span></span>');
      html = html.replace(/\bDecrease\b/gi,
              '<span class="text-red-400">⬇️ <span class="en">Decrease</span></span>');
      return html;
    }

    /* Stage flow: يحوّل "A => B => C" لسطر مراحل */
    function renderStageFlow(rawLine){
      const parts = rawLine.split(/\s*=>\s*/).filter(Boolean);
      const nodes = parts.map(p=> `<span class="stage-node">${htmlEscapeBasic(p)}</span>`).join('<span class="stage-arrow">⇒</span>');
      return `<div class="stage-flow" dir="ltr" role="list">${nodes}</div>`;
    }

    /* ==== Table parsing (Markdown-style) ==== */
    function isSepRow(line){
      return /^\s*\|?\s*:?-{3,}:?\s*(\|\s*:?-{3,}:?\s*)+\|?\s*$/.test(line);
    }
    function splitRow(line){
      let row = line.trim();
      if(row.startsWith('|')) row = row.slice(1);
      if(row.endsWith('|')) row = row.slice(0,-1);
      return row.split('|').map(c => c.trim());
    }
    function renderTableFromLines(lines, startIndex){
      const header = splitRow(lines[startIndex]);
      let i = startIndex + 2; // skip separator
      const body = [];
      while(i < lines.length && /\|/.test(lines[i])){
        body.push(splitRow(lines[i]));
        i++;
      }
      const ths = header.map(h=> `<th>${addArrows(colorEnglish(htmlEscapeBasic(h)))}</th>`).join('');
      const trs = body.map(r=>{
        const tds = r.map(c=> `<td>${addArrows(colorEnglish(htmlEscapeBasic(c)))}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      const html = `
        <div class="overflow-x-auto">
          <table class="qa-table table table-zebra w-full text-center">
            <thead><tr>${ths}</tr></thead>
            <tbody>${trs}</tbody>
          </table>
        </div>`;
      return { html, next: i - 1 };
    }

    /* تمييز "معلومات عامة" و "مثال" و "مهم" + بقية القواعد + الجداول */
    function formatAnswerText(raw){
      const s = decodeEntitiesDeep(raw);
      const lines = String(s||'').split(/\r?\n|\r/);
      const out = [];

      for(let i=0;i<lines.length;i++){
        const rawLine = lines[i];
        const trimmed = rawLine.trim();

        // Stage flow
        if(trimmed.includes('=>')){
          out.push(renderStageFlow(trimmed));
          continue;
        }

        // Markdown table detection
        if(/\|/.test(rawLine) && i+1 < lines.length && isSepRow(lines[i+1])){
          const tbl = renderTableFromLines(lines, i);
          out.push(tbl.html);
          i = tbl.next;
          continue;
        }

        const esc = htmlEscapeBasic(rawLine).replace(/^\s+/,'');

        if(/^ممنوع/.test(esc)){
          let rest = esc.replace(/^ممنوع\s*[:\-]?/, '');
          out.push('<span class="badge badge-error mr-2">ممنوع</span><span class="text-red-400">'+ addArrows(colorEnglish(rest.trimStart())) +'</span>');
          continue;
        }
        if(/^دورنا من ناحية التمريض/.test(esc)){
          let rest = esc.replace(/^دورنا من ناحية التمريض\s*[:\-]?/, '');
          out.push('<span class="badge badge-success mr-2">دورنا من ناحية التمريض</span><span class="text-green-400">'+ addArrows(colorEnglish(rest.trimStart())) +'</span>');
          continue;
        }
        if(/^يفضل/.test(esc)){
          let rest = esc.replace(/^يفضل\s*[:\-]?/, '');
          out.push('<span class="badge badge-info mr-2">يفضل</span><span class="text-blue-400">'+ addArrows(colorEnglish(rest.trimStart())) +'</span>');
          continue;
        }
        if(/^أفضل/.test(esc)){
          let rest = esc.replace(/^أفضل\s*[:\-]?/, '');
          out.push('<span class="badge badge-success mr-2">أفضل</span><span class="text-green-400">'+ addArrows(colorEnglish(rest.trimStart())) +'</span>');
          continue;
        }
        if(/^معلومات عامة/.test(esc)){
          let rest = esc.replace(/^معلومات عامة\s*[:\-]?/, '');
          out.push('<span class="badge-burgundy mr-2">معلومات عامة</span>'+ addArrows(colorEnglish(rest.trimStart())));
          continue;
        }
        if(/^مثال/.test(esc)){
          let rest = esc.replace(/^مثال\s*[:\-]?/, '');
          out.push('<span class="example-badge mr-2">مثال</span><span class="example-line">'+ addArrows(colorEnglish(rest.trimStart())) +'</span>');
          continue;
        }
        if(/^مهم/.test(esc)){
          let rest = esc.replace(/^مهم\s*[:\-]?/, '');
          out.push('<span class="badge-important mr-2">مهم</span><span class="important-line">'+ addArrows(colorEnglish(rest.trimStart())) +'</span>');
          continue;
        }

        out.push(addArrows(colorEnglish(esc)));
      }

      return out.join('<br>');
    }

    function formatQuestionText(raw){
      const s = decodeEntitiesDeep(raw);
      const esc = htmlEscapeBasic(s);
      return addArrows(esc);
    }
    function countPointsFromAnswer(raw){
      const s = decodeEntitiesDeep(raw);
      return String(s||'').split(/\r?\n|\r/).map(x=>x.trim()).filter(Boolean).length;
    }

    function sectionColors(section){
      const name = String(section||'عام');
      let h=0; for(let i=0;i<name.length;i++){ h=(h*31 + name.charCodeAt(i))>>>0; }
      h=h%360;
      const bg='hsla('+h+',70%,20%,0.35)', bd='hsla('+h+',80%,60%,0.65)', fg='hsla('+h+',90%,85%,0.95)';
      return {h,bg,bd,fg};
    }
    function tokenize(txt){
      return String(txt||'').toLowerCase().replace(/[^\w\u0600-\u06FF\s]/g,' ')
                  .split(/\s+/).filter(Boolean);
    }
    function toISODate(d){
      if(!d) return null;
      const m = String(d).match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
      if(!m) return null;
      const yyyy=m[1], mm=('0'+m[2]).slice(-2), dd=('0'+m[3]).slice(-2);
      return `${yyyy}-${mm}-${dd}`;
    }
    const linesToDifficulty = (pts)=> Math.max(1, Math.min(5, Math.ceil(pts/2)));

    /* ===== State ===== */
    let RAW=[], DATA=[], INDEX=null;
    const TAGS = new Set(), SECTIONS = new Set();

    const getCSVUrl=()=> localStorage.getItem(LS_URL_KEY)||'';
    const setCSVUrl=(url)=> localStorage.setItem(LS_URL_KEY, url);
    const getSavedArVoice=()=> localStorage.getItem(LS_AR_VOICE)||'';
    const setSavedArVoice=(name)=> localStorage.setItem(LS_AR_VOICE, name||'');

    function buildIndex(){
      INDEX = lunr(function(){
        this.ref('id');
        this.field('question'); this.field('answer'); this.field('tagsStr'); this.field('section');
        DATA.forEach(d=> this.add({id:d.id, question:d.question, answer:d.answer, tagsStr:d.tags.join(' '), section:d.section}));
      });
    }

    function normalizeRow(r, idx){
      const id = (r.id||'').trim() || String(idx+1);
      const question = decodeEntitiesDeep((r.question||'').trim());
      const answer = (r.answer||'').trim();
      const section = (r.section||'عام').trim();
      const givenDiff = parseInt(r.difficulty||'') || '';
      const addedAt = (r.addedAt||r.updatedAt||'').trim(); // للمودال فقط

      const pics = String(r.Pic||r.pic||'').trim();
      const videos = String(r.Video||r.video||'').trim();
      const legacy = String(r.media||r.mediaUrl||'').trim();
      const toArr = (s)=> s ? s.split(/[|,،\s]+/).filter(Boolean) : [];
      const media = [...toArr(pics), ...toArr(videos), ...toArr(legacy)];

      const tags = String(r.tags||'').split(/[|,،]/).map(t=>t.trim()).filter(Boolean);
      tags.forEach(t=>TAGS.add(t)); SECTIONS.add(section);

      const points = countPointsFromAnswer(answer);
      const difficulty = givenDiff || linesToDifficulty(points);

      return { id, question, answer, section, difficulty, addedAt, tags, media, points };
    }

    function filterAndRank(){
      const q = els.search.value.trim();
      const sec = els.sectionFilter.value;
      const diff = els.difficultyFilter.value;

      let idsOrder = null;
      if(q && INDEX){ idsOrder = INDEX.search(q).map(r=>r.ref); }

      let list = DATA.filter(d=>{
        if (sec && d.section !== sec) return false;
        if (diff && String(d.difficulty) !== String(diff)) return false;
        return true;
      });

      if(idsOrder){
        const pos = new Map(idsOrder.map((id,i)=>[id,i]));
        list.sort((a,b)=> (pos.get(a.id)??9999) - (pos.get(b.id)??9999));
      } else {
        list.sort((a,b)=> (b.addedAt||'').localeCompare(a.addedAt||'')); // ترتيب افتراضي
      }
      return list;
    }

    function renderStats(){
      const bySection={}, byTag={}, bySectionPoints={};
      let totalPoints=0;
      DATA.forEach(d=>{
        bySection[d.section]=(bySection[d.section]||0)+1;
        bySectionPoints[d.section]=(bySectionPoints[d.section]||0)+d.points;
        totalPoints += d.points;
        d.tags.forEach(t=> byTag[t]=(byTag[t]||0)+1);
      });
      const total=DATA.length, secCount=Object.keys(bySection).length, tagCount=Object.keys(byTag).length;

      const secLines = Object.keys(bySection).sort().map(sec=>{
        const sc = sectionColors(sec);
        const style = 'background:'+sc.bg+';border-color:'+sc.bd+';color:'+sc.fg+';';
        return '<li class="mt-1"><span class="chip" style="'+style+'">'+sec+
               '</span> — <strong>'+bySection[sec]+'</strong> سؤال • <strong>'+ (bySectionPoints[sec]||0) +'</strong> نقطة</li>';
      }).join('');

      els.stats.innerHTML =
        '<li>المجموع: <strong>'+total+'</strong> سؤال</li>'+
        '<li>إجمالي النقاط: <strong>'+totalPoints+'</strong></li>'+
        '<li>الأقسام: <strong>'+secCount+'</strong></li>'+
        '<li>الوسوم: <strong>'+tagCount+'</strong></li>'+
        '<li class="mt-2">حسب القسم:</li>'+ secLines;
    }

    function renderFilters(){
      const cur = els.sectionFilter.value;
      els.sectionFilter.innerHTML = '<option value="">كل الأقسام</option>' +
        [...SECTIONS].sort().map(s=>'<option '+(s===cur?'selected':'')+' value="'+s+'">'+s+'</option>').join('');

      // Tags bar
      const active = new Set(Array.from(document.querySelectorAll('#tagsBar button[data-active="1"]')).map(b=>b.dataset.tag));
      els.tagsBar.innerHTML = '';
      [...TAGS].sort().forEach(tag=>{
        const btn = document.createElement('button');
        btn.className='btn btn-xs btn-outline'; btn.textContent='#'+tag; btn.dataset.tag=tag;
        btn.dataset.active = active.has(tag)?'1':'0';
        if(btn.dataset.active==='1') btn.classList.add('btn-info');
        btn.addEventListener('click', ()=>{
          btn.dataset.active = btn.dataset.active==='1'?'0':'1';
          if(btn.dataset.active==='1') btn.classList.add('btn-info'); else btn.classList.remove('btn-info');
          render();
        });
        els.tagsBar.appendChild(btn);
      });

      // Section Sticky Chips
      els.sectionChips.innerHTML = '';
      const addChip = (txt, val)=>{
        const chip = document.createElement('button');
        chip.className = 'chip hover:border-sky-400 hover:text-sky-200';
        chip.textContent = txt; chip.dataset.val = val;
        chip.addEventListener('click', ()=>{
          els.sectionFilter.value = val;
          render();
        });
        els.sectionChips.appendChild(chip);
      };
      addChip('الكل','');
      [...SECTIONS].sort().forEach(s=> addChip(s, s));
    }

    const getActiveTags=()=> Array.from(document.querySelectorAll('#tagsBar button[data-active="1"]')).map(b=>b.dataset.tag);

    /* ========== Media helpers ========== */
    function gdriveIdFromUrl(url){
      const m1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      const m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      return (m1 && m1[1]) || (m2 && m2[1]) || null;
    }
    function buildMediaNode(url){
      const u = url.trim();
      const wrap = document.createElement('div');

      if(/\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(u)){
        const img = document.createElement('img');
        img.src = u; img.referrerPolicy="no-referrer"; img.loading="lazy";
        img.className="w-full rounded-lg";
        wrap.appendChild(img); return wrap;
      }
      if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(u)){
        const dv = document.createElement('div'); dv.className="aspect-video";
        const video = document.createElement('video'); video.controls=true; video.src=u; video.className="rounded-lg";
        dv.appendChild(video); wrap.appendChild(dv); return wrap;
      }
      if(/drive\.google\.com/i.test(u)){
        const id = gdriveIdFromUrl(u);
        const src = id ? `https://drive.google.com/file/d/${id}/preview` : u;
        const dv = document.createElement('div'); dv.className="aspect-video";
        const iframe = document.createElement('iframe');
        iframe.src = src; iframe.allow="autoplay"; iframe.className="rounded-lg"; iframe.loading="lazy";
        dv.appendChild(iframe); wrap.appendChild(dv); return wrap;
      }
      const a = document.createElement('a'); a.href=u; a.target="_blank"; a.rel="noopener"; a.textContent=u; a.className="link link-info break-all";
      wrap.appendChild(a); return wrap;
    }

    function difficultySquaresHTML(level){
      level = Math.max(1, Math.min(5, parseInt(level)||1));
      const colors = ['#22c55e','#16a34a','#eab308','#f97316','#ef4444'];
      let html = '';
      for(let i=1;i<=5;i++){
        const color = i<=level ? ` style="background:${colors[i-1]};opacity:1;border-color:transparent"` : '';
        html += `<span class="${i<=level?'active':''}"${color}></span>`;
      }
      return html;
    }

    function findRelated(item, count=4){
      const toks = new Set(tokenize(item.question+' '+item.answer+' '+(item.tags||[]).join(' ')));
      const same = DATA.filter(d=> d.id!==item.id && d.section===item.section);
      const scored = same.map(d=>{
        const b = new Set(tokenize(d.question+' '+d.answer+' '+(d.tags||[]).join(' ')));
        let inter=0; b.forEach(x=>{ if(toks.has(x)) inter++; });
        let s = inter / (Math.sqrt(toks.size)*Math.sqrt(b.size) || 1);
        if (d.tags?.some(t=> item.tags?.includes(t))) s += 0.15;
        return {d,s};
      }).filter(x=> x.s>0.05).sort((x,y)=> y.s-x.s);
      return scored.slice(0,count).map(x=>x.d);
    }

    function openModal(item){
      els.mQuestion.innerHTML = formatQuestionText(item.question);
      els.mAnswer.innerHTML = formatAnswerText(item.answer);
      els.mTags.innerHTML = '';
      (item.tags||[]).forEach(t=>{ const span=document.createElement('span'); span.className='chip'; span.textContent='#'+t; els.mTags.appendChild(span); });

      const sc = sectionColors(item.section);
      els.mSection.textContent = item.section;
      els.mSection.style.background=sc.bg; els.mSection.style.borderColor=sc.bd; els.mSection.style.color=sc.fg;

      els.mDifficulty.textContent = 'تصنيف: '+item.difficulty+'/5';
      els.mLevel.innerHTML = difficultySquaresHTML(item.difficulty);
      els.mDate.textContent = item.addedAt ? ('تاريخ الإضافة: ' + item.addedAt) : '';

      els.mMedia.innerHTML = '';
      els.mMediaWrap.style.display = item.media && item.media.length ? '' : 'none';
      (item.media||[]).forEach(url=> els.mMedia.appendChild(buildMediaNode(url)));

      const rel = findRelated(item, 6);
      if(rel.length){
        els.mRelated.innerHTML =
          '<div class="text-sm text-[var(--ink-soft)] mb-2">أسئلة مشابهة:</div>'+
          '<div class="flex flex-wrap gap-2">' +
          rel.map(r=> `<button class="btn btn-xs btn-outline" data-jump="${r.id}">${htmlEscapeBasic(r.question)}</button>`).join('') +
          '</div>';
        els.mRelated.querySelectorAll('button[data-jump]').forEach(b=>{
          b.addEventListener('click',()=>{
            els.modal.close();
            const target = DATA.find(x=> x.id===b.dataset.jump);
            if(target){ openModal(target); }
          });
        });
      }else{
        els.mRelated.innerHTML = '';
      }

      // جهّز قائمة الأصوات العربية
      populateArabicVoiceSelect();

      // تTS بدون قول "السؤال/الإجابة" + استخدام الصوت المختار
      els.mSpeak.onclick = ()=> {
        const text = decodeEntitiesDeep(item.question) + '. ' + decodeEntitiesDeep(item.answer).replace(/\r?\n|\r/g, '. ');
        const selectedName = els.arVoiceSelect.value || getSavedArVoice();
        speakQA(text, selectedName);
      };
      els.mStop.onclick = ()=> window.speechSynthesis.cancel();

      els.modal.showModal();
    }

    function render(){
      const list = filterAndRank();
      els.results.innerHTML='';
      if(!list.length){ els.noData.classList.remove('hidden'); return; } else els.noData.classList.add('hidden');

      list.forEach(item=>{
        const node = els.tpl.content.cloneNode(true);
        const qEl=node.querySelector('[data-q]');
        const secLine=node.querySelector('[data-sectionline]');
        const lvl=node.querySelector('[data-level]');
        const openBtn=node.querySelector('[data-open]');

        qEl.innerHTML = formatQuestionText(item.question);
        const sc = sectionColors(item.section);
        secLine.textContent = item.section;
        secLine.style.color = sc.bd;
        secLine.classList.add('text-xs');

        lvl.innerHTML = difficultySquaresHTML(item.difficulty);

        const tagsEl=node.querySelector('[data-tags]');
        (item.tags||[]).forEach(t=>{ const span=document.createElement('span'); span.className='chip'; span.textContent='#'+t; tagsEl.appendChild(span); });

        openBtn.addEventListener('click', ()=> openModal(item));

        const card = node.firstElementChild;
        card.dataset.cardId=item.id;
        card.style.borderLeftColor=sc.bd; card.style.borderLeftWidth='3px'; card.style.borderLeftStyle='solid';

        els.results.appendChild(node);
      });
    }

    function populateFromCSV(rows){
      RAW = rows || []; TAGS.clear(); SECTIONS.clear();
      DATA = RAW.map(normalizeRow);
      buildIndex(); renderStats(); renderFilters(); render(); ensureCharts();
    }

    function loadCSV(url){
      return new Promise((resolve,reject)=>{
        if(!url){
          const csv =
'id,question,answer,tags,section,difficulty,addedAt,Pic,Video\n'
+'1,What is Iron Deficiency Anemia?,A microcytic hypochromic anemia due to low iron.\nممنوع: delaying search for source of bleeding\nمعلومات عامة: Happens more in women\nمهم: screen for bleeding\n| Item | Dose | Note |\n| --- | --- | --- |\n| Iron | 60 mg | daily |\n| Vit C | 500 mg | with iron |\nInitial => Compensatory => Progressive => Irreversible,hematology,Internal Medicine,,2025-10-10,https://drive.google.com/file/d/1abcDEF123/preview,\n'
+'2,Best initial test for IDA?,CBC with low MCV/MCH.\nيفضل: confirm with ferritin\nمثال: Hb 9 with low MCV,hematology|labs,Internal Medicine,,2025-10-10,,https://drive.google.com/file/d/1ghiJKL456/preview\n'
+'3,ORS composition?,WHO: Na ~75 mEq/L; Osm ~245 mOsm/L.\nأفضل: glucose 75 mmol/L\n| Component | Amount |\n| --- | --- |\n| Na | ~75 mEq/L |\n| Osm | ~245 mOsm/L |,pediatrics|fluids,Pediatrics,3,2025-10-12,,\n'
+'4,Acute asthma first-line?,SABA + oxygen; add steroids early. Increase response expected.,respiratory|emergency,Emergency,,2025-09-21,,\n'
+'5,GCS verbal response 3?,Inappropriate words. Decrease in score.,neuro|scores,Emergency,1,2025-09-01,,\n'
+'6,Antibiotic for strep pharyngitis?,Penicillin or amoxicillin 10 days.,ENT|antibiotics,ENT,2,2025-08-18,,';
          Papa.parse(csv,{header:true,complete:(res)=>resolve(res.data)}); return;
        }
        Papa.parse(url,{download:true,header:true,skipEmptyLines:true,
          complete:(res)=>resolve(res.data), error:(err)=>reject(err)});
      });
    }

    /* ===== Charts ===== */
    const charts = { prod:null, secCount:null, secPoints:null };

    function renderCharts(){
      const byDatePoints = {};
      const bySectionCount = {};
      const bySectionPoints = {};
      DATA.forEach(d=>{
        const iso = toISODate(d.addedAt);
        if(iso){ byDatePoints[iso] = (byDatePoints[iso]||0) + d.points; }
        bySectionCount[d.section] = (bySectionCount[d.section]||0) + 1;
        bySectionPoints[d.section] = (bySectionPoints[d.section]||0) + d.points;
      });

      const dates = Object.keys(byDatePoints).sort();
      const points = dates.map(k=> byDatePoints[k]);

      const secLabels = Object.keys(bySectionCount).sort();
      const secCounts = secLabels.map(k=> bySectionCount[k]);
      const secPts = secLabels.map(k=> bySectionPoints[k]);

      for (const k of Object.keys(charts)){ if(charts[k]){ charts[k].destroy(); charts[k]=null; } }

      charts.prod = new Chart(els.prodChart.getContext('2d'), {
        type:'line',
        data:{ labels:dates, datasets:[{ label:'نقاط يومية', data:points, tension:0.3 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:true} } }
      });

      charts.secCount = new Chart(els.secCountChart.getContext('2d'), {
        type:'doughnut',
        data:{ labels:secLabels, datasets:[{ label:'عدد الأسئلة', data:secCounts }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} } }
      });

      charts.secPoints = new Chart(els.secPointsChart.getContext('2d'), {
        type:'doughnut',
        data:{ labels:secLabels, datasets:[{ label:'النقاط', data:secPts }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} } }
      });
    }

    /* رسم المخططات فقط عند فتح الـ details لضمان المقاسات */
    function ensureCharts(){
      if (els.analyticsPanel.open) {
        renderCharts();
      } else {
        els.analyticsPanel.addEventListener('toggle', ()=>{
          if (els.analyticsPanel.open) renderCharts();
        }, { once:true });
      }
    }

    /* ===== TTS ===== */
    let VOICES = [];
    function loadVoices(){ VOICES = window.speechSynthesis.getVoices(); }
    loadVoices();
    if (typeof speechSynthesis !== 'undefined'){
      speechSynthesis.onvoiceschanged = ()=>{
        loadVoices();
        // حدّث قائمة الأصوات العربية إن كان المودال مفتوح
        if (els.modal?.open) populateArabicVoiceSelect();
      };
    }

    function pickArabicMaleVoice(){
      const cand = VOICES.filter(v=> v.lang && v.lang.toLowerCase().startsWith('ar'));
      const maleHints = ['naayf','tarik','maged','hamza','hassan','omar','ahmad','microsoft','saudi','ksa','male'];
      const femaleHints = ['salma','zehra','laila','hoda','female'];
      const score = (v)=>{
        let s=0;
        const name=(v.name||'').toLowerCase();
        const lang=(v.lang||'').toLowerCase();
        maleHints.forEach(h=>{ if(name.includes(h)) s+=5; });
        if(lang.includes('sa')) s+=3; // ar-SA
        femaleHints.forEach(h=>{ if(name.includes(h)) s-=6; });
        return s;
      };
      cand.sort((a,b)=> score(b)-score(a));
      return cand[0] || null;
    }
    function pickENVoice(){
      const cand = VOICES.filter(v=> v.lang && v.lang.toLowerCase().startsWith('en'));
      return cand.find(v=> /us|gb/.test((v.lang||'').toLowerCase())) || cand[0] || null;
    }

    // تعبئة قائمة الأصوات العربية + حفظ الاختيار
    function populateArabicVoiceSelect(){
      const prev = els.arVoiceSelect.value || getSavedArVoice() || '';
      const arVoices = VOICES.filter(v=> v.lang && v.lang.toLowerCase().startsWith('ar'));
      // نظّف القائمة (مع ترك أول خيار افتراضي)
      els.arVoiceSelect.innerHTML = '<option value="">صوت عربي (افتراضي)</option>';
      arVoices.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
        els.arVoiceSelect.appendChild(opt);
      });
      // اختر المحفوظ إن وُجد
      if(prev){
        const found = Array.from(els.arVoiceSelect.options).find(o=> o.value===prev);
        if(found) els.arVoiceSelect.value = prev;
      }
    }
    els.arVoiceSelect?.addEventListener('change', ()=>{
      setSavedArVoice(els.arVoiceSelect.value || '');
    });

    function splitLangSegments(text){
      const parts = [];
      const re = /([A-Za-z0-9#@._/%+\-]+|\s+|[^\sA-Za-z0-9#@._/%+\-]+)/g;
      let buffer='', mode=null;
      for(const m of text.matchAll(re)){
        const tok = m[0];
        const isEN = /^[A-Za-z0-9#@._/%+\-]+$/.test(tok);
        const isSpace = /^\s+$/.test(tok);
        const cur = isEN ? 'en' : 'ar';
        if(isSpace){ buffer += tok; continue; }
        if(mode===null){ mode=cur; buffer=tok; }
        else if(cur===mode){ buffer += tok; }
        else{ parts.push({lang:mode, text:buffer}); mode=cur; buffer=tok; }
      }
      if(buffer) parts.push({lang:mode||'ar', text:buffer});
      return parts;
    }

    // اسم صوت عربي اختياري
    function speakQA(fullText, arabicVoiceName=''){
      if(!('speechSynthesis' in window)){ alert('المتصفح لا يدعم تحويل النص إلى كلام.'); return; }
      window.speechSynthesis.cancel();
      const segs = splitLangSegments(fullText);

      // حدّد الصوت العربي
      let arVoice = null;
      if(arabicVoiceName){
        arVoice = VOICES.find(v=> (v.name||'')===arabicVoiceName) || null;
      }
      if(!arVoice){ arVoice = pickArabicMaleVoice(); }

      const enVoice = pickENVoice();

      segs.forEach(seg=>{
        const u = new SpeechSynthesisUtterance(seg.text);
        if(seg.lang==='en'){
          if(enVoice){ u.voice=enVoice; u.lang=enVoice.lang; } else { u.lang='en-US'; }
        }else{
          if(arVoice){ u.voice=arVoice; u.lang=arVoice.lang; } else { u.lang='ar'; }
        }
        u.rate=1.0; u.pitch=1.0;
        window.speechSynthesis.speak(u);
      });
    }

    /* ===== Events ===== */
    document.getElementById('saveUrl').addEventListener('click', ()=> setCSVUrl(els.csvUrl.value.trim()));
    document.getElementById('loadBtn').addEventListener('click', async ()=>{
      const url = els.csvUrl.value.trim() || getCSVUrl();
      try{ const rows = await loadCSV(url); populateFromCSV(rows); }
      catch(e){ console.error(e); alert('تعذر تحميل CSV. تأكد من الرابط أو إعدادات النشر.'); }
    });
    els.search.addEventListener('input',()=>render());
    els.sectionFilter.addEventListener('change',()=>render());
    els.difficultyFilter.addEventListener('change',()=>render());
    els.stopAll.addEventListener('click', ()=> window.speechSynthesis.cancel());

    // Init
    (async function init(){
      els.csvUrl.value = getCSVUrl();
      try{ const rows = await loadCSV(getCSVUrl()); populateFromCSV(rows); }
      catch(e){ /* تجربة عند الضغط على تحديث */ }
    })();
  </script>
</body>
</html>
