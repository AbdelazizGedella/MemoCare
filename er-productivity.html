<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ â€” ER Productivity | Twilight Glass</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Chart.js + Matrix plugin (Ù„Ù„Ù€ Heatmap) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@3.0.0/dist/chartjs-chart-matrix.min.js"></script>

  <style>
    :root {
      --bg1: #020617;
      --bg2: #020617;
      --bg3: #0f172a;
      --glass-bg: rgba(15,23,42,0.85);
      --glass-stroke: rgba(148,163,184,0.4);
      --accent: #0ea5e9;
      --accent-soft: rgba(56,189,248,0.15);
      --muted: #94a3b8;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(1000px 600px at 110% 100%, rgba(14,165,233,0.18), transparent 60%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg3) 100%);
      color: #e5e7eb;
      min-height: 100vh;
    }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 18px;
      border: 1px solid var(--glass-stroke);
      box-shadow:
        0 22px 45px rgba(15,23,42,0.7),
        0 0 0 1px rgba(15,23,42,0.9),
        inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .btn {
      background: linear-gradient(135deg, #0ea5e9, #2563eb);
      color: white;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      box-shadow: 0 10px 20px rgba(15,23,42,0.7);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .btn:disabled {
      opacity: .45;
      cursor: not-allowed;
      box-shadow: none;
    }
    .btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(15,23,42,0.9);
    }
    .pill {
      background: rgba(15,23,42,0.7);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
    }
    .tiny {
      font-size: 0.75rem;
      line-height: 1.1rem;
      color: var(--muted);
    }
    .note {
      color: var(--muted);
    }
    .glass-title {
      background: linear-gradient(135deg, rgba(56,189,248,0.16), rgba(37,99,235,0.16));
      border-bottom: 1px solid rgba(148,163,184,0.45);
    }
    .table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,0.9);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.96));
    }
    th, td {
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 0.75rem;
      letter-spacing: 0.02em;
    }
    .ctas-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2.2rem;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      border: 1px solid rgba(15,23,42,0.9);
    }
    .ctas-1 { background: rgba(239,68,68,0.12); color:#fecaca; }
    .ctas-2 { background: rgba(59,130,246,0.12); color:#bfdbfe; }
    .ctas-3 { background: rgba(250,204,21,0.12); color:#fef9c3; }
    .ctas-4 { background: rgba(34,197,94,0.12); color:#bbf7d0; }
    .ctas-5 { background: rgba(249,250,251,0.08); color:#e5e7eb; }
    .ctas-unknown { background: rgba(148,163,184,0.18); color:#e5e7eb; }

    .badge-soft {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.7rem;
      border: 1px solid rgba(148,163,184,0.55);
    }
  </style>
</head>
<body class="px-4 py-6 sm:px-6 lg:px-10">
  <main class="max-w-7xl mx-auto space-y-6">
    <header class="glass p-5 sm:p-6 lg:p-7">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="space-y-2">
          <h1 class="text-2xl sm:text-3xl font-bold text-cyan-200 flex items-center gap-2">
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-cyan-500/15 border border-cyan-400/40 text-cyan-300">
              <i class="fa-solid fa-stethoscope"></i>
            </span>
            Ù„ÙˆØ­Ø© Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ â€” ER Productivity
          </h1>
          <p class="tiny max-w-2xl">
            Ø§Ø±ÙØ¹ Ù…Ù„Ù <span class="font-semibold">ER VISITS REPORT.xlsx</span>ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡ÙŠØ­Ø³Ø¨:
            Ø¥Ù†ØªØ§Ø¬ÙŠØ© ÙƒÙ„ Ø·Ø¨ÙŠØ¨ØŒ ØªÙˆØ²ÙŠØ¹ CTASØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…ØŒ Heatmap Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ù„ÙŠÙˆÙ… Ã— Ø§Ù„Ø³Ø§Ø¹Ø©)ØŒ
            Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´ÙŠÙØªØ§ØªØŒ ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø­Ø³Ø¨ Count & Acuity â€” Ù…Ø¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø£ÙŠ Ø³Ø¬Ù„ <b>Canceled</b>.
          </p>
        </div>
        <div class="flex flex-col items-start sm:items-end gap-3">
          <label class="w-full sm:w-auto">
            <span class="tiny block mb-1">Ù…Ù„Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (XLSX)</span>
            <input id="fileInput" type="file"
                   accept=".xlsx,.xls"
                   class="block w-full text-sm text-slate-200 file:mr-3 file:py-2 file:px-4
                          file:rounded-full file:border-0 file:text-sm file:font-semibold
                          file:bg-cyan-500/90 file:text-slate-900
                          hover:file:bg-cyan-400 cursor-pointer" />
          </label>
          <div class="flex flex-wrap gap-2">
            <button id="processBtn" class="btn px-4 py-2 text-sm" type="button" disabled>
              <i class="fa-solid fa-play"></i>
              ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„
            </button>
            <button id="resetBtn" class="btn px-4 py-2 text-sm bg-slate-800 !border-slate-600"
                    style="background: radial-gradient(circle at top, #1e293b, #020617);"
                    type="button">
              <i class="fa-solid fa-rotate-right"></i>
              ØªÙØ±ÙŠØº
            </button>
          </div>
        </div>
      </div>

      <div class="mt-5 grid gap-4 md:grid-cols-2">
        <div class="glass p-4">
          <div class="tiny mb-1 font-semibold text-cyan-200">
            Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø¯Ù‘:
          </div>
          <ul class="tiny list-disc pr-5 space-y-1">
            <li>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„ÙØ±ÙŠØ¯Ø© = <span class="font-semibold">MRN + REGISTRATION DATE</span>.</li>
            <li>Ø£ÙŠ Ø³Ø¬Ù„ ÙÙŠÙ‡ <b>DISH. TYPE</b> ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© <b>Cancel</b> ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡ ØªÙ…Ø§Ù…Ù‹Ø§ Ù…Ù† <b>ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</b>.</li>
            <li>Ù„Ùˆ Ù†ÙØ³ Ø§Ù„Ù…Ø±ÙŠØ¶ (MRN) Ù„Ù‡ Ø£ÙƒØªØ± Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… â†’ ÙŠØªØ­Ø³Ø¨ ÙƒÙ€ Ø²ÙŠØ§Ø±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… (Multi-Visits)ØŒ
              Ù„ÙƒÙ† ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ùˆ Heatmap ÙˆØ§Ù„Ø´ÙŠÙØªØ§Øª Ø¨Ù†Ø­Ø³Ø¨ <b>Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø© ÙÙ‚Ø·</b> Ù…Ø¹ ØªÙØ¶ÙŠÙ„ Ø§Ù„ØµÙ Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø§Ø³Ù… Ø¯ÙƒØªÙˆØ±.
            </li>
          </ul>
        </div>
        <div class="glass p-4">
          <div class="tiny mb-1 font-semibold text-cyan-200">
            ÙˆØ²Ù† Ø§Ù„Ù€ Acuity (ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡):
          </div>
          <p class="tiny">
            ÙŠØªÙ… Ø­Ø³Ø§Ø¨ <b>Weighted Score</b> Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨ ÙƒØ§Ù„ØªØ§Ù„ÙŠ (Ù…Ø¬Ù…ÙˆØ¹ Ø£ÙˆØ²Ø§Ù† CTAS Ù„ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© ÙØ±ÙŠØ¯Ø© Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ù†Ø©):
          </p>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="ctas-badge ctas-1">CTAS 1 = 5</span>
            <span class="ctas-badge ctas-2">CTAS 2 = 4</span>
            <span class="ctas-badge ctas-3">CTAS 3 = 3</span>
            <span class="ctas-badge ctas-4">CTAS 4 = 2</span>
            <span class="ctas-badge ctas-5">CTAS 5 = 1</span>
          </div>
          <p class="tiny mt-2">
            <b>Average Acuity</b> = Weighted Score Ã· Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨ÙŠØ¨.
            Ø§Ù„ØªØ±ØªÙŠØ¨ Ø£Ø³Ø§Ø³Ù‹Ø§ Ø­Ø³Ø¨ <b>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©</b>ØŒ Ø«Ù… <b>Weighted Score</b> Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„.
            Ø²Ø± <b>ØªØµØ¯ÙŠØ± Excel</b> ÙŠØ·Ù„Ø¹ Ø´ÙŠØª <b>Doctors_Count_Acuity</b> Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚.
          </p>
        </div>
      </div>
    </header>

    <!-- Action bar -->
    <section class="glass p-5 sm:p-6">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div class="flex flex-wrap gap-3 items-center">
          <div class="pill px-3 py-2 flex items-center gap-2">
            <i class="fa-solid fa-user-doctor text-cyan-300"></i>
            <span class="tiny">ØªØµÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¨:</span>
            <select id="doctorSelect"
                    class="bg-transparent border-none focus:outline-none text-sm text-slate-100">
              <option value="__ALL__">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</option>
            </select>
          </div>

          <!-- Ø¥Ø®ÙØ§Ø¡ Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØµÙ†ÙŠÙ -->
          <div class="pill px-3 py-2 flex items-center gap-2 max-w-xs md:max-w-md">
            <i class="fa-solid fa-user-slash text-pink-300"></i>
            <span class="tiny hidden sm:inline">Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„ØªØµÙ†ÙŠÙ:</span>
            <input
              id="hideNamesInput"
              type="text"
              class="flex-1 bg-transparent border-b border-slate-600 focus:outline-none text-[0.7rem] sm:text-xs text-slate-100 placeholder-slate-500"
              placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨ÙØ§ØµÙ„Ø© ,"
            />
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="exportExcelBtn" class="btn px-4 py-2 text-sm" type="button" disabled>
            <i class="fa-regular fa-file-excel"></i>
            ØªØµØ¯ÙŠØ± Excel
          </button>
          <button id="exportChartsBtn" class="btn px-4 py-2 text-sm" type="button" disabled>
            <i class="fa-regular fa-image"></i>
            ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ø§Ø±Øª
          </button>
        </div>
      </div>
      <p class="tiny mt-3">
        * Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: <code>MRN, PATIENT NAME, DOCTOR, REGISTRATION DATE, REGISTRATION TIME, CTAS TYPE, DISH. TYPE, FINAL DIAGNOSIS, Diagnosis Code</code>
        + Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ (Doctor ID / Code) ÙˆØ¹Ù…ÙˆØ¯ Ø§Ù„Ø¹Ù…Ø± (AGE) Ø£Ùˆ DOB Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø´ÙŠØª.
      </p>
    </section>

    <!-- KPIs Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <section class="grid gap-4 md:grid-cols-5">
      <div class="glass p-5">
        <div class="tiny">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø®Ø§Ù…)</div>
        <div id="kpiTotal" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© (Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Canceled)</div>
        <div id="kpiUnique" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø±ÙŠØ¶/Ø§Ù„ÙŠÙˆÙ…</div>
        <div id="kpiDupes" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Ø³Ø¬Ù„Ø§Øª Ø¨Ø¯ÙˆÙ† CTAS TYPE (ØºÙŠØ± Canceled)</div>
        <div id="kpiNoCtas" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Ø¹Ø¯Ø¯ Canceled (Ù…Ø³ØªØ¨Ø¹Ø¯Ø©)</div>
        <div id="kpiCanceled" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
    </section>

    <!-- KPIs Ø¥Ø¶Ø§ÙÙŠØ© -->
    <section class="grid gap-4 md:grid-cols-6">
      <div class="glass p-5">
        <div class="tiny">Groups Multi-Visit (MRN + Date)</div>
        <div id="kpiMultiGroups" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Extra Visits (Ù†ÙØ³ Ø§Ù„Ù…Ø±ÙŠØ¶/Ø§Ù„ÙŠÙˆÙ…)</div>
        <div id="kpiExtraVisits" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Top Diagnosis</div>
        <div id="kpiTopDx" class="text-lg font-bold text-white mt-1">â€”</div>
        <div id="kpiTopDxCount" class="tiny mt-1"></div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Top Doctor</div>
        <div id="kpiTopDoctor" class="text-lg font-bold text-white mt-1">â€”</div>
        <div id="kpiTopDoctorCount" class="tiny mt-1"></div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙŠÙØªØ§Øª (Doctor + Date)</div>
        <div id="kpiTotalShifts" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
      <div class="glass p-5">
        <div class="tiny">Ø­Ø§Ù„Ø§Øª Ø¨Ø¯ÙˆÙ† Final Diagnosis (ØºÙŠØ± Canceled)</div>
        <div id="kpiNoFinalDx" class="text-3xl font-bold text-white mt-1">0</div>
      </div>
    </section>

    <!-- Charts: Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ + CTAS Mix -->
    <section class="grid gap-4 lg:grid-cols-2">
      <div class="glass p-5">
        <div class="glass-title px-4 py-2 -mx-4 -mt-5 mb-4 rounded-t-[16px] flex items-center gap-2">
          <i class="fa-solid fa-chart-column text-cyan-300"></i>
          <h2 class="font-semibold text-cyan-200">Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ (Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©)</h2>
        </div>
        <canvas id="doctorBar" class="cursor-pointer"></canvas>
        <p class="tiny mt-2">ğŸ–±ï¸ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ø·Ø¨ÙŠØ¨ Ù„ØªØµÙÙŠØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©).</p>
      </div>

      <div class="glass p-5">
        <div class="glass-title px-4 py-2 -mx-4 -mt-5 mb-4 rounded-t-[16px] flex items-center gap-2">
          <i class="fa-solid fa-chart-column text-cyan-300"></i>
          <h2 class="font-semibold text-cyan-200">ØªÙˆØ²ÙŠØ¹ CTAS (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯)</h2>
        </div>
        <canvas id="ctasBar"></canvas>
      </div>
    </section>

    <!-- Heatmap ÙÙ‚Ø· Ø¨Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© -->
    <section class="glass p-5">
      <div class="glass-title px-4 py-2 -mx-4 -mt-5 mb-4 rounded-t-[16px] flex items-center gap-2">
        <i class="fa-solid fa-fire-flame-curved text-cyan-300"></i>
        <h2 class="font-semibold text-cyan-200">Registration Heatmap â€” Day Ã— Hour</h2>
      </div>
      <div class="w-full" style="height:420px;">
        <canvas id="regHeatmap"></canvas>
      </div>
      <p class="tiny mt-2">
        ÙƒÙ„ Ø®Ù„ÙŠØ© = Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø³Ø§Ø¹Ø© Ù…Ø­Ø¯Ø¯Ø© Ã— ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ù…Ø±ÙŠØ¶/ÙŠÙˆÙ…ØŒ Ù…Ø¹ ØªÙØ¶ÙŠÙ„ Ø§Ù„ØµÙ Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø§Ø³Ù… Ø·Ø¨ÙŠØ¨).
        Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø£ØµÙØ± (Ø²Ø­Ù…Ø© Ù‚Ù„ÙŠÙ„Ø©) Ù„Ù„Ø£Ø­Ù…Ø± (Ø²Ø­Ù…Ø© Ø¹Ø§Ù„ÙŠØ©).
      </p>
    </section>

    <!-- Ranking -->
    <section class="glass p-5">
      <div class="glass-title px-4 py-2 -mx-4 -mt-5 mb-4 rounded-t-[16px] flex items-center gap-2">
        <i class="fa-solid fa-ranking-star text-cyan-300"></i>
        <h2 class="font-semibold text-cyan-200">ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ (Count & Acuity)</h2>
      </div>
      <div class="table-wrap">
        <table class="w-full text-sm">
          <thead class="text-cyan-200">
            <tr class="border-b border-slate-700/80">
              <th class="p-2 text-right">#</th>
              <th class="p-2 text-right">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
              <th class="p-2 text-right">Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
              <th class="p-2 text-right">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©</th>
              <th class="p-2 text-right">CTAS 1</th>
              <th class="p-2 text-right">CTAS 2</th>
              <th class="p-2 text-right">CTAS 3</th>
              <th class="p-2 text-right">CTAS 4</th>
              <th class="p-2 text-right">CTAS 5</th>
              <th class="p-2 text-right">Average Acuity</th>
              <th class="p-2 text-right">Weighted Score</th>
              <th class="p-2 text-right">Ø§Ù„Ø´ÙŠÙØªØ§Øª</th>
            </tr>
          </thead>
          <tbody id="rankBody"></tbody>
        </table>
      </div>
      <p class="tiny mt-2">
        * Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© ÙÙŠ Ù…Ø±Ø¨Ø¹ "Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„ØªØµÙ†ÙŠÙ" ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆÙ…Ù† Ø´ÙŠØª Excel Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Doctors_Count_Acuity ÙÙ‚Ø·.
      </p>
      <details class="mt-3">
        <summary class="cursor-pointer pill px-3 py-2 inline-flex items-center gap-2 tiny">
          <i class="fa-solid fa-circle-question"></i>
          Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹ Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
        </summary>
        <div class="mt-2 tiny note leading-6">
          <ul class="list-disc pr-5 space-y-1">
            <li>Ø£ÙˆÙ„ Ù…Ø¹ÙŠØ§Ø± ØªØ±ØªÙŠØ¨ = <b>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©</b> Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨ (Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Canceled).</li>
            <li>Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„ ÙŠØªÙ… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ <b>Weighted Score</b> (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ù„ÙƒÙ„ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨).</li>
            <li>Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:
              <span class="badge-soft">CTAS 1 = 5</span>ØŒ
              <span class="badge-soft">CTAS 2 = 4</span>ØŒ
              <span class="badge-soft">CTAS 3 = 3</span>ØŒ
              <span class="badge-soft">CTAS 4 = 2</span>ØŒ
              <span class="badge-soft">CTAS 5 = 1</span>.
            </li>
            <li><b>Average Acuity</b> = Weighted Score Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§ØªØŒ ÙŠØ¹ÙƒØ³ Ù…ØªÙˆØ³Ù‘Ø· Ø­Ø¯Ù‘Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨.</li>
            <li>Ù…Ù„Ù Excel ÙÙŠÙ‡ Ø´ÙŠØª <b>Doctors_Count_Acuity</b> Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø±Ù‚Ù… ÙˆØ¸ÙŠÙÙŠØŒ Ø§Ø³Ù…ØŒ CTAS 1â€“5ØŒ AverageØŒ Weightedâ€¦).</li>
          </ul>
        </div>
      </details>

      <!-- NEW: Per Acuity â€” Age < 14 per Physician -->
      <!-- NEW: Per Acuity â€” Age < 14 per Physician -->
      <hr class="my-5 border-slate-700/70" />
      <h3 class="font-semibold text-cyan-200 text-sm mb-1">
        Per Acuity â€” Age &lt; 14 per Physician
      </h3>
      <p class="tiny mb-2">
        ÙŠØ¹Ø±Ø¶ Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø£Ù‚Ù„ Ù…Ù† 14 Ø³Ù†Ø© (Ø²ÙŠØ§Ø±Ø§Øª ÙØ±ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯)ØŒ Ø¨Ù†ÙØ³ Ø´ÙƒÙ„ ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ (Count &amp; Acuity).
      </p>
      <div class="table-wrap">
        <table class="w-full text-sm">
          <thead class="text-cyan-200">
            <tr class="border-b border-slate-700/80">
              <th class="p-2 text-right">#</th>
              <th class="p-2 text-right">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
              <th class="p-2 text-right">Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
              <th class="p-2 text-right">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©</th>
              <th class="p-2 text-right">CTAS 1</th>
              <th class="p-2 text-right">CTAS 2</th>
              <th class="p-2 text-right">CTAS 3</th>
              <th class="p-2 text-right">CTAS 4</th>
              <th class="p-2 text-right">CTAS 5</th>
              <th class="p-2 text-right">Average Acuity</th>
              <th class="p-2 text-right">Weighted Score</th>
            </tr>
          </thead>
          <tbody id="pedsAcuityBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Multi-Visits Table -->
    <section class="glass p-5">
      <div class="glass-title px-4 py-2 -mx-4 -mt-5 mb-4 rounded-t-[16px] flex items-center gap-2">
        <i class="fa-solid fa-repeat text-cyan-300"></i>
        <h2 class="font-semibold text-cyan-200">Multi-Visits â€” Ù†ÙØ³ MRN + Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</h2>
      </div>
      <p class="tiny mb-3">
        Ù„Ùˆ Ù†ÙØ³ Ø§Ù„Ù…Ø±ÙŠØ¶ (MRN) Ø¸Ù‡Ø± Ø£ÙƒØªØ± Ù…Ù† Ù…Ø±Ø© ÙÙŠ Ù†ÙØ³ <b>REGISTRATION DATE</b> â†’ ÙŠØªØ­Ø³Ø¨ ÙƒÙ€ <b>Group Multi-Visit</b>.
        Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¹Ø±Ø¶ Ø£Ø¹Ù„Ù‰ 200 Ù…Ø«Ø§Ù„ (Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Canceled).
      </p>
      <div class="table-wrap">
        <table class="w-full text-sm">
          <thead class="text-cyan-200">
            <tr class="border-b border-slate-700/80">
              <th class="p-2 text-right">MRN</th>
              <th class="p-2 text-right">REGISTRATION DATE</th>
              <th class="p-2 text-right">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</th>
              <th class="p-2 text-right">Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø£Ø­Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª)</th>
              <th class="p-2 text-right">Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
            </tr>
          </thead>
          <tbody id="multiVisitsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Ø¢Ø®Ø± 300 Ø²ÙŠØ§Ø±Ø© (Ù…Ø®ÙÙŠØ© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©) -->
    <section class="glass p-5 mb-4 hidden">
      <div class="glass-title px-4 py-2 -mx-4 -mt-5 mb-4 rounded-t-[16px] flex items-center gap-2">
        <i class="fa-solid fa-table-list text-cyan-300"></i>
        <h2 class="font-semibold text-cyan-200">Ø¢Ø®Ø± 300 Ø²ÙŠØ§Ø±Ø© ÙØ±ÙŠØ¯Ø© (Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©/Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯)</h2>
      </div>
      <div class="table-wrap">
        <table class="w-full text-sm">
          <thead class="text-cyan-200">
            <tr class="border-b border-slate-700/80">
              <th class="p-2 text-right">#</th>
              <th class="p-2 text-right">MRN</th>
              <th class="p-2 text-right">Ø§Ù„Ù…Ø±ÙŠØ¶</th>
              <th class="p-2 text-right">Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
              <th class="p-2 text-right">REG DATE</th>
              <th class="p-2 text-right">REG TIME</th>
              <th class="p-2 text-right">CTAS</th>
              <th class="p-2 text-right">Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
              <th class="p-2 text-right">Visits/Day</th>
            </tr>
          </thead>
          <tbody id="rowsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="mt-6 text-center tiny">
    ØªØµÙ…ÙŠÙ… Twilight Glass â€” <span class="text-cyan-300 font-semibold">MemoCare</span>
  </footer>

  <!-- SheetJS (XLSX) + FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <script>
  (() => {
    const COLS = {
      MRN: 'MRN',
      PATIENT: 'PATIENT NAME',
      DOCTOR: 'DOCTOR',
      REG_DATE: 'REGISTRATION DATE',
      REG_TIME: 'REGISTRATION TIME',
      CTAS: 'CTAS TYPE',
      DISH_TYPE: 'DISH. TYPE',
      FINAL_DX: 'FINAL DIAGNOSIS',
      DX_CODE: 'Diagnosis Code'
    };

    // Ø£ÙˆØ²Ø§Ù† CTAS Ù„Ù„Ù€ Acuity Score
    const CTAS_WEIGHT = { '1': 5, '2': 4, '3': 3, '4': 2, '5': 1, 'UNKNOWN': 0 };

    let rawRows = [];
    let cleanedRows = [];
    let uniqueVisits = [];
    let doctorProductivity = {};
    let doctorCtasMap = {};
    let ctasCounts = {};
    let doctors = [];
    let canceledCount = 0;
    let missingCTAS = 0;
    let missingFinalDx = 0;

    let visitCountMap = {};
    let multiVisitRows = [];
    let dxCounts = {};
    let shiftSet = new Set();
    let shiftCountPerDoctor = {};
    let regDowHourMatrix = Array.from({ length: 7 }, () => new Array(24).fill(0)); // day(0-6) Ã— hour(0-23)
    let doctorIdMap = {}; // Doctor Name -> Job Number / Code

    // Pediatric (Age < 14) per acuity per physician
    let doctorPedsCtasMap = {};
    let doctorPedsTotal = {};

    let hiddenDoctorRules = []; // ÙƒÙ„Ù…Ø§Øª Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„ØªØµÙ†ÙŠÙ

    let doctorBarChart = null;
    let ctasBarChart = null;
    let regHeatmapChart = null;

    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const resetBtn = document.getElementById('resetBtn');
    const doctorSelect = document.getElementById('doctorSelect');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    const exportChartsBtn = document.getElementById('exportChartsBtn');
    const hideNamesInput = document.getElementById('hideNamesInput');

    const kpiTotal = document.getElementById('kpiTotal');
    const kpiUnique = document.getElementById('kpiUnique');
    const kpiDupes = document.getElementById('kpiDupes');
    const kpiNoCtas = document.getElementById('kpiNoCtas');
    const kpiCanceled = document.getElementById('kpiCanceled');
    const kpiMultiGroups = document.getElementById('kpiMultiGroups');
    const kpiExtraVisits = document.getElementById('kpiExtraVisits');
    const kpiTopDx = document.getElementById('kpiTopDx');
    const kpiTopDxCount = document.getElementById('kpiTopDxCount');
    const kpiTopDoctor = document.getElementById('kpiTopDoctor');
    const kpiTopDoctorCount = document.getElementById('kpiTopDoctorCount');
    const kpiTotalShifts = document.getElementById('kpiTotalShifts');
    const kpiNoFinalDx = document.getElementById('kpiNoFinalDx');

    const rowsBody = document.getElementById('rowsBody');
    const rankBody = document.getElementById('rankBody');
    const multiVisitsBody = document.getElementById('multiVisitsBody');
    const pedsAcuityBody = document.getElementById('pedsAcuityBody');

    fileInput.addEventListener('change', handleFile, false);
    processBtn.addEventListener('click', processData);
    resetBtn.addEventListener('click', resetAll);
    doctorSelect.addEventListener('change', renderTable);
    exportExcelBtn.addEventListener('click', exportExcelAll);
    exportChartsBtn.addEventListener('click', exportChartImages);
    if (hideNamesInput) {
      hideNamesInput.addEventListener('input', updateHiddenDoctorRules);
    }

    function cleanStr(v) { return v == null ? '' : String(v).trim(); }

    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ÙŠØ­Ø§ÙˆÙ„ ÙŠØ¬ÙŠØ¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù…Ù† Ø£Ø¹Ù…Ø¯Ø© Ù…Ø­ØªÙ…Ù„Ø©
    function getDoctorId(row) {
      const directCandidates = [
        'DOCTOR ID', 'Doctor ID', 'DOCTOR CODE', 'Doctor Code',
        'DR CODE', 'Dr Code',
        'EMP ID', 'Emp ID', 'EMP NO', 'Emp No', 'EMP NUMBER', 'Employee ID'
      ];
      for (const col of directCandidates) {
        if (col in row) {
          const val = cleanStr(row[col]);
          if (val) return val;
        }
      }
      // Ø¨Ø­Ø« Ø¹Ø§Ù… ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      const keys = Object.keys(row);
      for (const k of keys) {
        const low = k.toLowerCase();
        if ((low.includes('doctor') || low.includes('dr')) &&
            (low.includes('code') || low.includes('id') || low.includes('no'))) {
          const val = cleanStr(row[k]);
          if (val) return val;
        }
      }
      return '';
    }

    function normalizeDate(value) {
      if (value == null || value === '') return '';
      if (typeof value === 'number') {
        const d = XLSX.SSF.parse_date_code(value);
        if (!d) return '';
        const date = new Date(Date.UTC(d.y, d.m - 1, d.d));
        return date.toISOString().slice(0, 10);
      }
      const s = String(value).trim();
      const tryDate = new Date(s);
      if (!isNaN(tryDate.getTime())) {
        return new Date(tryDate.getFullYear(), tryDate.getMonth(), tryDate.getDate())
          .toISOString().slice(0, 10);
      }
      const m = s.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
      if (m) {
        const y = +m[1], mo = +m[2] - 1, d = +m[3];
        const dt = new Date(y, mo, d);
        return dt.toISOString().slice(0, 10);
      }
      return s;
    }

    function parseCTAS(val) {
      const s = cleanStr(val);
      if (!s) return 'Unknown';
      const m = s.match(/([1-5])/);
      if (m) return m[1];
      return 'Unknown';
    }

    function parseHour(regTime) {
      const s = cleanStr(regTime);
      if (!s) return null;
      const m = s.match(/(\d{1,2})\s*:\s*(\d{1,2})/);
      if (!m) return null;
      let h = parseInt(m[1], 10);
      if (isNaN(h)) return null;
      if (h < 0) h = 0;
      if (h > 23) h = 23;
      return h;
    }

    function parseTimeToMinutes(regTime) {
      const s = cleanStr(regTime);
      if (!s) return null;
      const m = s.match(/(\d{1,2})\s*:\s*(\d{1,2})/);
      if (!m) return null;
      let h = parseInt(m[1], 10);
      let min = parseInt(m[2], 10);
      if (isNaN(h)) return null;
      if (isNaN(min)) min = 0;
      if (h < 0) h = 0;
      if (h > 23) h = 23;
      if (min < 0) min = 0;
      if (min > 59) min = 59;
      return h * 60 + min;
    }

    // ØªÙ‚Ø¯ÙŠØ± Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª (Ù„Ùˆ Ø£Ù‚Ù„ Ù…Ù† 14 Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ Pediatric table)
    const getAgeYears = (() => {
      let ageCol = null;
      let dobCol = null;

      function detectCols(row) {
        if (!row) return;
        const keys = Object.keys(row);

        if (!ageCol) {
          for (const k of keys) {
            const low = k.toLowerCase();
            if (low.includes('age') && !low.includes('triage')) {
              ageCol = k;
              break;
            }
          }
        }

        if (!dobCol) {
          for (const k of keys) {
            const low = k.toLowerCase();
            if (low.includes('date of birth') || low === 'dob' || low.includes('birth date')) {
              dobCol = k;
              break;
            }
          }
        }
      }

      function parseAgeVal(val) {
        if (val == null || val === '') return null;
        const s = String(val).toLowerCase().trim();
        const m = s.match(/(\d+(\.\d+)?)/);
        if (!m) return null;
        const num = parseFloat(m[1]);
        if (!isFinite(num)) return null;
        if (num < 0 || num > 150) return null;
        return num;
      }

      function calcAgeFromDob(dobVal, regDateStr) {
        if (!dobVal || !regDateStr) return null;
        const dob = new Date(dobVal);
        if (isNaN(dob.getTime())) return null;
        const ref = new Date(regDateStr + 'T00:00:00');
        if (isNaN(ref.getTime())) return null;
        let age = ref.getFullYear() - dob.getFullYear();
        const mDiff = ref.getMonth() - dob.getMonth();
        if (mDiff < 0 || (mDiff === 0 && ref.getDate() < dob.getDate())) age--;
        if (age < 0 || age > 150) return null;
        return age;
      }

      return function(row) {
        if (!row) return null;
        detectCols(row);

        if (ageCol && row.hasOwnProperty(ageCol)) {
          const age = parseAgeVal(row[ageCol]);
          if (age != null) return age;
        }

        if (dobCol && row.hasOwnProperty(dobCol)) {
          const regDateNorm = normalizeDate(row[COLS.REG_DATE]);
          return calcAgeFromDob(row[dobCol], regDateNorm);
        }

        return null;
      };
    })();

    function dxKey(row) {
      const a = cleanStr(row[COLS.FINAL_DX]);
      const b = cleanStr(row[COLS.DX_CODE]);
      const v = a || b;
      return v ? v.toLowerCase() : '';
    }

    function isCanceled(row) {
      const v = cleanStr(row[COLS.DISH_TYPE]).toLowerCase();
      return v.includes('cancel');
    }

    function handleFile(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        rawRows = XLSX.utils.sheet_to_json(sheet, { defval: '' });

        kpiTotal.textContent = rawRows.length.toLocaleString('en-US');
        processBtn.disabled = rawRows.length === 0;
        if (!rawRows.length) {
          alert('Ù„Ù… ÙŠØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø£ÙŠ ØµÙÙˆÙ Ù…Ù† Ø§Ù„Ø´ÙŠØª.');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function resetAll() {
      rawRows = [];
      cleanedRows = [];
      uniqueVisits = [];
      doctorProductivity = {};
      doctorCtasMap = {};
      ctasCounts = {};
      doctors = [];
      canceledCount = 0;
      missingCTAS = 0;
      missingFinalDx = 0;
      visitCountMap = {};
      multiVisitRows = [];
      dxCounts = {};
      shiftSet = new Set();
      shiftCountPerDoctor = {};
      regDowHourMatrix = Array.from({ length: 7 }, () => new Array(24).fill(0));
      doctorIdMap = {};
      doctorPedsCtasMap = {};
      doctorPedsTotal = {};
      hiddenDoctorRules = [];
      if (hideNamesInput) hideNamesInput.value = '';

      kpiTotal.textContent = '0';
      kpiUnique.textContent = '0';
      kpiDupes.textContent = '0';
      kpiNoCtas.textContent = '0';
      kpiCanceled.textContent = '0';
      kpiMultiGroups.textContent = '0';
      kpiExtraVisits.textContent = '0';
      kpiTopDx.textContent = 'â€”';
      kpiTopDxCount.textContent = '';
      kpiTopDoctor.textContent = 'â€”';
      kpiTopDoctorCount.textContent = '';
      kpiTotalShifts.textContent = '0';
      kpiNoFinalDx.textContent = '0';

      rowsBody.innerHTML = '';
      rankBody.innerHTML = '';
      multiVisitsBody.innerHTML = '';
      pedsAcuityBody.innerHTML = '';

      doctorSelect.innerHTML = '<option value="__ALL__">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</option>';
      fileInput.value = '';

      destroyCharts();

      processBtn.disabled = true;
      exportExcelBtn.disabled = true;
      exportChartsBtn.disabled = true;
    }

    function destroyCharts() {
      if (doctorBarChart) { doctorBarChart.destroy(); doctorBarChart = null; }
      if (ctasBarChart) { ctasBarChart.destroy(); ctasBarChart = null; }
      if (regHeatmapChart) { regHeatmapChart.destroy(); regHeatmapChart = null; }
    }

    function processData() {
      if (!rawRows.length) {
        alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }

      // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Canceled Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
      cleanedRows = [];
      canceledCount = 0;
      rawRows.forEach((r) => {
        if (isCanceled(r)) { canceledCount++; return; }
        cleanedRows.push(r);
      });

      // CTAS missing (Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Canceled)
      missingCTAS = 0;
      cleanedRows.forEach((row) => {
        const ctasRaw = cleanStr(row[COLS.CTAS]);
        if (!ctasRaw) missingCTAS++;
      });

      // Final Dx missing (Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Canceled)
      missingFinalDx = 0;
      cleanedRows.forEach((row) => {
        const dx = cleanStr(row[COLS.FINAL_DX]);
        const dxCode = cleanStr(row[COLS.DX_CODE]);
        if (!dx && !dxCode) missingFinalDx++;
      });

      // Ø¹Ø¯Ù‘ ÙƒÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ù„ÙƒÙ„ MRN+Date (Ø­ØªÙ‰ Ù„Ùˆ ØªÙƒØ±Ø±Øª ÙÙŠ Ø§Ù„ÙŠÙˆÙ…)
      visitCountMap = {};
      cleanedRows.forEach((row) => {
        const mrn = cleanStr(row[COLS.MRN]);
        const regDate = normalizeDate(row[COLS.REG_DATE]);
        if (!mrn || !regDate) return;
        const key = mrn + '|' + regDate;
        visitCountMap[key] = (visitCountMap[key] || 0) + 1;
      });

      // Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ ØµÙ Ù„ÙƒÙ„ MRN+Date Ù…Ø¹ ØªÙØ¶ÙŠÙ„ Ø§Ù„ØµÙ Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Doctor Ø«Ù… Ø§Ù„Ø£Ù‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø²Ù…Ù†
      const uvMap = new Map();
      cleanedRows.forEach((row) => {
        const mrn = cleanStr(row[COLS.MRN]);
        const regDateNorm = normalizeDate(row[COLS.REG_DATE]);
        const regTime = cleanStr(row[COLS.REG_TIME]);
        const doc = cleanStr(row[COLS.DOCTOR]);
        const docId = getDoctorId(row);
        const ctasRaw = cleanStr(row[COLS.CTAS]);
        const ctasCode = parseCTAS(ctasRaw);

        if (!mrn || !regDateNorm) return;
        const key = mrn + '|' + regDateNorm;

        const base = Object.assign({}, row, {
          __mrn: mrn,
          __regDate: regDateNorm,
          __regTime: regTime,
          __ctasCode: ctasCode,
          __doctorClean: doc,
          __doctorId: docId
        });

        const existing = uvMap.get(key);
        if (!existing) {
          uvMap.set(key, base);
        } else {
          const exDoc = existing.__doctorClean;
          const exTimeMin = parseTimeToMinutes(existing.__regTime);
          const newTimeMin = parseTimeToMinutes(regTime);

          if (!exDoc && doc) {
            uvMap.set(key, base);
          } else if (!!exDoc === !!doc) {
            if (newTimeMin != null && exTimeMin != null && newTimeMin < exTimeMin) {
              uvMap.set(key, base);
            } else if (exTimeMin == null && newTimeMin != null) {
              uvMap.set(key, base);
            }
          }
        }
      });

      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª
      uniqueVisits = [];
      doctorProductivity = {};
      doctorCtasMap = {};
      ctasCounts = { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0, 'Unknown': 0 };
      dxCounts = {};
      shiftSet = new Set();
      shiftCountPerDoctor = {};
      regDowHourMatrix = Array.from({ length: 7 }, () => new Array(24).fill(0));
      doctorIdMap = {};
      doctorPedsCtasMap = {};
      doctorPedsTotal = {};

      uvMap.forEach((u, key) => {
        const doc = u.__doctorClean || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const docId = u.__doctorId || '';
        if (doc && docId && !doctorIdMap[doc]) {
          doctorIdMap[doc] = docId;
        }

        const visitsSameDay = visitCountMap[key] || 1;
        u.__visitsSameDay = visitsSameDay;

        // ØªÙ‚Ø¯ÙŠØ± Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
        const ageYears = getAgeYears(u);
        u.__ageYears = ageYears;

        uniqueVisits.push(u);

        // Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ¨
        if (!doctorProductivity[doc]) doctorProductivity[doc] = 0;
        doctorProductivity[doc]++;

        // CTAS Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨
        if (!doctorCtasMap[doc]) {
          doctorCtasMap[doc] = { '1':0,'2':0,'3':0,'4':0,'5':0,'Unknown':0 };
        }
        const ctasCode = u.__ctasCode;
        const cKey = (ctasCode && doctorCtasMap[doc].hasOwnProperty(ctasCode)) ? ctasCode : 'Unknown';
        doctorCtasMap[doc][cKey]++;

        // Pediatric (Age < 14) per acuity
        if (ageYears != null && ageYears < 14) {
          if (!doctorPedsCtasMap[doc]) {
            doctorPedsCtasMap[doc] = { '1':0,'2':0,'3':0,'4':0,'5':0,'Unknown':0 };
          }
          const pMap = doctorPedsCtasMap[doc];
          const pKey = pMap.hasOwnProperty(ctasCode) ? ctasCode : 'Unknown';
          pMap[pKey] = (pMap[pKey] || 0) + 1;

          doctorPedsTotal[doc] = (doctorPedsTotal[doc] || 0) + 1;
        }

        // CTAS Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        if (!ctasCounts[cKey]) ctasCounts[cKey] = 0;
        ctasCounts[cKey]++;

        // Top Dx
        const dx = dxKey(u);
        if (dx) dxCounts[dx] = (dxCounts[dx] || 0) + 1;

        // Heatmap: Reg Date + Hour
        const h = parseHour(u.__regTime);
        if (h !== null && u.__regDate) {
          const d = new Date(u.__regDate + 'T00:00:00');
          const dow = d.getDay(); // 0=Sun..6=Sat
          if (dow >= 0 && dow <= 6) {
            regDowHourMatrix[dow][h] = (regDowHourMatrix[dow][h] || 0) + 1;
          }
        }

        // Ø§Ù„Ø´ÙŠÙØªØ§Øª: Doctor + Date
        const shiftKey = doc + '|' + u.__regDate;
        shiftSet.add(shiftKey);
      });

      // Ø¹Ø¯Ù‘ Ø§Ù„Ø´ÙŠÙØªØ§Øª Ù„ÙƒÙ„ Ø¯ÙƒØªÙˆØ±
      shiftSet.forEach((k) => {
        const parts = k.split('|');
        const doc = parts[0] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if (!shiftCountPerDoctor[doc]) shiftCountPerDoctor[doc] = 0;
        shiftCountPerDoctor[doc]++;
      });

      doctors = Object.keys(doctorProductivity).sort((a, b) => a.localeCompare(b, 'ar'));

      // KPIs
      kpiTotal.textContent = rawRows.length.toLocaleString('en-US');
      kpiCanceled.textContent = canceledCount.toLocaleString('en-US');
      kpiUnique.textContent = uniqueVisits.length.toLocaleString('en-US');
      const dupes = Math.max(cleanedRows.length - uniqueVisits.length, 0);
      kpiDupes.textContent = dupes.toLocaleString('en-US');
      kpiNoCtas.textContent = missingCTAS.toLocaleString('en-US');
      kpiNoFinalDx.textContent = missingFinalDx.toLocaleString('en-US');

      // Multi-visit stats
      multiVisitRows = [];
      let multiGroups = 0;
      let extraVisits = 0;
      uniqueVisits.forEach((u) => {
        const c = u.__visitsSameDay || 1;
        if (c > 1) {
          multiGroups++;
          extraVisits += (c - 1);
          multiVisitRows.push(u);
        }
      });
      kpiMultiGroups.textContent = multiGroups.toLocaleString('en-US');
      kpiExtraVisits.textContent = extraVisits.toLocaleString('en-US');

      // Top Dx
      let topDx = '';
      let topDxCount = 0;
      Object.entries(dxCounts).forEach(([dx, count]) => {
        if (count > topDxCount) {
          topDxCount = count;
          topDx = dx;
        }
      });
      kpiTopDx.textContent = topDx || 'â€”';
      kpiTopDxCount.textContent = topDx ? ('Ø§Ù„ØªÙƒØ±Ø§Ø±: ' + topDxCount) : '';

      // Top Doctor
      let topDoc = '';
      let topDocCount = 0;
      doctors.forEach((d) => {
        const c = doctorProductivity[d] || 0;
        if (c > topDocCount) {
          topDocCount = c;
          topDoc = d;
        }
      });
      kpiTopDoctor.textContent = topDoc || 'â€”';
      const topShifts = topDoc ? (shiftCountPerDoctor[topDoc] || 0) : 0;
      kpiTopDoctorCount.textContent = topDoc
        ? ('Ø­Ø§Ù„Ø§Øª ÙØ±ÙŠØ¯Ø©: ' + topDocCount + ' | Ø´ÙŠÙØªØ§Øª: ' + topShifts)
        : '';

      kpiTotalShifts.textContent = shiftSet.size.toLocaleString('en-US');

      // Doctor filter
      doctorSelect.innerHTML = '<option value="__ALL__">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</option>' +
        doctors.map(d => '<option value="' + escapeHtml(d) + '">' + escapeHtml(d) + '</option>').join('');

      renderCharts();
      renderHeatmap();
      renderRanking();
      renderPedsAcuity();
      renderTable();
      renderMultiVisitsTable();

      exportExcelBtn.disabled = uniqueVisits.length === 0;
      exportChartsBtn.disabled = doctors.length === 0;
    }

    function renderCharts() {
      if (doctorBarChart) { doctorBarChart.destroy(); doctorBarChart = null; }
      if (ctasBarChart) { ctasBarChart.destroy(); ctasBarChart = null; }

      if (!doctors.length) return;

      const labels = doctors.slice();
      const values = labels.map(d => doctorProductivity[d] || 0);

      const ctx1 = document.getElementById('doctorBar').getContext('2d');
      doctorBarChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Ø­Ø§Ù„Ø§Øª ÙØ±ÙŠØ¯Ø© Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨',
            data: values
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const idx = elements[0].index;
            const doc = labels[idx];
            doctorSelect.value = doc;
            renderTable();
          },
          scales: {
            x: {
              ticks: { color: '#c7d2fe' },
              grid: { color: 'rgba(148,163,184,0.15)' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#c7d2fe' },
              grid: { color: 'rgba(148,163,184,0.15)' }
            }
          }
        }
      });

      const order = ['1', '2', '3', '4', '5', 'Unknown'];
      const barLabelsRaw = order.filter(k => ctasCounts[k] > 0);
      const barVals = barLabelsRaw.map(k => ctasCounts[k]);
      const colorMap = {
        '1': '#3b82f6',   // Blue
        '2': '#ef4444',   // Red
        '3': '#facc15',   // Yellow
        '4': '#22c55e',   // Green
        '5': '#e5e7eb',   // White
        'Unknown': '#64748b'
      };

      const labels2 = barLabelsRaw.map(k => k === 'Unknown' ? 'Unknown / Missing' : 'CTAS ' + k);
      const ctx2 = document.getElementById('ctasBar').getContext('2d');
      ctasBarChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: labels2,
          datasets: [{
            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø­Ø³Ø¨ CTAS',
            data: barVals,
            backgroundColor: barLabelsRaw.map(k => colorMap[k] || '#64748b')
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: '#c7d2fe' },
              grid: { color: 'rgba(148,163,184,0.15)' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#c7d2fe' },
              grid: { color: 'rgba(148,163,184,0.15)' }
            }
          }
        }
      });
    }

    function renderHeatmap() {
      if (regHeatmapChart) { regHeatmapChart.destroy(); regHeatmapChart = null; }

      const heatCtx = document.getElementById('regHeatmap').getContext('2d');
      const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      const data = [];
      let maxVal = 0;
      for (let d = 0; d < 7; d++) {
        for (let h = 0; h < 24; h++) {
          const v = regDowHourMatrix[d][h] || 0;
          if (v > maxVal) maxVal = v;
          data.push({ x: h, y: d, v });
        }
      }
      if (maxVal === 0) maxVal = 1;

      regHeatmapChart = new Chart(heatCtx, {
        type: 'matrix',
        data: {
          datasets: [{
            label: 'Registrations',
            data,
            borderWidth: 1,
            borderColor: 'rgba(148,163,184,0.4)',
            backgroundColor: (ctx) => {
              const cell = ctx.dataset.data[ctx.dataIndex];
              const v = cell.v;
              if (!v) return 'rgba(15,23,42,0.35)'; // Ø®Ù„ÙŠØ© ÙØ§Ø¶ÙŠØ©

              const t = Math.max(0, Math.min(1, v / maxVal)); // 0â†’1
              // Ù…Ù† Ø£ØµÙØ± (#facc15) Ù„Ø£Ø­Ù…Ø± (#ef4444)
              const yR = 250, yG = 204, yB = 21;
              const rR = 239, rG = 68,  rB = 68;
              const r = Math.round(yR + (rR - yR) * t);
              const g = Math.round(yG + (rG - yG) * t);
              const b = Math.round(yB + (rB - yB) * t);
              const alpha = 0.3 + 0.7 * t;
              return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
            },
            width: (ctx) => {
              const a = ctx.chart.chartArea;
              return a ? (a.width / 24) - 2 : 0;
            },
            height: (ctx) => {
              const a = ctx.chart.chartArea;
              return a ? (a.height / 7) - 2 : 0;
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => {
                  if (!items.length) return '';
                  const raw = items[0].raw;
                  const h = raw.x;
                  const d = raw.y;
                  return dayLabels[d] + ' â€” ' + String(h).padStart(2, '0') + ':00';
                },
                label: (ctx) => {
                  const v = ctx.raw.v;
                  return 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª: ' + v;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              position: 'bottom',
              min: -0.5,
              max: 23.5,
              ticks: {
                stepSize: 1,
                color: '#c7d2fe',
                callback: (value) => String(value).padStart(2, '0') + ':00'
              },
              grid: { color: 'rgba(148,163,184,0.15)' }
            },
            y: {
              type: 'linear',
              reverse: true,
              min: -0.5,
              max: 6.5,
              ticks: {
                stepSize: 1,
                color: '#c7d2fe',
                callback: (value) => dayLabels[value] || ''
              },
              grid: { color: 'rgba(148,163,184,0.15)' }
            }
          }
        }
      });
    }

    function shouldHideDoctor(doc) {
      const name = (doc || '').toLowerCase();
      if (!name || !hiddenDoctorRules.length) return false;
      return hiddenDoctorRules.some(rule => name.includes(rule));
    }

    function updateHiddenDoctorRules() {
      const value = hideNamesInput ? hideNamesInput.value : '';
      hiddenDoctorRules = value
        .split(',')
        .map(s => s.trim().toLowerCase())
        .filter(Boolean);
      renderRanking();
      renderPedsAcuity();
    }

    function renderRanking() {
      rankBody.innerHTML = '';
      if (!doctors.length) return;

      const visibleDocs = doctors.filter(d => !shouldHideDoctor(d));
      if (!visibleDocs.length) return;

      const items = visibleDocs.map((doc) => {
        const count = doctorProductivity[doc] || 0;
        const ctasMap = doctorCtasMap[doc] || { '1':0,'2':0,'3':0,'4':0,'5':0,'Unknown':0 };

        const c1 = ctasMap['1'] || 0;
        const c2 = ctasMap['2'] || 0;
        const c3 = ctasMap['3'] || 0;
        const c4 = ctasMap['4'] || 0;
        const c5 = ctasMap['5'] || 0;
        const cu = ctasMap['Unknown'] || 0; // Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¥ÙƒØ³Ù„

        let weighted = 0;
        weighted += (CTAS_WEIGHT['1'] || 0) * c1;
        weighted += (CTAS_WEIGHT['2'] || 0) * c2;
        weighted += (CTAS_WEIGHT['3'] || 0) * c3;
        weighted += (CTAS_WEIGHT['4'] || 0) * c4;
        weighted += (CTAS_WEIGHT['5'] || 0) * c5;

        const avg = count ? (weighted / count) : 0;
        const shifts = shiftCountPerDoctor[doc] || 0;
        const docId = doctorIdMap[doc] || '';

        return {
          doc,
          docId,
          count,
          c1,
          c2,
          c3,
          c4,
          c5,
          cu,
          weighted,
          avg,
          shifts
        };
      });

      items.sort((a, b) => (b.count - a.count) || (b.weighted - a.weighted));

      const frag = document.createDocumentFragment();
      let rank = 1;
      items.forEach((it) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-700/60 hover:bg-white/5';
        tr.innerHTML = `
          <td class="p-2">${rank++}</td>
          <td class="p-2">${escapeHtml(it.docId)}</td>
          <td class="p-2">${escapeHtml(it.doc)}</td>
          <td class="p-2">${it.count}</td>
          <td class="p-2"><span class="ctas-badge ctas-1">${it.c1}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-2">${it.c2}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-3">${it.c3}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-4">${it.c4}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-5">${it.c5}</span></td>
          <td class="p-2">${it.avg.toFixed(2)}</td>
          <td class="p-2">${it.weighted.toFixed(1)}</td>
          <td class="p-2">${it.shifts}</td>
        `;
        frag.appendChild(tr);
      });
      rankBody.appendChild(frag);
    }

    function renderPedsAcuity() {
      pedsAcuityBody.innerHTML = '';
      if (!doctors.length) return;

      const visibleDocs = doctors.filter(d => !shouldHideDoctor(d));
      const items = [];

      visibleDocs.forEach((doc) => {
        const total = doctorPedsTotal[doc] || 0;
        if (!total) return; // Ù…ÙÙŠØ´ Ø£Ø·ÙØ§Ù„ Ù„Ù„Ø·Ø¨ÙŠØ¨ Ø¯Ù‡

        const map = doctorPedsCtasMap[doc] || { '1':0,'2':0,'3':0,'4':0,'5':0,'Unknown':0 };
        const c1 = map['1'] || 0;
        const c2 = map['2'] || 0;
        const c3 = map['3'] || 0;
        const c4 = map['4'] || 0;
        const c5 = map['5'] || 0;

        let weighted = 0;
        weighted += (CTAS_WEIGHT['1'] || 0) * c1;
        weighted += (CTAS_WEIGHT['2'] || 0) * c2;
        weighted += (CTAS_WEIGHT['3'] || 0) * c3;
        weighted += (CTAS_WEIGHT['4'] || 0) * c4;
        weighted += (CTAS_WEIGHT['5'] || 0) * c5;

        const avg = total ? (weighted / total) : 0;
        const docId = doctorIdMap[doc] || '';

        items.push({
          doc,
          docId,
          total,
          c1,
          c2,
          c3,
          c4,
          c5,
          avg,
          weighted
        });
      });

      if (!items.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 tiny text-slate-400" colspan="11">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ù…Ø± Ø£Ù‚Ù„ Ù…Ù† 14 Ø³Ù†Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¹Ù…Ø±/DOB ÙÙŠ Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø­Ø§Ù„ÙŠ.
          </td>
        `;
        pedsAcuityBody.appendChild(tr);
        return;
      }

      // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±ØªÙŠØ¨: Ø­Ø³Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø«Ù… Ø§Ù„Ù€ Weighted
      items.sort((a, b) => (b.total - a.total) || (b.weighted - a.weighted));

      const frag = document.createDocumentFragment();
      let rank = 1;
      items.forEach((it) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-700/60 hover:bg-white/5';
        tr.innerHTML = `
          <td class="p-2">${rank++}</td>
          <td class="p-2">${escapeHtml(it.docId)}</td>
          <td class="p-2">${escapeHtml(it.doc)}</td>
          <td class="p-2 font-semibold">${it.total}</td>
          <td class="p-2"><span class="ctas-badge ctas-1">${it.c1}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-2">${it.c2}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-3">${it.c3}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-4">${it.c4}</span></td>
          <td class="p-2"><span class="ctas-badge ctas-5">${it.c5}</span></td>
          <td class="p-2">${it.avg.toFixed(2)}</td>
          <td class="p-2">${it.weighted.toFixed(1)}</td>
        `;
        frag.appendChild(tr);
      });
      pedsAcuityBody.appendChild(frag);
    }

    function renderTable() {
      rowsBody.innerHTML = '';
      if (!uniqueVisits.length) return;

      const selectedDoc = doctorSelect.value || '__ALL__';

      let rows = uniqueVisits;
      if (selectedDoc !== '__ALL__') {
        rows = uniqueVisits.filter(r => (cleanStr(r[COLS.DOCTOR]) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') === selectedDoc);
      }

      const sorted = rows.slice().sort((a, b) => {
        const da = a.__regDate || '';
        const db = b.__regDate || '';
        if (da === db) {
          return (b.__regTime || '').localeCompare(a.__regTime || '');
        }
        return db.localeCompare(da);
      }).slice(0, 300);

      const frag = document.createDocumentFragment();
      let idx = 1;
      sorted.forEach((r) => {
        const dx = cleanStr(r[COLS.FINAL_DX]) || cleanStr(r[COLS.DX_CODE]) || '';
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-700/60 hover:bg-white/5';
        tr.innerHTML = `
          <td class="p-2">${idx++}</td>
          <td class="p-2">${escapeHtml(r.__mrn)}</td>
          <td class="p-2">${escapeHtml(r[COLS.PATIENT])}</td>
          <td class="p-2">${escapeHtml(r[COLS.DOCTOR])}</td>
          <td class="p-2">${escapeHtml(r.__regDate)}</td>
          <td class="p-2">${escapeHtml(r.__regTime)}</td>
          <td class="p-2">${escapeHtml(r.__ctasCode === 'Unknown' ? 'â€”' : r.__ctasCode)}</td>
          <td class="p-2">${escapeHtml(dx)}</td>
          <td class="p-2">${escapeHtml(r.__visitsSameDay || 1)}</td>
        `;
        frag.appendChild(tr);
      });
      rowsBody.appendChild(frag);
    }

    function renderMultiVisitsTable() {
      multiVisitsBody.innerHTML = '';
      if (!multiVisitRows.length) return;
      const sorted = multiVisitRows.slice()
        .sort((a, b) => (b.__visitsSameDay || 1) - (a.__visitsSameDay || 1))
        .slice(0, 200);

      const frag = document.createDocumentFragment();
      sorted.forEach((r) => {
        const dx = cleanStr(r[COLS.FINAL_DX]) || cleanStr(r[COLS.DX_CODE]) || '';
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-700/60 hover:bg-white/5';
        tr.innerHTML = `
          <td class="p-2">${escapeHtml(r.__mrn)}</td>
          <td class="p-2">${escapeHtml(r.__regDate)}</td>
          <td class="p-2 font-bold">${escapeHtml(r.__visitsSameDay || 1)}</td>
          <td class="p-2">${escapeHtml(r[COLS.DOCTOR])}</td>
          <td class="p-2">${escapeHtml(dx)}</td>
        `;
        frag.appendChild(tr);
      });
      multiVisitsBody.appendChild(frag);
    }

    function exportExcelAll() {
      if (!uniqueVisits.length) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.');
        return;
      }

      const wb = XLSX.utils.book_new();

      // Ø´ÙŠØª ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ (Count & Acuity) Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
      const perDoctorHeader = [
        'Doctor ID',
        'Doctor Name',
        'Unique Cases',
        'CTAS 1',
        'CTAS 2',
        'CTAS 3',
        'CTAS 4',
        'CTAS 5',
        'Average Acuity',
        'Weighted Score',
        'Shifts',
        'Cases per Shift',
        'Unknown / Missing'
      ];

      const visibleDocs = doctors.filter(d => !shouldHideDoctor(d));

      const perDoctorRows = visibleDocs.map((doc) => {
        const count = doctorProductivity[doc] || 0;
        const ctasMap = doctorCtasMap[doc] || { '1':0,'2':0,'3':0,'4':0,'5':0,'Unknown':0 };
        const c1 = ctasMap['1'] || 0;
        const c2 = ctasMap['2'] || 0;
        const c3 = ctasMap['3'] || 0;
        const c4 = ctasMap['4'] || 0;
        const c5 = ctasMap['5'] || 0;
        const cu = ctasMap['Unknown'] || 0;

        let weighted = 0;
        weighted += (CTAS_WEIGHT['1'] || 0) * c1;
        weighted += (CTAS_WEIGHT['2'] || 0) * c2;
        weighted += (CTAS_WEIGHT['3'] || 0) * c3;
        weighted += (CTAS_WEIGHT['4'] || 0) * c4;
        weighted += (CTAS_WEIGHT['5'] || 0) * c5;

        const avg = count ? (weighted / count) : 0;
        const shifts = shiftCountPerDoctor[doc] || 0;
        const cps = shifts ? (count / shifts) : 0;
        const docId = doctorIdMap[doc] || '';

        return [
          docId,
          doc,
          count,
          c1,
          c2,
          c3,
          c4,
          c5,
          avg,
          weighted,
          shifts,
          cps,
          cu
        ];
      });

      const perDoctorSheet = XLSX.utils.aoa_to_sheet([perDoctorHeader, ...perDoctorRows]);
      XLSX.utils.book_append_sheet(wb, perDoctorSheet, 'Doctors_Count_Acuity');

      // Ø´ÙŠØª ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© ÙØ±ÙŠØ¯Ø©
      const detailsHeader = ['MRN','Patient','Doctor','Reg Date','Reg Time','CTAS','VisitsSameDay','Final Dx','Dx Code'];
      const detailsRows = uniqueVisits.map((r) => ([
        r.__mrn,
        cleanStr(r[COLS.PATIENT]),
        cleanStr(r[COLS.DOCTOR]),
        r.__regDate,
        r.__regTime,
        r.__ctasCode,
        r.__visitsSameDay || 1,
        cleanStr(r[COLS.FINAL_DX]),
        cleanStr(r[COLS.DX_CODE])
      ]));
      const detailsSheet = XLSX.utils.aoa_to_sheet([detailsHeader, ...detailsRows]);
      XLSX.utils.book_append_sheet(wb, detailsSheet, 'Details');

      // Ø´ÙŠØª Summary Ø³Ø±ÙŠØ¹
      const extraVisits = multiVisitRows.reduce((s, r) => s + ((r.__visitsSameDay || 1) - 1), 0);
      const summary = [
        ['Metric', 'Value'],
        ['Raw Total', rawRows.length],
        ['Canceled (excluded)', canceledCount],
        ['Cleaned (Raw - Canceled)', cleanedRows.length],
        ['Unique Visits', uniqueVisits.length],
        ['Duplicates (within cleaned)', Math.max(cleanedRows.length - uniqueVisits.length, 0)],
        ['No CTAS (within cleaned)', missingCTAS],
        ['No Final Dx (within cleaned)', missingFinalDx],
        ['Multi-Visit Groups (MRN+Date)', multiVisitRows.length],
        ['Extra Visits (same day)', extraVisits],
        ['Total Shifts (Doctor+Date)', shiftSet.size]
      ];
      const summarySheet = XLSX.utils.aoa_to_sheet(summary);
      XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');

      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      saveAs(new Blob([wbout], { type: "application/octet-stream" }), fileStamp('ER_Productivity_Doctors'));
    }

    function fileStamp(prefix) {
      const stamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
      return prefix + '_' + stamp + '.xlsx';
    }

    function exportChartImages() {
      if (!doctorBarChart && !ctasBarChart && !regHeatmapChart) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø§Ø±ØªØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.');
        return;
      }
      if (doctorBarChart) downloadDataUrl(doctorBarChart.toBase64Image(), 'Doctor_Productivity.png');
      if (ctasBarChart) downloadDataUrl(ctasBarChart.toBase64Image(), 'CTAS_Distribution.png');
      if (regHeatmapChart) downloadDataUrl(regHeatmapChart.toBase64Image(), 'Registration_Heatmap_Day_Hour.png');
    }

    function downloadDataUrl(dataUrl, filename) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      a.click();
    }
  })();
  </script>
</body>
</html>
